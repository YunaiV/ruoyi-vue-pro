<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>MQTT WebSocket æµ‹è¯•å®¢æˆ·ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: monospace;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
        }

        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.info {
            color: #4ec9b0;
        }

        .log-entry.success {
            color: #6a9955;
        }

        .log-entry.error {
            color: #f48771;
        }

        .log-entry.warning {
            color: #dcdcaa;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-item .label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸš€ MQTT WebSocket æµ‹è¯•å®¢æˆ·ç«¯</h1>
        <p>RuoYi-Vue-Pro IoT æ¨¡å— - MQTT over WebSocket åœ¨çº¿æµ‹è¯•å·¥å…·</p>
    </div>

    <!-- åè®®æ ¼å¼è¯´æ˜ -->
    <div class="info-box">
        <h3>ğŸ“Œ æ ‡å‡†åè®®æ ¼å¼è¯´æ˜</h3>
        <ul>
            <li><strong>Topic æ ¼å¼ï¼š</strong><code>/sys/{productKey}/{deviceName}/thing/property/post</code></li>
            <li><strong>Client ID æ ¼å¼ï¼š</strong><code>{productKey}.{deviceName}</code> ä¾‹å¦‚ï¼š<code>zOXKLvHjUqTo7ipD.ceshi001</code>
            </li>
            <li><strong>Username æ ¼å¼ï¼š</strong><code>{deviceName}&{productKey}</code> ä¾‹å¦‚ï¼š<code>ceshi001&zOXKLvHjUqTo7ipD</code>
            </li>
            <li><strong>æ¶ˆæ¯æ ¼å¼ï¼ˆAlink åè®®ï¼‰ï¼š</strong>
                <pre style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 5px; overflow-x: auto;">
{
  "id": "æ¶ˆæ¯ IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰",
  "version": "1.0",
  "method": "thing.property.post",
  "params": {
    "temperature": 25.5,
    "humidity": 60
  }
}</pre>
            </li>
            <li><strong>å¸¸ç”¨ Topicï¼ˆä¸‹è¡Œ - æœåŠ¡ç«¯æ¨é€ï¼‰ï¼š</strong>
                <ul style="margin-top: 5px;">
                    <li>å±æ€§è®¾ç½®ï¼š<code>/sys/{pk}/{dn}/thing/property/set</code></li>
                    <li>æœåŠ¡è°ƒç”¨ï¼š<code>/sys/{pk}/{dn}/thing/service/invoke</code></li>
                    <li>é…ç½®æ¨é€ï¼š<code>/sys/{pk}/{dn}/thing/config/push</code></li>
                    <li>OTA å‡çº§ï¼š<code>/sys/{pk}/{dn}/thing/ota/upgrade</code></li>
                </ul>
            </li>
            <li><strong>å¸¸ç”¨ Topicï¼ˆä¸Šè¡Œ - è®¾å¤‡ä¸ŠæŠ¥ï¼‰ï¼š</strong>
                <ul style="margin-top: 5px;">
                    <li>çŠ¶æ€æ›´æ–°ï¼š<code>/sys/{pk}/{dn}/thing/state/update</code></li>
                    <li>å±æ€§ä¸ŠæŠ¥ï¼š<code>/sys/{pk}/{dn}/thing/property/post</code></li>
                    <li>äº‹ä»¶ä¸ŠæŠ¥ï¼š<code>/sys/{pk}/{dn}/thing/event/post</code></li>
                    <li>OTA è¿›åº¦ï¼š<code>/sys/{pk}/{dn}/thing/ota/progress</code></li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="content">
        <!-- è¿æ¥é…ç½®é¢æ¿ -->
        <div class="panel">
            <h2>ğŸ“¡ è¿æ¥é…ç½®</h2>

            <div class="status disconnected" id="statusBar">
                âš« æœªè¿æ¥
            </div>

            <div class="form-group">
                <label>æœåŠ¡å™¨åœ°å€</label>
                <input id="serverUrl" placeholder="ws://host:port/path" type="text" value="ws://localhost:8083/mqtt">
                <small style="color: #666; font-size: 12px;">WebSocket åœ°å€ï¼Œæ”¯æŒ ws:// å’Œ wss://</small>
            </div>

            <div class="form-group">
                <label>Client ID</label>
                <input id="clientId" placeholder="è®¾å¤‡å®¢æˆ·ç«¯ ID" type="text" value="fqTn4Afs982Nak4N.jiali001">
                <small style="color: #666; font-size: 12px;">æ ¼å¼ï¼š{productKey}.{deviceName}</small>
            </div>

            <div class="form-group">
                <label>Username</label>
                <input id="username" placeholder="ç”¨æˆ·å" type="text" value="jiali001&fqTn4Afs982Nak4N">
                <small style="color: #666; font-size: 12px;">æ ¼å¼ï¼š{deviceName}&{productKey}</small>
            </div>

            <div class="form-group">
                <label>Password</label>
                <input id="password" placeholder="è®¾å¤‡å¯†é’¥"
                       type="password" value="ae10188f93febbb6b37bd57f463b2a795ae2800fab8933aef75d3c6422873f28">
                <small style="color: #666; font-size: 12px;">è®¾å¤‡çš„è®¤è¯å¯†é’¥ï¼ˆDevice Secretï¼‰</small>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" id="connectBtn" onclick="connect()">ğŸ”Œ è¿æ¥</button>
                <button class="btn btn-danger" disabled id="disconnectBtn" onclick="disconnect()">ğŸ”Œ æ–­å¼€</button>
                <button class="btn btn-warning" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats">
                <div class="stat-item">
                    <div class="value" id="sentCount">0</div>
                    <div class="label">å‘é€æ¶ˆæ¯æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="receivedCount">0</div>
                    <div class="label">æ¥æ”¶æ¶ˆæ¯æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="errorCount">0</div>
                    <div class="label">é”™è¯¯æ¬¡æ•°</div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯å‘å¸ƒé¢æ¿ -->
        <div class="panel">
            <h2>ğŸ“¤ æ¶ˆæ¯å‘å¸ƒ</h2>

            <div class="form-group">
                <label>å¿«æ·ä¸»é¢˜é€‰æ‹©ï¼ˆä¸Šè¡Œæ¶ˆæ¯ - è®¾å¤‡ â†’ æœåŠ¡ç«¯ï¼‰</label>
                <select id="quickPublishTopicSelect" onchange="selectQuickPublishTopic()"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">-- é€‰æ‹©ä¸Šè¡Œæ¶ˆæ¯ç±»å‹ --</option>
                    <option value="thing.state.update">è®¾å¤‡çŠ¶æ€æ›´æ–° (thing.state.update)</option>
                    <option value="thing.property.post">å±æ€§ä¸ŠæŠ¥ (thing.property.post)</option>
                    <option value="thing.event.post">äº‹ä»¶ä¸ŠæŠ¥ (thing.event.post)</option>
                    <option value="thing.ota.progress">OTA å‡çº§è¿›åº¦ (thing.ota.progress)</option>
                </select>
            </div>

            <div class="form-group">
                <label>ä¸»é¢˜ (Topic)</label>
                <input id="pubTopic" placeholder="æ¶ˆæ¯ä¸»é¢˜ï¼Œæ ¼å¼ï¼š/sys/{productKey}/{deviceName}/thing/property/post" type="text"
                       value="/sys/fqTn4Afs982Nak4N/jiali001/thing/property/post">
                <small style="color: #666; font-size: 12px;">æ ‡å‡†æ ¼å¼ï¼š/sys/{productKey}/{deviceName}/thing/property/post</small>
            </div>

            <div class="form-group">
                <label>QoS çº§åˆ«</label>
                <select id="pubQos">
                    <option value="0">0 - æœ€å¤šä¸€æ¬¡</option>
                    <option selected value="1">1 - è‡³å°‘ä¸€æ¬¡</option>
                    <option value="2">2 - åˆšå¥½ä¸€æ¬¡</option>
                </select>
            </div>

            <div class="form-group">
                <label>æ¶ˆæ¯å†…å®¹ (JSON - Alink åè®®æ ¼å¼)</label>
                <textarea id="pubMessage" placeholder='Alink åè®®æ ¼å¼æ¶ˆæ¯'>{
  "id": "123456789",
  "version": "1.0",
  "method": "thing.property.post",
  "params": {
    "temperature": 25.5,
    "humidity": 60
  }
}</textarea>
                <small style="color: #666; font-size: 12px;">
                    Alink åè®®æ ¼å¼ï¼šidï¼ˆæ¶ˆæ¯ IDï¼‰ã€versionï¼ˆåè®®ç‰ˆæœ¬ï¼‰ã€methodï¼ˆæ–¹æ³•ï¼‰ã€paramsï¼ˆå‚æ•°ï¼‰
                </small>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="publish()">ğŸ“¤ å‘å¸ƒæ¶ˆæ¯</button>
                <button class="btn btn-success" onclick="publishSampleData()">ğŸ“Š å‘é€æ ·ä¾‹æ•°æ®</button>
            </div>

            <h2 style="margin-top: 30px;">ğŸ“¥ ä¸»é¢˜è®¢é˜…</h2>

            <div class="form-group">
                <label>å¿«æ·ä¸»é¢˜é€‰æ‹©ï¼ˆä¸‹è¡Œæ¶ˆæ¯ - æœåŠ¡ç«¯ â†’ è®¾å¤‡ï¼‰</label>
                <select id="quickTopicSelect" onchange="selectQuickTopic()"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">-- é€‰æ‹©ä¸‹è¡Œæ¶ˆæ¯ç±»å‹ --</option>
                    <optgroup label="ğŸ“¥ ä¸‹è¡Œæ¶ˆæ¯">
                        <option value="thing.property.set">å±æ€§è®¾ç½® (thing.property.set)</option>
                        <option value="thing.service.invoke">æœåŠ¡è°ƒç”¨ (thing.service.invoke)</option>
                        <option value="thing.config.push">é…ç½®æ¨é€ (thing.config.push)</option>
                        <option value="thing.ota.upgrade">OTA å›ºä»¶æ¨é€ (thing.ota.upgrade)</option>
                    </optgroup>
                    <optgroup label="ğŸ”„ å›å¤ä¸»é¢˜ï¼ˆä¸Šè¡Œæ¶ˆæ¯çš„å›å¤ï¼‰">
                        <option value="thing.property.post_reply">å±æ€§ä¸ŠæŠ¥å›å¤ (thing.property.post_reply)</option>
                        <option value="thing.event.post_reply">äº‹ä»¶ä¸ŠæŠ¥å›å¤ (thing.event.post_reply)</option>
                    </optgroup>
                    <optgroup label="ğŸ”§ é€šé…ç¬¦è®¢é˜…">
                        <option value="wildcard_all">è®¢é˜…æ‰€æœ‰ä¸»é¢˜ (/sys/+/+/#)</option>
                        <option value="wildcard_thing">è®¢é˜…æ‰€æœ‰ thing ä¸»é¢˜ (/sys/+/+/thing/#)</option>
                        <option value="wildcard_reply">è®¢é˜…æ‰€æœ‰å›å¤ä¸»é¢˜ (/sys/+/+/#_reply)</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label>è®¢é˜…ä¸»é¢˜</label>
                <input id="subTopic" placeholder="è®¢é˜…ä¸»é¢˜ï¼Œæ ¼å¼ï¼š/sys/{productKey}/{deviceName}/thing/property/set" type="text"
                       value="/sys/fqTn4Afs982Nak4N/jiali001/thing/property/set">
                <small style="color: #666; font-size: 12px;">æ ‡å‡†æ ¼å¼ï¼š/sys/{productKey}/{deviceName}/thing/method æˆ–ä½¿ç”¨é€šé…ç¬¦
                    /sys/+/+/#</small>
            </div>

            <div class="form-group">
                <label>QoS çº§åˆ«</label>
                <select id="subQos">
                    <option value="0">0 - æœ€å¤šä¸€æ¬¡</option>
                    <option selected value="1">1 - è‡³å°‘ä¸€æ¬¡</option>
                    <option value="2">2 - åˆšå¥½ä¸€æ¬¡</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="subscribe()">ğŸ“¥ è®¢é˜…</button>
                <button class="btn btn-danger" onclick="unsubscribe()">âŒ å–æ¶ˆè®¢é˜…</button>
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="panel" style="grid-column: 1 / -1;">
            <h2>ğŸ“ æ—¥å¿—è¾“å‡º</h2>
            <div class="log-area" id="logArea"></div>
        </div>
    </div>
</div>

<!-- ä½¿ç”¨ MQTT.js åº“ -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
    let client = null;
    let sentCount = 0;
    let receivedCount = 0;
    let errorCount = 0;

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
        const logArea = document.getElementById('logArea');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        logArea.appendChild(logEntry);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // æ›´æ–°çŠ¶æ€æ 
    function updateStatus(status, text) {
        const statusBar = document.getElementById('statusBar');
        statusBar.className = `status ${status}`;

        const icons = {
            'disconnected': 'âš«',
            'connecting': 'ğŸŸ¡',
            'connected': 'ğŸŸ¢'
        };

        statusBar.textContent = `${icons[status]} ${text}`;
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
        document.getElementById('sentCount').textContent = sentCount;
        document.getElementById('receivedCount').textContent = receivedCount;
        document.getElementById('errorCount').textContent = errorCount;
    }

    // è¿æ¥åˆ°æœåŠ¡å™¨
    function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        const clientId = document.getElementById('clientId').value;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (!serverUrl || !clientId) {
            addLog('âŒ è¯·å¡«å†™æœåŠ¡å™¨åœ°å€å’Œ Client ID', 'error');
            errorCount++;
            updateStats();
            return;
        }

        updateStatus('connecting', 'æ­£åœ¨è¿æ¥...');
        addLog(`ğŸ”„ æ­£åœ¨è¿æ¥åˆ° ${serverUrl}...`, 'info');

        const options = {
            clientId: clientId,
            username: username,
            password: password,
            clean: true,
            reconnectPeriod: 5000,
            connectTimeout: 30000,
        };

        client = mqtt.connect(serverUrl, options);

        // è¿æ¥æˆåŠŸ
        client.on('connect', () => {
            updateStatus('connected', 'å·²è¿æ¥');
            addLog('âœ… è¿æ¥æˆåŠŸï¼', 'success');
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
        });

        // æ¥æ”¶æ¶ˆæ¯
        client.on('message', (topic, message) => {
            receivedCount++;
            updateStats();
            addLog(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯ [${topic}]: ${message.toString()}`, 'success');
        });

        // è¿æ¥é”™è¯¯
        client.on('error', (error) => {
            errorCount++;
            updateStats();
            addLog(`âŒ è¿æ¥é”™è¯¯: ${error.message}`, 'error');
        });

        // æ–­å¼€è¿æ¥
        client.on('close', () => {
            updateStatus('disconnected', 'æœªè¿æ¥');
            addLog('ğŸ”Œ è¿æ¥å·²æ–­å¼€', 'warning');
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
        });

        // ç¦»çº¿
        client.on('offline', () => {
            updateStatus('disconnected', 'ç¦»çº¿');
            addLog('âš ï¸ å®¢æˆ·ç«¯ç¦»çº¿', 'warning');
        });

        // é‡è¿
        client.on('reconnect', () => {
            updateStatus('connecting', 'æ­£åœ¨é‡è¿...');
            addLog('ğŸ”„ æ­£åœ¨é‡è¿...', 'info');
        });
    }

    // æ–­å¼€è¿æ¥
    function disconnect() {
        if (client) {
            client.end();
            addLog('ğŸ‘‹ ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info');
        }
    }

    // å‘å¸ƒæ¶ˆæ¯
    function publish() {
        if (!client || !client.connected) {
            addLog('âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            errorCount++;
            updateStats();
            return;
        }

        const topic = document.getElementById('pubTopic').value;
        const qos = parseInt(document.getElementById('pubQos').value);
        const message = document.getElementById('pubMessage').value;

        if (!topic || !message) {
            addLog('âŒ è¯·å¡«å†™ä¸»é¢˜å’Œæ¶ˆæ¯å†…å®¹', 'error');
            errorCount++;
            updateStats();
            return;
        }

        // éªŒè¯ JSON æ ¼å¼
        try {
            JSON.parse(message);
        } catch (e) {
            addLog('âš ï¸ æ¶ˆæ¯ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œå°†ä½œä¸ºçº¯æ–‡æœ¬å‘é€', 'warning');
        }

        client.publish(topic, message, {qos: qos}, (error) => {
            if (error) {
                errorCount++;
                updateStats();
                addLog(`âŒ å‘å¸ƒå¤±è´¥: ${error.message}`, 'error');
            } else {
                sentCount++;
                updateStats();
                addLog(`ğŸ“¤ æ¶ˆæ¯å·²å‘å¸ƒ [${topic}] (QoS ${qos})`, 'success');
            }
        });
    }

    // å‘é€æ ·ä¾‹æ•°æ®
    function publishSampleData() {
        // ä½¿ç”¨ Alink åè®®æ ¼å¼çš„æ ·ä¾‹æ•°æ®
        const sampleData = {
            id: Date.now().toString(),
            version: "1.0",
            method: "thing.property.post",
            params: {
                temperature: parseFloat((20 + Math.random() * 10).toFixed(2)),
                humidity: parseFloat((50 + Math.random() * 20).toFixed(2)),
                pressure: parseFloat((1000 + Math.random() * 50).toFixed(2))
            }
        };

        document.getElementById('pubMessage').value = JSON.stringify(sampleData, null, 2);
        addLog('æ ·ä¾‹æ•°æ®å·²ç”Ÿæˆï¼ˆAlink åè®®æ ¼å¼ï¼‰', 'info');
        publish();
    }

    // è·å– productKey å’Œ deviceName
    function getDeviceInfo() {
        const clientId = document.getElementById('clientId').value;
        const parts = clientId.split('.');

        if (parts.length !== 2) {
            addLog('âŒ Client ID æ ¼å¼ä¸æ­£ç¡®ï¼ˆåº”ä¸º {productKey}.{deviceName}ï¼‰ï¼Œæ— æ³•ç”Ÿæˆä¸»é¢˜', 'error');
            return null;
        }

        return {
            productKey: parts[0],
            deviceName: parts[1]
        };
    }

    // å¿«æ·ä¸»é¢˜é€‰æ‹©ï¼ˆæ¶ˆæ¯å‘å¸ƒ - ä¸Šè¡Œæ¶ˆæ¯ï¼‰
    function selectQuickPublishTopic() {
        const select = document.getElementById('quickPublishTopicSelect');
        const selectedValue = select.value;

        console.log('[selectQuickPublishTopic] é€‰æ‹©çš„å€¼:', selectedValue);

        if (!selectedValue) {
            return;
        }

        const deviceInfo = getDeviceInfo();
        if (!deviceInfo) {
            return;
        }

        console.log('[selectQuickPublishTopic] è®¾å¤‡ä¿¡æ¯:', deviceInfo);

        // æ„å»ºæ ‡å‡†ä¸»é¢˜ï¼Œå°†æšä¸¾ä¸­çš„ç‚¹å·æ›¿æ¢ä¸ºæ–œæ 
        // ä¾‹å¦‚ï¼šthing.property.post -> /sys/{pk}/{dn}/thing/property/post
        const topic = `/sys/${deviceInfo.productKey}/${deviceInfo.deviceName}/${selectedValue.replace(/\./g, '/')}`;

        console.log('[selectQuickPublishTopic] ç”Ÿæˆçš„ä¸»é¢˜:', topic);

        const pubTopicInput = document.getElementById('pubTopic');
        pubTopicInput.value = topic;

        console.log('[selectQuickPublishTopic] è¾“å…¥æ¡†çš„å€¼å·²è®¾ç½®ä¸º:', pubTopicInput.value);

        addLog(`ğŸ“‹ å·²é€‰æ‹©å‘å¸ƒä¸»é¢˜: ${topic}`, 'info');

        // éœ€è¦ reply çš„æ¶ˆæ¯ç±»å‹ï¼ˆä¸åœ¨ REPLY_DISABLED åˆ—è¡¨ä¸­ï¼‰
        const needsReply = [
            'thing.property.post',
            'thing.event.post'
        ];

        // å¦‚æœéœ€è¦ replyï¼Œè‡ªåŠ¨è®¢é˜… reply ä¸»é¢˜
        if (needsReply.includes(selectedValue)) {
            const replyTopic = `${topic}_reply`;

            if (client && client.connected) {
                // è‡ªåŠ¨è®¢é˜… reply ä¸»é¢˜
                client.subscribe(replyTopic, {qos: 1}, (err) => {
                    if (!err) {
                        addLog(`âœ… å·²è‡ªåŠ¨è®¢é˜…å›å¤ä¸»é¢˜: ${replyTopic}`, 'success');
                    } else {
                        addLog(`âŒ è‡ªåŠ¨è®¢é˜…å›å¤ä¸»é¢˜å¤±è´¥: ${err.message}`, 'error');
                    }
                });
            } else {
                addLog(`ğŸ’¡ æç¤º: è¯¥æ¶ˆæ¯éœ€è¦è®¢é˜…å›å¤ä¸»é¢˜ ${replyTopic}`, 'warning');
            }
        }

        // é‡ç½®ä¸‹æ‹‰æ¡†åˆ°é»˜è®¤é€‰é¡¹
        select.selectedIndex = 0;
        console.log('[selectQuickPublishTopic] ä¸‹æ‹‰æ¡†å·²é‡ç½®');
    }

    // å¿«æ·ä¸»é¢˜é€‰æ‹©ï¼ˆä¸»é¢˜è®¢é˜… - ä¸‹è¡Œæ¶ˆæ¯ï¼‰
    function selectQuickTopic() {
        const select = document.getElementById('quickTopicSelect');
        const selectedValue = select.value;

        console.log('[selectQuickTopic] é€‰æ‹©çš„å€¼:', selectedValue);

        if (!selectedValue) {
            return;
        }

        const subTopicInput = document.getElementById('subTopic');

        // å¤„ç†é€šé…ç¬¦è®¢é˜…
        if (selectedValue === 'wildcard_all') {
            subTopicInput.value = '/sys/+/+/#';
            addLog('ğŸ“‹ å·²é€‰æ‹©è®¢é˜…ä¸»é¢˜: /sys/+/+/#ï¼ˆè®¢é˜…æ‰€æœ‰ä¸»é¢˜ï¼‰', 'info');
            console.log('[selectQuickTopic] è¾“å…¥æ¡†çš„å€¼å·²è®¾ç½®ä¸º:', subTopicInput.value);
            select.selectedIndex = 0;
            console.log('[selectQuickTopic] ä¸‹æ‹‰æ¡†å·²é‡ç½®');
            return;
        } else if (selectedValue === 'wildcard_thing') {
            subTopicInput.value = '/sys/+/+/thing/#';
            addLog('ğŸ“‹ å·²é€‰æ‹©è®¢é˜…ä¸»é¢˜: /sys/+/+/thing/#ï¼ˆè®¢é˜…æ‰€æœ‰ thing ä¸»é¢˜ï¼‰', 'info');
            console.log('[selectQuickTopic] è¾“å…¥æ¡†çš„å€¼å·²è®¾ç½®ä¸º:', subTopicInput.value);
            select.selectedIndex = 0;
            console.log('[selectQuickTopic] ä¸‹æ‹‰æ¡†å·²é‡ç½®');
            return;
        } else if (selectedValue === 'wildcard_reply') {
            const deviceInfo = getDeviceInfo();
            if (!deviceInfo) {
                select.selectedIndex = 0;
                return;
            }
            subTopicInput.value = `/sys/${deviceInfo.productKey}/${deviceInfo.deviceName}/#_reply`;
            addLog(`ğŸ“‹ å·²é€‰æ‹©è®¢é˜…ä¸»é¢˜: /sys/${deviceInfo.productKey}/${deviceInfo.deviceName}/#_replyï¼ˆè®¢é˜…æ‰€æœ‰å›å¤ä¸»é¢˜ï¼‰`, 'info');
            console.log('[selectQuickTopic] è¾“å…¥æ¡†çš„å€¼å·²è®¾ç½®ä¸º:', subTopicInput.value);
            select.selectedIndex = 0;
            console.log('[selectQuickTopic] ä¸‹æ‹‰æ¡†å·²é‡ç½®');
            return;
        }

        const deviceInfo = getDeviceInfo();
        if (!deviceInfo) {
            select.selectedIndex = 0;
            return;
        }

        console.log('[selectQuickTopic] è®¾å¤‡ä¿¡æ¯:', deviceInfo);

        // æ„å»ºæ ‡å‡†ä¸»é¢˜ï¼Œå°†æšä¸¾ä¸­çš„ç‚¹å·æ›¿æ¢ä¸ºæ–œæ 
        // ä¾‹å¦‚ï¼šthing.property.set -> /sys/{pk}/{dn}/thing/property/set
        const topic = `/sys/${deviceInfo.productKey}/${deviceInfo.deviceName}/${selectedValue.replace(/\./g, '/')}`;

        console.log('[selectQuickTopic] ç”Ÿæˆçš„ä¸»é¢˜:', topic);

        subTopicInput.value = topic;
        addLog(`ğŸ“‹ å·²é€‰æ‹©è®¢é˜…ä¸»é¢˜: ${topic}`, 'info');

        console.log('[selectQuickTopic] è¾“å…¥æ¡†çš„å€¼å·²è®¾ç½®ä¸º:', subTopicInput.value);

        // é‡ç½®ä¸‹æ‹‰æ¡†åˆ°é»˜è®¤é€‰é¡¹
        select.selectedIndex = 0;
        console.log('[selectQuickTopic] ä¸‹æ‹‰æ¡†å·²é‡ç½®');
    }

    // è®¢é˜…ä¸»é¢˜
    function subscribe() {
        if (!client || !client.connected) {
            addLog('âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            errorCount++;
            updateStats();
            return;
        }

        const topic = document.getElementById('subTopic').value;
        const qos = parseInt(document.getElementById('subQos').value);

        if (!topic) {
            addLog('âŒ è¯·å¡«å†™è®¢é˜…ä¸»é¢˜', 'error');
            errorCount++;
            updateStats();
            return;
        }

        client.subscribe(topic, {qos: qos}, (error) => {
            if (error) {
                errorCount++;
                updateStats();
                addLog(`âŒ è®¢é˜…å¤±è´¥: ${error.message}`, 'error');
            } else {
                addLog(`ğŸ“¥ å·²è®¢é˜…ä¸»é¢˜ [${topic}] (QoS ${qos})`, 'success');
            }
        });
    }

    // å–æ¶ˆè®¢é˜…
    function unsubscribe() {
        if (!client || !client.connected) {
            addLog('âŒ è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            errorCount++;
            updateStats();
            return;
        }

        const topic = document.getElementById('subTopic').value;

        if (!topic) {
            addLog('âŒ è¯·å¡«å†™è¦å–æ¶ˆçš„è®¢é˜…ä¸»é¢˜', 'error');
            errorCount++;
            updateStats();
            return;
        }

        client.unsubscribe(topic, (error) => {
            if (error) {
                errorCount++;
                updateStats();
                addLog(`âŒ å–æ¶ˆè®¢é˜…å¤±è´¥: ${error.message}`, 'error');
            } else {
                addLog(`âŒ å·²å–æ¶ˆè®¢é˜… [${topic}]`, 'info');
            }
        });
    }

    // æ¸…ç©ºæ—¥å¿—
    function clearLogs() {
        document.getElementById('logArea').innerHTML = '';
        sentCount = 0;
        receivedCount = 0;
        errorCount = 0;
        updateStats();
        addLog('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º', 'info');
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.onload = function () {
        addLog('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ MQTT WebSocket æµ‹è¯•å®¢æˆ·ç«¯ï¼', 'success');
        addLog('ğŸ“š è¯·é…ç½®è¿æ¥å‚æ•°åç‚¹å‡»"è¿æ¥"æŒ‰é’®', 'info');
    };

    // é¡µé¢å…³é—­å‰æ–­å¼€è¿æ¥
    window.onbeforeunload = function () {
        if (client && client.connected) {
            client.end();
        }
    };
</script>
</body>
</html>


