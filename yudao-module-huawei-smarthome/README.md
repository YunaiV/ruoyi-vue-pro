# 芋道项目 - 华为智能家居模块 (`yudao-module-huawei-smarthome`)

## 1. 模块概述

本模块 (`yudao-module-huawei-smarthome`) 用于集成华为全屋智能开放平台的能力。通过调用华为提供的北向开放接口，实现对智能家居资产（如空间、子空间）、设备、场景的管理和控制，并能接收和处理来自华为平台的事件通知。

旨在为基于芋道开源项目的应用提供快速接入华为智能家居生态系统的能力。

## 2. 主要功能

当前模块已实现以下核心API接口的对接框架：

*   **资产管理接口**
    *   创建空间
    *   修改空间
    *   删除空间
    *   查询项目下所有空间信息
    *   查询指定空间信息
*   **子空间区域管理接口**
    *   查询空间内子空间信息
    *   修改子空间名称
*   **设备管理接口**
    *   查询指定空间下设备信息
    *   查询指定设备信息 (批量)
    *   设备控制
*   **场景管理接口**
    *   查询指定空间下所有场景
    *   修改场景 (启用/禁用/修改参数)
    *   执行场景
    *   删除场景
    *   导入单个场景 (异步，结果通过通知接口回调)
    *   场景个数与 ECA 单元统计
    *   查询场景实例详情
*   **通知接口**
    *   提供统一事件通知接收端点，用于接收华为平台推送的各类事件，如设备数据变更、设备状态变更、场景执行日志等。

## 3. 配置说明

要使本模块正常工作，需要在项目的配置文件（例如 `application-local.yml` 或对应的生产环境配置文件）中添加华为智能家居平台的相关配置。这些配置通过 `HuaweiSmartHomeProperties` 类进行管理。

```yaml
yudao:
  huawei:
    smarthome:
      endpoint: "https://your-huawei-api-endpoint"  # 华为智能家居平台的 API Endpoint，例如：https://api.smarthome.huawei.com
      access-key: "your-access-key"                  # 访问密钥 ID (AK)
      secret-key: "your-hex-secret-key"              # 秘密访问密钥 (SK)，注意：必须是16进制字符串形式
      project-id: "your-project-id"                  # 项目 ID
      connect-timeout: 10000                         # (可选) 连接超时时间，单位毫秒，默认10000
      read-timeout: 30000                            # (可选) 读取超时时间，单位毫秒，默认30000
```

**重要提示关于 `secret-key`**：
根据华为API文档及其提供的Java Demo，用于签名的 `secretKey` 应为其 **16进制字符串表示形式**。请确保填写的 `secret-key` 符合此要求。模块内部的签名工具类 `HuaweiSmartHomeAuthUtils` 会使用 `Hex.decodeHex` 将此16进制字符串转换为字节数组进行HMAC-SHA256计算。

## 4. API接口文档

本模块所有对外暴露的API接口均已集成Swagger注解。项目启动后，可以通过访问Swagger UI（通常路径为 `/doc.html` 或 `/swagger-ui/index.html`）来查看和测试这些接口。

在Swagger UI中，可以找到 "用户APP - 华为智能家居 - XXX管理" 分组下的各个接口。

## 5. 注意事项

*   **SK密钥格式**：再次强调，`secret-key` 配置项需要填写16进制字符串形式的密钥。
*   **API行为确认**：
    *   部分接口（如修改子空间名称 `updateRoomName`，设备控制 `controlDevice`）的请求体构造，目前是严格遵循了华为API文档中提供的 **请求体示例**。然而，这些示例可能与文档中列出的 **请求参数列表** 存在不完全一致的情况（例如，路径参数是否需要在请求体中重复，或者某些参数是否真的需要包含在请求体中）。在实际对接和测试时，可能需要根据华为平台的实际响应进行微调。
    *   某些API（如场景统计 `getScenarioStatistics`，查询场景详情 `getScenarioDetail`）的HTTP方法，本模块实现是基于华为文档的文本描述（如GET），但其附带的请求示例可能是POST。这也需要在实际对接时确认。
    *   执行场景 `triggerScenario` 接口的请求体，目前实现为空JSON对象 `{}`，因华为文档未明确其请求体内容，通常触发类POST请求体可为空。
*   **异步接口**：导入单个场景接口是异步的，其执行结果会通过后续实现的通知接口进行回调处理。确保通知接收端点配置正确并能被华为平台访问。
*   **错误处理**：当前各Controller层对调用华为API时发生的 `IOException` 做了简单的错误包装。在生产环境中，建议根据华为返回的具体错误码（通常在异常信息或响应体中）进行更细致的错误分类和处理，并转换为项目中统一的业务异常体系。
*   **业务逻辑填充**：目前Service层的实现大多是对华为API的直接调用和数据转换。实际业务场景中，可能需要在Service层添加更复杂的业务逻辑、数据校验、与项目其他模块的交互、以及必要的数据持久化（例如，缓存设备信息、存储操作日志等）。

## 6. 后续开发

*   实现设备升级管理接口。
*   实现子系统管理接口。
*   完善各Service层中具体的业务逻辑。
*   根据华为API的错误码，细化错误处理机制。
*   添加更全面的单元测试和集成测试。
*   按需实现数据的本地持久化。

---
此README提供了模块的基本信息和使用指南。如有疑问或发现问题，请及时反馈。
