<!-- TODO @AI：参考 /Users/yunai/Java/yudao-ui-admin-uniapp-next-v4/src/pages/message/components/search-form.vue 和 /Users/yunai/Java/yudao-ui-admin-uniapp-next-v4/src/pages/message/index.vue，实现对 time + 范围的处理； -->
<template>
  <!-- 搜索框入口 -->
  <wd-search
    :placeholder="searchPlaceholder"
    :hide-cancel="true"
    disabled
    @click="visible = true"
  />

  <!-- 搜索弹窗 -->
  <wd-popup
    v-model="visible"
    position="top"
    custom-style="border-radius: 0 0 24rpx 24rpx;"
    safe-area-inset-top
    @close="visible = false"
  >
    <view class="p-32rpx">
      <view class="mb-24rpx text-32rpx text-[#333] font-semibold">
        搜索${table.classComment}
      </view>
#set ($hasDict = 0)
#foreach ($column in $columns)
  #if ($hasDict == 0 && $column.listOperation && $column.dictType && "" != $column.dictType)
    #set ($hasDict = 1)
  #end
#end
#foreach($column in $columns)
  #if ($column.listOperation)
    #set ($dictType = $column.dictType)
    #set ($javaField = $column.javaField)
    #set ($javaType = $column.javaType)
    #set ($listOperationCondition = $column.listOperationCondition)
    #set ($comment = $column.columnComment)
    #set ($dictMethod = "getDictOptions")
    #if ($javaType == "Integer" || $javaType == "Long" || $javaType == "Byte" || $javaType == "Short")
      #set ($dictMethod = "getIntDictOptions")
    #elseif ($javaType == "String")
      #set ($dictMethod = "getStrDictOptions")
    #elseif ($javaType == "Boolean")
      #set ($dictMethod = "getBoolDictOptions")
    #end
    #if ($column.htmlType == "input")
      <view class="mb-24rpx">
        <view class="mb-12rpx text-28rpx text-[#666]">
          ${comment}
        </view>
        <wd-input
          v-model="formData.${javaField}"
          placeholder="请输入${comment}"
          clearable
        />
      </view>
    #elseif ($column.htmlType == "datetime" && $listOperationCondition == "BETWEEN")
      #set ($AttrName = $javaField.substring(0,1).toUpperCase() + ${javaField.substring(1)})
      <view class="mb-32rpx">
        <view class="mb-12rpx text-28rpx text-[#666]">
          ${comment}
        </view>
        <view class="flex items-center gap-16rpx">
          <view class="flex-1" @click="visible${AttrName}[0] = true">
            <view
              class="h-72rpx flex items-center justify-center rounded-8rpx bg-[#f5f5f5] px-24rpx text-28rpx"
            >
              {{ formatDate(formData.${javaField}?.[0]) || '开始日期' }}
            </view>
          </view>
          <text class="text-28rpx text-[#999]">至</text>
          <view class="flex-1" @click="visible${AttrName}[1] = true">
            <view
              class="h-72rpx flex items-center justify-center rounded-8rpx bg-[#f5f5f5] px-24rpx text-28rpx"
            >
              {{ formatDate(formData.${javaField}?.[1]) || '结束日期' }}
            </view>
          </view>
        </view>
        <wd-datetime-picker-view
          v-if="visible${AttrName}[0]"
          v-model="temp${AttrName}[0]"
          type="date"
          :columns-height="200"
        />
        <view v-if="visible${AttrName}[0]" class="mt-16rpx flex justify-end gap-16rpx">
          <wd-button size="small" plain @click="handle${AttrName}0Cancel">
            取消
          </wd-button>
          <wd-button size="small" type="primary" @click="handle${AttrName}0Confirm">
            确定
          </wd-button>
        </view>
        <wd-datetime-picker-view
          v-if="visible${AttrName}[1]"
          v-model="temp${AttrName}[1]"
          type="date"
          :columns-height="200"
        />
        <view v-if="visible${AttrName}[1]" class="mt-16rpx flex justify-end gap-16rpx">
          <wd-button size="small" plain @click="handle${AttrName}1Cancel">
            取消
          </wd-button>
          <wd-button size="small" type="primary" @click="handle${AttrName}1Confirm">
            确定
          </wd-button>
        </view>
      </view>
    #elseif (($column.htmlType == "select" || $column.htmlType == "radio") && $dictType && "" != $dictType)
      <view class="mb-32rpx">
        <view class="mb-12rpx text-28rpx text-[#666]">
          ${comment}
        </view>
        <wd-radio-group v-model="formData.${javaField}" shape="button">
          <wd-radio :value="-1">
            全部
          </wd-radio>
          <wd-radio
            v-for="dict in $dictMethod(DICT_TYPE.$dictType.toUpperCase())"
            :key="dict.value"
            :value="dict.value"
          >
            {{ dict.label }}
          </wd-radio>
        </wd-radio-group>
      </view>
    #else
      <view class="mb-24rpx">
        <view class="mb-12rpx text-28rpx text-[#666]">
          ${comment}
        </view>
        <wd-input
          v-model="formData.${javaField}"
          placeholder="请输入${comment}"
          clearable
        />
      </view>
    #end
  #end
#end
      <view class="w-full flex justify-center gap-24rpx">
        <wd-button class="flex-1" plain @click="handleReset">
          重置
        </wd-button>
        <wd-button class="flex-1" type="primary" @click="handleSearch">
          搜索
        </wd-button>
      </view>
    </view>
  </wd-popup>
</template>

<script lang="ts" setup>
#set ($hasDict = 0)
#set ($hasGetDictOptions = 0)
#set ($hasGetIntDictOptions = 0)
#set ($hasGetStrDictOptions = 0)
#set ($hasGetBoolDictOptions = 0)
#set ($hasDateTimeBetween = 0)
#foreach($column in $columns)
  #if ($column.listOperation && $column.dictType && "" != $column.dictType)
    #set ($hasDict = 1)
    #if ($column.htmlType == "select" || $column.htmlType == "radio")
      #if ($column.javaType == "Integer" || $column.javaType == "Long" || $column.javaType == "Byte" || $column.javaType == "Short")
        #set ($hasGetIntDictOptions = 1)
      #elseif ($column.javaType == "String")
        #set ($hasGetStrDictOptions = 1)
      #elseif ($column.javaType == "Boolean")
        #set ($hasGetBoolDictOptions = 1)
      #else
        #set ($hasGetDictOptions = 1)
      #end
    #end
  #end
  #if ($hasDateTimeBetween == 0 && $column.listOperation && $column.htmlType == "datetime" && $column.listOperationCondition == "BETWEEN")
    #set ($hasDateTimeBetween = 1)
  #end
#end
import { computed, reactive, ref, watch } from 'vue'
#if ($hasDateTimeBetween == 1)
import { formatDate } from '@/utils/date'
#end
#if ($hasDict == 1)
  #set ($dictImportNames = "getDictLabel, ")
  #if ($hasGetDictOptions == 1)
    #set ($dictImportNames = "${dictImportNames}getDictOptions, ")
  #end
  #if ($hasGetIntDictOptions == 1)
    #set ($dictImportNames = "${dictImportNames}getIntDictOptions, ")
  #end
  #if ($hasGetStrDictOptions == 1)
    #set ($dictImportNames = "${dictImportNames}getStrDictOptions, ")
  #end
  #if ($hasGetBoolDictOptions == 1)
    #set ($dictImportNames = "${dictImportNames}getBoolDictOptions, ")
  #end
  #set ($dictImportNames = $dictImportNames.trim())
  #set ($dictImportNames = $dictImportNames.substring(0, $dictImportNames.length() - 1))
import { $dictImportNames } from '@/hooks/useDict'
import { DICT_TYPE } from '@/utils/constants'
#end

/** 搜索表单数据 */
export interface SearchFormData {
#foreach($column in $columns)
  #if ($column.listOperation)
    #set ($javaType = $column.javaType.toLowerCase())
    #if ($column.htmlType == "datetime" && $column.listOperationCondition == "BETWEEN")
  ${column.javaField}?: [number | undefined, number | undefined]
    #elseif ($column.dictType && "" != $column.dictType)
      #if(${javaType} == "string")
  ${column.javaField}?: string | number
      #elseif(${javaType} == "boolean")
  ${column.javaField}?: boolean | number
      #else
  ${column.javaField}?: number
      #end
    #elseif(${javaType} == "long" || ${javaType} == "integer" || ${javaType} == "short" || ${javaType} == "double" || ${javaType} == "bigdecimal" || ${javaType} == "byte")
  ${column.javaField}?: number
    #elseif(${javaType} == "boolean")
  ${column.javaField}?: boolean
    #else
  ${column.javaField}?: string
    #end
  #end
#end
}

const props = defineProps<{
  searchParams?: Partial<SearchFormData>
}>()

const emit = defineEmits<{
  search: [data: SearchFormData]
  reset: []
}>()

const visible = ref(false)
const formData = reactive<SearchFormData>({
#foreach($column in $columns)
  #if ($column.listOperation)
    #if ($column.htmlType == "datetime" && $column.listOperationCondition == "BETWEEN")
  ${column.javaField}: [undefined, undefined] as [number | undefined, number | undefined],
    #elseif ($column.dictType && "" != $column.dictType)
      #set ($javaType = $column.javaType.toLowerCase())
      #if(${javaType} == "string")
  ${column.javaField}: -1 as number | string,
      #elseif(${javaType} == "boolean")
  ${column.javaField}: -1 as number | boolean,
      #else
  ${column.javaField}: -1 as number,
      #end
    #else
  ${column.javaField}: undefined,
    #end
  #end
#end
})

/** 搜索条件 placeholder 拼接 */
const searchPlaceholder = computed(() => {
  const conditions: string[] = []
#foreach($column in $columns)
  #if ($column.listOperation)
    #set ($dictType = $column.dictType)
    #set ($javaField = $column.javaField)
    #set ($javaType = $column.javaType.toLowerCase())
    #set ($comment = $column.columnComment)
    #if ($column.htmlType == "datetime" && $column.listOperationCondition == "BETWEEN")
  if (props.searchParams?.${javaField}?.[0] && props.searchParams?.${javaField}?.[1]) {
    conditions.push(`${comment}:#[[${]]#formatDate(props.searchParams.${javaField}[0])#[[}]]#~#[[${]]#formatDate(props.searchParams.${javaField}[1])#[[}]]#`)
  }
    #elseif ($dictType && "" != $dictType)
  if (props.searchParams?.${javaField} !== undefined && props.searchParams.${javaField} !== -1) {
    conditions.push(`${comment}:#[[${]]#getDictLabel(DICT_TYPE.${dictType.toUpperCase()}, props.searchParams.${javaField})#[[}]]#`)
  }
    #else
  #if(${javaType} == "long" || ${javaType} == "integer" || ${javaType} == "short" || ${javaType} == "double" || ${javaType} == "bigdecimal" || ${javaType} == "byte" || ${javaType} == "boolean")
  if (props.searchParams?.${javaField} !== undefined) {
    conditions.push(`${comment}:#[[${]]#props.searchParams.${javaField}#[[}]]#`)
  }
  #else
  if (props.searchParams?.${javaField}) {
    conditions.push(`${comment}:#[[${]]#props.searchParams.${javaField}#[[}]]#`)
  }
  #end
    #end
  #end
#end
  return conditions.length > 0 ? conditions.join(' | ') : '搜索${table.classComment}'
})

/** 监听弹窗打开，同步外部参数 */
watch(visible, (val) => {
  if (val && props.searchParams) {
#foreach($column in $columns)
  #if ($column.listOperation)
    #if ($column.htmlType == "datetime" && $column.listOperationCondition == "BETWEEN")
    formData.${column.javaField} = props.searchParams.${column.javaField} ?? [undefined, undefined]
    #elseif ($column.dictType && "" != $column.dictType)
    formData.${column.javaField} = props.searchParams.${column.javaField} ?? -1
    #else
    formData.${column.javaField} = props.searchParams.${column.javaField}
    #end
  #end
#end
  }
})

#if ($hasDateTimeBetween == 1)
// 时间范围选择器状态
#foreach($column in $columns)
  #if ($column.listOperation && $column.htmlType == "datetime" && $column.listOperationCondition == "BETWEEN")
    #set ($javaField = $column.javaField)
    #set ($AttrName = $javaField.substring(0,1).toUpperCase() + ${javaField.substring(1)})
const visible${AttrName} = ref<[boolean, boolean]>([false, false])
const temp${AttrName} = ref<[number, number]>([Date.now(), Date.now()])

/** ${column.columnComment}[0]确认 */
function handle${AttrName}0Confirm() {
  formData.${javaField} = [temp${AttrName}.value[0], formData.${javaField}?.[1]]
  visible${AttrName}.value[0] = false
}

/** ${column.columnComment}[0]取消 */
function handle${AttrName}0Cancel() {
  visible${AttrName}.value[0] = false
}

/** ${column.columnComment}[1]确认 */
function handle${AttrName}1Confirm() {
  formData.${javaField} = [formData.${javaField}?.[0], temp${AttrName}.value[1]]
  visible${AttrName}.value[1] = false
}

/** ${column.columnComment}[1]取消 */
function handle${AttrName}1Cancel() {
  visible${AttrName}.value[1] = false
}
  #end
#end
#end

/** 搜索 */
function handleSearch() {
  visible.value = false
  emit('search', { ...formData } as SearchFormData)
}

/** 重置 */
function handleReset() {
#foreach($column in $columns)
  #if ($column.listOperation)
    #if ($column.htmlType == "datetime" && $column.listOperationCondition == "BETWEEN")
  formData.${column.javaField} = [undefined, undefined]
    #elseif ($column.dictType && "" != $column.dictType)
  formData.${column.javaField} = -1
    #else
  formData.${column.javaField} = undefined
    #end
  #end
#end
  visible.value = false
  emit('reset')
}
</script>
