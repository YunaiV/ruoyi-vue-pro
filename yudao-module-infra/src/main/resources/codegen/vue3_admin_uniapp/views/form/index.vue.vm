<template>
  <view class="page-container">
    <wd-navbar
      :title="getTitle"
      left-arrow placeholder safe-area-inset-top fixed
      @click-left="handleBack"
    />

    <view>
      <wd-form ref="formRef" :model="formData" :rules="formRules">
        <wd-cell-group border>
#foreach($column in $columns)
  #if (($column.createOperation || $column.updateOperation) && !$column.primaryKey)
    #set ($dictType = $column.dictType)
    #set ($javaField = $column.javaField)
    #set ($javaType = $column.javaType)
    #set ($comment = $column.columnComment)
    #set ($dictMethod = "getDictOptions")
    #if ($javaType == "Integer" || $javaType == "Long" || $javaType == "Byte" || $javaType == "Short")
      #set ($dictMethod = "getIntDictOptions")
    #elseif ($javaType == "String")
      #set ($dictMethod = "getStrDictOptions")
    #elseif ($javaType == "Boolean")
      #set ($dictMethod = "getBoolDictOptions")
    #end

    #if (${javaType.toLowerCase()} == "long" || ${javaType.toLowerCase()} == "integer" || ${javaType.toLowerCase()} == "short" || ${javaType.toLowerCase()} == "double" || ${javaType.toLowerCase()} == "bigdecimal" || ${javaType.toLowerCase()} == "byte")
          <wd-cell title="${comment}" title-width="180rpx" prop="${javaField}" center>
            <wd-input-number
              v-model="formData.${javaField}"
              :min="0"
            />
          </wd-cell>
    #elseif (${javaType.toLowerCase()} == "boolean")
          <wd-cell title="${comment}" title-width="180rpx" prop="${javaField}" center>
            <wd-switch v-model="formData.${javaField}" />
          </wd-cell>
    #elseif ($column.htmlType == "textarea")
          <wd-textarea
            v-model="formData.${javaField}"
            label="${comment}"
            label-width="180rpx"
            placeholder="请输入${comment}"
            :maxlength="200"
            show-word-limit
            clearable
          />
    #elseif (($column.htmlType == "select" || $column.htmlType == "radio") && $dictType && "" != $dictType)
          <wd-cell title="${comment}" title-width="180rpx" prop="${javaField}" center>
            <wd-radio-group v-model="formData.${javaField}" shape="button" size="medium">
              <wd-radio
                v-for="dict in $dictMethod(DICT_TYPE.$dictType.toUpperCase())"
                :key="dict.value"
                :value="dict.value"
              >
                {{ dict.label }}
              </wd-radio>
            </wd-radio-group>
          </wd-cell>
    #else
          <wd-input
            v-model="formData.${javaField}"
            label="${comment}"
            label-width="180rpx"
            prop="${javaField}"
            clearable
            placeholder="请输入${comment}"
          />
    #end
  #end
#end
        </wd-cell-group>
      </wd-form>
    </view>

    <view class="fixed bottom-0 left-0 right-0 bg-white p-24rpx">
      <wd-button
        type="primary"
        block
        :loading="formLoading"
        @click="handleSubmit"
      >
        保存
      </wd-button>
    </view>
  </view>
</template>

<script lang="ts" setup>
import type { ${simpleClassName} } from '@/api/${table.moduleName}/${table.businessName}'
import { computed, onMounted, ref } from 'vue'
import { useToast } from 'wot-design-uni'
import { create${simpleClassName}, get${simpleClassName}, update${simpleClassName} } from '@/api/${table.moduleName}/${table.businessName}'
import { navigateBackPlus } from '@/utils'

#set ($primaryJavaType = $primaryColumn.javaType.toLowerCase())
#if(${primaryJavaType} == "long" || ${primaryJavaType} == "integer" || ${primaryJavaType} == "short" || ${primaryJavaType} == "double" || ${primaryJavaType} == "bigdecimal" || ${primaryJavaType} == "byte")
#set ($primaryTsType = "number")
#else
#set ($primaryTsType = "string")
#end

#set ($hasDict = 0)
#set ($hasGetDictOptions = 0)
#set ($hasGetIntDictOptions = 0)
#set ($hasGetStrDictOptions = 0)
#set ($hasGetBoolDictOptions = 0)
#foreach ($column in $columns)
  #if (($column.createOperation || $column.updateOperation) && !$column.primaryKey
      && ($column.htmlType == "select" || $column.htmlType == "radio")
      && $column.dictType && "" != $column.dictType)
    #set ($hasDict = 1)
    #if ($column.javaType == "Integer" || $column.javaType == "Long" || $column.javaType == "Byte" || $column.javaType == "Short")
      #set ($hasGetIntDictOptions = 1)
    #elseif ($column.javaType == "String")
      #set ($hasGetStrDictOptions = 1)
    #elseif ($column.javaType == "Boolean")
      #set ($hasGetBoolDictOptions = 1)
    #else
      #set ($hasGetDictOptions = 1)
    #end
  #end
#end
#if ($hasDict == 1)
import { DICT_TYPE } from '@/utils/constants'
import {
  #if ($hasGetDictOptions == 1)
  getDictOptions,
  #end
  #if ($hasGetIntDictOptions == 1)
  getIntDictOptions,
  #end
  #if ($hasGetStrDictOptions == 1)
  getStrDictOptions,
  #end
  #if ($hasGetBoolDictOptions == 1)
  getBoolDictOptions,
  #end
} from '@/hooks/useDict'
#end

const props = defineProps<{
  id?: ${primaryTsType} | any
}>()

definePage({
  style: {
    navigationBarTitleText: '',
    navigationStyle: 'custom',
  },
})

const toast = useToast()
const getTitle = computed(() => props.id ? '编辑${table.classComment}' : '新增${table.classComment}')
const formLoading = ref(false)

// TODO @AI：date + 时间范围，需要特殊处理；参考 /Users/yunai/Java/yudao-ui-admin-uniapp-next-v4/src/pages/message/components/search-form.vue 里的开始结束时间的处理；注意，index.vue.vm 也要调整；
const formData = ref<${simpleClassName}>({
#foreach($column in $columns)
  #if (($column.createOperation || $column.updateOperation) || $column.primaryKey)
    #set ($javaType = $column.javaType.toLowerCase())
    #if ($column.primaryKey)
  ${column.javaField}: undefined,
    #elseif(${javaType} == "long" || ${javaType} == "integer" || ${javaType} == "short" || ${javaType} == "double" || ${javaType} == "bigdecimal" || ${javaType} == "byte")
  ${column.javaField}: 0,
    #elseif(${javaType} == "boolean")
  ${column.javaField}: false,
    #else
  ${column.javaField}: '',
    #end
  #end
#end
})

const formRules = {
#foreach($column in $columns)
  #if (($column.createOperation || $column.updateOperation) && !$column.nullable && !$column.primaryKey)
  ${column.javaField}: [{ required: true, message: '${column.columnComment}不能为空' }],
  #end
#end
}

const formRef = ref()

function handleBack() {
  navigateBackPlus('/pages-${table.moduleName}/${table.businessName}/index')
}

async function getDetail() {
  if (!props.id) {
    return
  }
  formData.value = await get${simpleClassName}(props.id)
}

async function handleSubmit() {
  const { valid } = await formRef.value.validate()
  if (!valid) {
    return
  }

  formLoading.value = true
  try {
    if (props.id) {
      await update${simpleClassName}(formData.value)
      toast.success('修改成功')
    } else {
      await create${simpleClassName}(formData.value)
      toast.success('新增成功')
    }
    setTimeout(() => {
      handleBack()
    }, 500)
  } finally {
    formLoading.value = false
  }
}

onMounted(() => {
  getDetail()
})
</script>

<style lang="scss" scoped>
</style>
