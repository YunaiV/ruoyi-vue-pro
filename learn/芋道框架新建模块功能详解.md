# 芋道框架新建模块功能详解

## 🎯 概述

芋道框架采用模块化架构设计，支持灵活的模块扩展。`yudao-module-demo` 是一个实验性示例模块，专门用于测试和演示如何在芋道框架中新建自定义模块和 API，包括如何创建自定义 API 前缀。

## 📚 目录结构

1. [模块化架构设计](#模块化架构设计)
2. [Demo 模块分析](#demo-模块分析)
3. [新建模块步骤](#新建模块步骤)
4. [API 类型详解](#api-类型详解)
5. [模块集成配置](#模块集成配置)
6. [最佳实践](#最佳实践)

---

## 🏗️ 模块化架构设计

### 架构概览

```
yudao-vue-pro/
├── yudao-dependencies/          # 依赖管理
├── yudao-framework/             # 框架核心
├── yudao-server/               # 主服务（容器）
├── yudao-module-system/        # 系统管理模块
├── yudao-module-infra/         # 基础设施模块
├── yudao-module-demo/          # 示例模块 ⭐⭐⭐
├── yudao-module-bpm/           # 工作流模块（可选）
├── yudao-module-pay/           # 支付模块（可选）
├── yudao-module-mall/          # 商城模块（可选）
└── yudao-module-xxx/           # 自定义模块
```

### 设计原则

1. **模块独立性**：每个模块都是独立的 Maven 项目
2. **按需加载**：可以选择性地启用或禁用模块
3. **统一规范**：所有模块遵循相同的目录结构和命名规范
4. **松耦合**：模块间通过 API 接口进行通信

---

## 📦 Demo 模块分析

### 模块结构

```
yudao-module-demo/
├── pom.xml                     # Maven 配置文件
└── src/main/java/cn/iocoder/yudao/module/demo/
    ├── controller/             # 控制器层
    │   ├── admin/             # 后台管理 API
    │   │   └── DemoTestController.java
    │   ├── app/               # 用户端 API
    │   │   └── AppDemoTestController.java
    │   └── open/              # 开放 API
    │       └── DemoOpenTestController.java
    ├── service/               # 服务层（空）
    └── dal/                   # 数据访问层（空）
```

![image-20250818161304781](D:\code\ruoyi-vue-pro\learn\芋道框架新建模块功能详解.assets\image-20250818161304781.png)

### 三种 API 类型

#### 1. 后台管理 API (Admin)

```java
@Tag(name="后台管理 -Test")
@RestController
@RequestMapping("/demo/test")
@Validated
public class DemoTestController {

    public DemoTestController(){
        System.out.println(getClass()+"生效成功");
    }

    @GetMapping("/get")
    @Operation(summary = "获取 test 信息")
    public CommonResult<String> get() {
        return success("true");
    }
}
```

**特点：**
- 路径前缀：`/admin-api/demo/test`
- 用途：后台管理系统使用
- 权限：需要管理员权限
- 文档：Swagger 分组为"后台管理"

#### 2. 用户端 API (App)

```java
@Tag(name = "用户 App - Test")
@RestController
@RequestMapping("/demo/test")
@Validated
public class AppDemoTestController {

    public AppDemoTestController() {
        System.out.println(getClass() + "生效啦！！！");
    }

    @GetMapping("/get")
    @Operation(summary = "获取 test 信息")
    public CommonResult<String> get() {
        return success("true");
    }
}
```

**特点：**
- 路径前缀：`/app-api/demo/test`
- 用途：移动端或用户端使用
- 权限：需要用户登录
- 文档：Swagger 分组为"用户 App"

#### 3. 自定义 API 前缀 (Open)

```java
@Tag(name = "新建Openapi模块 - Test")
@RestController
@RequestMapping("/demo/test")
@Validated
public class DemoOpenTestController {

    public DemoOpenTestController() {
        System.out.println(getClass() + "生效啦！！！");
    }

    @GetMapping("/get")
    @Operation(summary = "获取 test 信息")
    public CommonResult<String> get() {
        return success("true");
    }
}
```

**特点：**
- 路径前缀：`/open-api/demo/test`（自定义 API 前缀示例）
- 用途：演示如何创建自定义 API 前缀
- 权限：可根据需要自定义权限控制
- 文档：Swagger 分组为"自定义 API"

> **说明**：这个 Open API 是参考官方文档创建的自定义 API 前缀示例，用于演示如何扩展芋道框架的 API 类型。

---

## 🔧 新建模块步骤

### 步骤 1：创建 Maven 模块

#### 1.1 创建模块目录

```bash
# 在项目根目录下创建新模块
mkdir yudao-module-yourmodule
cd yudao-module-yourmodule
```

#### 1.2 创建 pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>cn.iocoder.boot</groupId>
        <artifactId>yudao</artifactId>
        <version>${revision}</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>yudao-module-yourmodule</artifactId>
    <packaging>jar</packaging>

    <name>${project.artifactId}</name>
    <description>你的模块描述</description>

    <dependencies>
        <!-- 基础依赖 -->
        <dependency>
            <groupId>cn.iocoder.boot</groupId>
            <artifactId>yudao-spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- 数据库依赖（如果需要） -->
        <dependency>
            <groupId>cn.iocoder.boot</groupId>
            <artifactId>yudao-spring-boot-starter-mybatis</artifactId>
        </dependency>
        
        <!-- 其他依赖... -->
    </dependencies>
</project>
```

### 步骤 2：创建目录结构

```bash
# 创建标准目录结构
mkdir -p src/main/java/cn/iocoder/yudao/module/yourmodule/controller/admin
mkdir -p src/main/java/cn/iocoder/yudao/module/yourmodule/controller/app
mkdir -p src/main/java/cn/iocoder/yudao/module/yourmodule/controller/open
mkdir -p src/main/java/cn/iocoder/yudao/module/yourmodule/service
mkdir -p src/main/java/cn/iocoder/yudao/module/yourmodule/dal/dataobject
mkdir -p src/main/java/cn/iocoder/yudao/module/yourmodule/dal/mysql
mkdir -p src/main/resources
```

### 步骤 3：创建控制器

#### 3.1 后台管理控制器

```java
package cn.iocoder.yudao.module.yourmodule.controller.admin;

import cn.iocoder.yudao.framework.common.pojo.CommonResult;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import static cn.iocoder.yudao.framework.common.pojo.CommonResult.success;

@Tag(name = "后台管理 - 你的模块")
@RestController
@RequestMapping("/yourmodule/test")
@Validated
public class YourModuleController {

    @GetMapping("/get")
    @Operation(summary = "获取测试信息")
    public CommonResult<String> get() {
        return success("你的模块运行正常");
    }
}
```

### 步骤 4：注册模块

#### 4.1 在根 pom.xml 中添加模块

```xml
<modules>
    <module>yudao-dependencies</module>
    <module>yudao-framework</module>
    <module>yudao-server</module>
    <module>yudao-module-system</module>
    <module>yudao-module-infra</module>
    <module>yudao-module-demo</module>
    <module>yudao-module-yourmodule</module>  <!-- 添加这行 -->
</modules>
```

#### 4.2 在 yudao-server/pom.xml 中添加依赖

```xml
<dependencies>
    <!-- 现有依赖... -->
    
    <!-- 你的模块 -->
    <dependency>
        <groupId>cn.iocoder.boot</groupId>
        <artifactId>yudao-module-yourmodule</artifactId>
        <version>${revision}</version>
    </dependency>
</dependencies>
```

### 步骤 5：测试模块

#### 5.1 启动项目

```bash
# 编译项目
mvn clean compile

# 启动项目
mvn spring-boot:run -pl yudao-server
```

#### 5.2 访问 API

```bash
# swgger前端页面地址
http://127.0.0.1:48080/doc.html

# 后台管理 API
curl http://localhost:8080/admin-api/yourmodule/test/get

# 用户端 API
curl http://localhost:8080/app-api/yourmodule/test/get

# 自定义 API（以 open-api 为例）
curl http://localhost:8080/open-api/yourmodule/test/get
```

#### 5.3 查看 Swagger 文档

- 后台管理：http://localhost:8080/admin-api/doc.html
- 用户端：http://localhost:8080/app-api/doc.html
- 自定义 API：http://localhost:8080/open-api/doc.html（以 open-api 为例）

---

![image-20250818161356397](D:\code\ruoyi-vue-pro\learn\芋道框架新建模块功能详解.assets\image-20250818161356397.png)

![image-20250818161431693](D:\code\ruoyi-vue-pro\learn\芋道框架新建模块功能详解.assets\image-20250818161431693.png)

## 🔧 自定义 API 前缀详解

### 什么是自定义 API 前缀？

芋道框架默认提供了两种 API 前缀：
- `/admin-api`：后台管理 API
- `/app-api`：用户端 API

但在实际项目中，你可能需要创建其他类型的 API，比如：
- `/open-api`：开放 API（第三方调用）
- `/partner-api`：合作伙伴 API
- `/internal-api`：内部系统 API
- `/webhook-api`：回调 API

### 如何创建自定义 API 前缀？

#### 步骤 1：在WebProperties中新增前缀配置

```java
public class WebProperties {

    @NotNull(message = "APP API 不能为空")
    private Api appApi = new Api("/app-api", "**.controller.app.**");
    @NotNull(message = "Admin API 不能为空")
    private Api adminApi = new Api("/admin-api", "**.controller.admin.**");
//    这里可以添加新的api前缀 比如 open
    @NotNull
    private Api openApi = new Api("/open-api", "**.controller.open.**");
}
```

#### 步骤 2：YudaoWebAutoConfiguration配置添加前缀配置

```java
public class YudaoWebAutoConfiguration implements WebMvcConfigurer {

    @Resource
    private WebProperties webProperties;
    /**
     * 应用名
     */
    @Value("${spring.application.name}")
    private String applicationName;

    @Override
    public void configurePathMatch(PathMatchConfigurer configurer) {
        configurePathMatch(configurer, webProperties.getAdminApi());
        configurePathMatch(configurer, webProperties.getAppApi());
//        添加open 的api
        configurePathMatch(configurer,webProperties.getOpenApi());
    }
```

#### 步骤3：YudaoSwaggerAutoConfiguration添加API分组配置

```
public static GroupedOpenApi buildGroupedOpenApi(String group, String path) {
        return GroupedOpenApi.builder()
                .group(group)
                .pathsToMatch("/admin-api/" + path + "/**", "/app-api/" + path + "/**" ,"/open-api/" + path + "/**")
                .addOperationCustomizer((operation, handlerMethod) -> operation
                        .addParametersItem(buildTenantHeaderParameter())
                        .addParametersItem(buildSecurityHeaderParameter()))
                .build();
    }
```



#### 步骤 4：ApiRequestFilter过滤器配置

```java
@RequiredArgsConstructor
public abstract class ApiRequestFilter extends OncePerRequestFilter {

    protected final WebProperties webProperties;

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        // 只过滤 API 请求的地址
        String apiUri = request.getRequestURI().substring(request.getContextPath().length());
        return !StrUtil.startWithAny(apiUri, webProperties.getAdminApi().getPrefix(), webProperties.getAppApi().getPrefix(),webProperties.getOpenApi().getPrefix());
    }
```

### Demo 模块中的实现

在 `yudao-module-demo` 中，`DemoOpenTestController` 就是按照上述方式创建的自定义 API 前缀示例：

```java
@Tag(name = "新建Openapi模块 - Test")
@RestController
@RequestMapping("/demo/test")
@Validated
public class DemoOpenTestController {
    // 实际访问路径：/open-api/demo/test/get
}
```

---

如果是新的话，就在controller下面新建与配置中对应的包（**.controller.open.**），然后写API就可以了

## 🎨 API 类型详解

### API 路径规则

| API 类型 | 路径前缀 | 包路径 | 用途 | 权限要求 |
|---------|---------|--------|------|---------|
| Admin API | `/admin-api` | `controller.admin` | 后台管理 | 管理员权限 |
| App API | `/app-api` | `controller.app` | 用户端 | 用户登录 |
| 自定义 API | `/open-api` | `controller.open` | 自定义前缀示例 | 可自定义 |

> **注意**：`/open-api` 在此 Demo 中是自定义 API 前缀的示例，实际项目中可以根据需要创建任意前缀。

### 权限配置

#### Admin API 权限

```java
@PreAuthorize("@ss.hasPermission('yourmodule:data:query')")
@GetMapping("/list")
public CommonResult<List<YourDataRespVO>> getDataList() {
    // 需要特定权限才能访问
}
```

#### App API 权限

```java
@GetMapping("/profile")
public CommonResult<UserProfileRespVO> getUserProfile() {
    // 需要用户登录，自动获取当前用户信息
    Long userId = SecurityFrameworkUtils.getLoginUserId();
    // ...
}
```

#### 自定义 API 权限

```java
@GetMapping("/custom-data")
public CommonResult<CustomDataRespVO> getCustomData() {
    // 可以根据需要自定义权限控制
    // 例如：API Key 验证、特定角色验证等
    return success(data);
}
```

### Swagger 文档配置

#### 分组配置

```java
// Admin API
@Tag(name = "后台管理 - 你的模块")

// App API  
@Tag(name = "用户 App - 你的模块")

// 自定义 API
@Tag(name = "自定义接口 - 你的模块")
```

#### 接口文档

```java
@Operation(summary = "创建数据", description = "创建一条新的数据记录")
@Parameter(name = "id", description = "数据ID", required = true, example = "1")
public CommonResult<Long> createData(@Valid @RequestBody DataCreateReqVO createReqVO) {
    // ...
}
```

---

## ⚙️ 模块集成配置

### 依赖管理

#### 基础依赖

```xml
<!-- Web 相关 -->
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-spring-boot-starter-web</artifactId>
</dependency>

<!-- 数据库相关 -->
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-spring-boot-starter-mybatis</artifactId>
</dependency>

<!-- 安全相关 -->
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-spring-boot-starter-security</artifactId>
</dependency>
```

#### 可选依赖

```xml
<!-- Redis 缓存 -->
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-spring-boot-starter-redis</artifactId>
</dependency>

<!-- 消息队列 -->
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-spring-boot-starter-mq</artifactId>
</dependency>

<!-- 文件存储 -->
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-spring-boot-starter-file</artifactId>
</dependency>
```

### 配置文件

#### application.yml

```yaml
# 模块特定配置
yudao:
  yourmodule:
    enabled: true
    config-value: "your-config"
```

#### 数据库配置

```sql
-- 创建模块相关表
CREATE TABLE `your_module_data` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `name` varchar(100) NOT NULL COMMENT '名称',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB COMMENT='你的模块数据表';
```

---

## 💡 最佳实践

### 1. 命名规范

#### 包命名

```
cn.iocoder.yudao.module.{模块名}.{层级}
```

#### 类命名

```java
// Controller
{模块名}Controller.java
App{模块名}Controller.java
{模块名}OpenController.java

// Service
{模块名}Service.java
{模块名}ServiceImpl.java

// DO/VO
{模块名}DO.java
{模块名}RespVO.java
{模块名}SaveReqVO.java
```

### 2. 模块设计原则

#### 单一职责

```java
// ✅ 好的设计：每个模块专注一个业务领域
yudao-module-user     // 用户管理
yudao-module-order    // 订单管理
yudao-module-product  // 商品管理

// ❌ 不好的设计：模块职责不清
yudao-module-business // 太宽泛
```

#### 接口隔离

```java
// ✅ 按使用场景分离接口
@RestController
@RequestMapping("/admin/user")  // 管理员用户管理
class AdminUserController {}

@RestController  
@RequestMapping("/app/user")    // 用户自己的信息管理
class AppUserController {}
```

### 3. 安全考虑

#### 权限控制

```java
// Admin API - 细粒度权限
@PreAuthorize("@ss.hasPermission('system:user:create')")
public CommonResult<Long> createUser() {}

// App API - 用户身份验证
public CommonResult<UserInfoRespVO> getUserInfo() {
    Long userId = SecurityFrameworkUtils.getLoginUserId();
    // 只能访问自己的信息
}

// Open API - 限流和签名验证
@RateLimiter(name = "openapi", fallbackMethod = "fallback")
public CommonResult<String> openApiMethod() {}
```

#### 数据隔离

```java
// 多租户数据隔离
@TenantIgnore  // 忽略租户隔离的表
public class GlobalConfigDO {}

// 自动应用租户隔离
public class UserDataDO extends BaseDO {}
```

### 4. 性能优化

#### 缓存使用

```java
@Cacheable(value = "yourmodule:data", key = "#id")
public YourDataDO getData(Long id) {
    return dataMapper.selectById(id);
}
```

#### 异步处理

```java
@Async
public void processDataAsync(Long dataId) {
    // 异步处理耗时操作
}
```

### 5. 监控和日志

#### 操作日志

```java
@OperateLog(type = EXPORT)
@GetMapping("/export")
public void exportData() {
    // 自动记录导出操作
}
```

#### 业务监控

```java
@Component
public class YourModuleMetrics {
    
    @EventListener
    public void handleDataCreated(DataCreatedEvent event) {
        // 记录业务指标
        meterRegistry.counter("yourmodule.data.created").increment();
    }
}
```

## 🎉 总结

通过 `yudao-module-demo` 实验性示例模块，我们学习了：

### ✅ 核心知识点

1. **模块化架构**：独立的 Maven 模块，按需加载
2. **API 类型扩展**：Admin、App 基础类型 + 自定义 API 前缀
3. **标准目录结构**：controller、service、dal 分层设计
4. **集成配置**：pom.xml 依赖管理和模块注册

### 🚀 实践能力

1. **创建新模块**：从零开始创建自定义业务模块
2. **设计 API**：根据使用场景选择合适的 API 类型
3. **自定义前缀**：创建符合业务需求的 API 前缀
4. **权限控制**：实现细粒度的权限管理
5. **文档生成**：自动生成 Swagger API 文档

### 💡 设计思想

1. **模块独立**：每个模块都是独立可部署的单元
2. **职责分离**：不同类型的 API 承担不同职责
3. **灵活扩展**：支持自定义 API 前缀，满足多样化需求
4. **统一规范**：遵循框架的命名和结构规范
5. **实验驱动**：通过 Demo 模块验证新功能和设计

### 🧪 Demo 模块的价值

`yudao-module-demo` 作为实验性模块，展示了：

1. **如何创建新模块**：完整的创建流程和配置
2. **如何扩展 API 类型**：自定义 API 前缀的实现方式
3. **如何验证功能**：通过简单的测试接口验证模块是否正常工作
4. **如何遵循规范**：标准的目录结构和命名规范

现在你已经掌握了芋道框架的模块化开发方式，可以根据业务需求创建自己的模块，甚至扩展出新的 API 类型！🎯
