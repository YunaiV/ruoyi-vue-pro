# é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº²

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

åŸºäºèŠ‹é“å¼€æºæ¡†æ¶å¼€å‘çš„é€‰ç…¤å‚æ™ºèƒ½ç”Ÿäº§ç®¡æ§ç³»ç»Ÿï¼Œå®ç°ç”Ÿäº§è°ƒåº¦ã€è®¾å¤‡ç®¡ç†ã€ç…¤è´¨ç®¡ç†ã€å®‰å…¨ç®¡ç†ç­‰å…¨æµç¨‹æ•°å­—åŒ–ç®¡ç†ã€‚ç³»ç»Ÿé‡‡ç”¨æ ‡å‡†æ•°æ®åº“è®¾è®¡ï¼Œæ•°æ®æ ‡å‡†æŒ‡å¯¼åç»­å„ç§é€‰ç…¤æ™ºèƒ½åŒ–æ–°æŠ€æœ¯å¼€å‘ï¼Œç¡®ä¿é€‰ç…¤ä¿¡æ¯"ä¸€æ¬¡è¾“å…¥ï¼Œå…¨å±€å…±äº«"ï¼Œæé«˜æ•°æ®çš„çœŸå®æ€§å’Œå”¯ä¸€æ€§ã€‚

### æŠ€æœ¯æ¶æ„
- **åç«¯**ï¼šSpring Boot + MyBatis-Plus + SQL Server
- **å‰ç«¯**ï¼šVue 3 + TypeScript + Element Plus
- **æ¡†æ¶**ï¼šèŠ‹é“å¼€æºæ¡†æ¶ (ruoyi-vue-pro)
- **æ•°æ®åº“**ï¼šMySQL 8.0+ï¼ˆæ”¯æŒJSONæ•°æ®ç±»å‹ï¼Œå­˜å‚¨åŠç»“æ„åŒ–æ•°æ®ï¼‰
- **éƒ¨ç½²**ï¼šDocker + Nginx
- **é›†æˆ**ï¼šPLCæ•°æ®é‡‡é›†ã€OPC UAã€MQTTåè®®æ”¯æŒ

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ¨¡å—åˆ’åˆ†

```
yudao-module-coal/                    # é€‰ç…¤å‚æ ¸å¿ƒæ¨¡å—
â”œâ”€â”€ production/                       # ç”Ÿäº§è°ƒåº¦ç®¡ç†
â”œâ”€â”€ equipment/                        # è®¾å¤‡æ¡£æ¡ˆç®¡ç†  
â”œâ”€â”€ quality/                          # ç…¤è´¨ç®¡ç†
â”œâ”€â”€ safety/                          # å®‰å…¨ç®¡ç†
â”œâ”€â”€ energy/                          # èƒ½æºç®¡ç†
â”œâ”€â”€ report/                          # æŠ¥è¡¨ç»Ÿè®¡
â””â”€â”€ common/                          # å…¬å…±ç»„ä»¶
```

### æ•°æ®åº“è®¾è®¡åŸåˆ™
- é‡‡ç”¨ MySQL 8.0+ æ•°æ®åº“ï¼Œæ”¯æŒJSONæ•°æ®ç±»å‹å­˜å‚¨åŠç»“æ„åŒ–æ•°æ®
- éµå¾ªç¬¬ä¸‰èŒƒå¼è®¾è®¡ï¼Œç¡®ä¿æ•°æ®æ ‡å‡†åŒ–
- æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„ï¼Œæ•°æ®éš”ç¦»å®‰å…¨
- é¢„ç•™æ‰©å±•å­—æ®µï¼Œæ”¯æŒåç»­åŠŸèƒ½æ‰©å±•
- å»ºç«‹å®Œæ•´çš„ç´¢å¼•ä½“ç³»ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- æ•°æ®æ ‡å‡†ç»Ÿä¸€ï¼Œæ”¯æŒ"ä¸€æ¬¡è¾“å…¥ï¼Œå…¨å±€å…±äº«"

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡è¯¦è§£

### 1. ç”Ÿäº§è°ƒåº¦ç®¡ç†æ¨¡å—

#### 1.1 ç”Ÿäº§è®¡åˆ’è¡¨ (coal_production_plan) - æ ‘è¡¨ç»“æ„
```sql
DROP TABLE IF EXISTS `coal_production_plan`;
CREATE TABLE `coal_production_plan` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'è®¡åˆ’ID',
    `name` VARCHAR(100) NOT NULL COMMENT 'è®¡åˆ’åç§°',
    `parent_id` BIGINT NOT NULL DEFAULT 0 COMMENT 'çˆ¶è®¡åˆ’ID',
    `sort` INT NOT NULL DEFAULT 0 COMMENT 'æ˜¾ç¤ºé¡ºåº',
    `plan_code` VARCHAR(50) NOT NULL DEFAULT '' COMMENT 'è®¡åˆ’ç¼–å·',
    `plan_type` TINYINT NOT NULL COMMENT 'è®¡åˆ’ç±»å‹ï¼š1å¹´åº¦ 2æœˆåº¦ 3æ—¥è®¡åˆ’ 4ç­è®¡åˆ’',
    `plan_year` INT NULL COMMENT 'è®¡åˆ’å¹´åº¦',
    `plan_month` TINYINT NULL COMMENT 'è®¡åˆ’æœˆä»½',
    `plan_date` DATE NULL COMMENT 'è®¡åˆ’æ—¥æœŸ',
    `shift_id` BIGINT NULL COMMENT 'ç­æ¬¡ID',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT 'è®¡åˆ’çŠ¶æ€ï¼š0åœç”¨ 1æ­£å¸¸',
    plan_path VARCHAR(500) COMMENT 'è®¡åˆ’å±‚çº§è·¯å¾„ï¼ˆå¦‚ï¼š1/2/3è¡¨ç¤ºå¹´/æœˆ/æ—¥ï¼‰',

    -- è®¡åˆ’äº§é‡æ•°æ®ï¼ˆåŸºç¡€ï¼‰
    `raw_coal_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’å…¥æ´—åŸç…¤é‡(å¨)',

    -- ç²¾ç…¤äº§é‡è®¡åˆ’ï¼ˆæŒ‰ç²’åº¦åˆ†ç±»ï¼‰
    `fine_coal_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’æœ«ç…¤äº§é‡(å¨)',
    `granular_coal_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’ç²’ç…¤äº§é‡(å¨)',
    `large_block_coal_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’å¤§å—ç…¤äº§é‡(å¨)',
    `medium_block_coal_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’ä¸­å—ç…¤äº§é‡(å¨)',
    `small_block_coal_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’å°å—ç…¤äº§é‡(å¨)',

    -- å…¶ä»–äº§å“è®¡åˆ’äº§é‡
    `middling_coal_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’ä¸­ç…¤äº§é‡(å¨)',
    `slime_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’ç…¤æ³¥äº§é‡(å¨)',
    `gangue_plan` DECIMAL(10,2) NULL COMMENT 'è®¡åˆ’çŸ¸çŸ³äº§é‡(å¨)',

    -- é¢„ç•™è®¡åˆ’äº§é‡å­—æ®µ
    `reserved_product_plan1` DECIMAL(10,2) NULL COMMENT 'é¢„ç•™è®¡åˆ’äº§é‡å­—æ®µ1(å¨)',
    `reserved_product_plan2` DECIMAL(10,2) NULL COMMENT 'é¢„ç•™è®¡åˆ’äº§é‡å­—æ®µ2(å¨)',

    -- è´¨é‡æŒ‡æ ‡
    `fine_coal_ash` DECIMAL(5,2) NULL COMMENT 'æœ«ç…¤ç°åˆ†(%)',
    `granular_coal_ash` DECIMAL(5,2) NULL COMMENT 'ç²’ç…¤ç°åˆ†(%)',
    `large_block_coal_ash` DECIMAL(5,2) NULL COMMENT 'å¤§å—ç…¤ç°åˆ†(%)',
    `medium_block_coal_ash` DECIMAL(5,2) NULL COMMENT 'ä¸­å—ç…¤ç°åˆ†(%)',
    `small_block_coal_ash` DECIMAL(5,2) NULL COMMENT 'å°å—ç…¤ç°åˆ†(%)',
    `middling_coal_ash` DECIMAL(5,2) NULL COMMENT 'ä¸­ç…¤ç°åˆ†(%)',

    -- å®¡æ‰¹ä¿¡æ¯
    `creator_id` BIGINT NULL COMMENT 'åˆ¶å®šäººID',
    `approver_id` BIGINT NULL COMMENT 'å®¡æ‰¹äººID',
    `approve_time` DATETIME NULL COMMENT 'å®¡æ‰¹æ—¶é—´',

    -- åŸºç¡€å­—æ®µï¼ˆèŠ‹é“æ¡†æ¶æ ‡å‡†ï¼‰
    `creator` VARCHAR(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT '' COMMENT 'åˆ›å»ºè€…',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updater` VARCHAR(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT '' COMMENT 'æ›´æ–°è€…',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT 'æ˜¯å¦åˆ é™¤',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT 'ç§Ÿæˆ·ç¼–å·',
    PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = 'ç”Ÿäº§è®¡åˆ’è¡¨ï¼ˆæ ‘è¡¨ç»“æ„ï¼‰';
```



å…¶ä¸­ç”¨åˆ°çš„å­—å…¸ï¼šè®¡åˆ’å±‚çº§å’Œè®¡åˆ’çŠ¶æ€ã€‚

![image-20250820160535987](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250820160535987.png)

![](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250820160550262.png)

```sql

INSERT INTO `ruoyi-vue-pro`.system_dict_type
(id, name, `type`, status, remark, creator, create_time, updater, update_time, deleted, deleted_time)
VALUES(2000, 'è®¡åˆ’å±‚çº§', 'plan_level', 0, 'ç”Ÿäº§è®¡åˆ’å±‚çº§', '1', '2025-08-20 16:01:18', '1', '2025-08-20 16:01:18', 0, '1970-01-01 00:00:00');
INSERT INTO `ruoyi-vue-pro`.system_dict_type
(id, name, `type`, status, remark, creator, create_time, updater, update_time, deleted, deleted_time)
VALUES(2001, 'è®¡åˆ’çŠ¶æ€', 'plan_status', 0, '', '1', '2025-08-20 16:04:06', '1', '2025-08-20 16:04:06', 0, '1970-01-01 00:00:00');



INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3003, 0, 'å¹´åº¦', '1', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:01:49', '1', '2025-08-20 16:01:49', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3004, 2, 'æœˆåº¦', '2', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:03', '1', '2025-08-20 16:02:03', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3005, 3, 'æ—¥è®¡åˆ’', '3', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:18', '1', '2025-08-20 16:02:18', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3006, 4, 'ç­è®¡åˆ’', '4', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:26', '1', '2025-08-20 16:06:31', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3007, 1, 'å¾…å®Œæˆ', '1', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:28', '1', '2025-08-20 16:04:28', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3008, 2, 'æ‰§è¡Œä¸­', '2', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:39', '1', '2025-08-20 16:04:39', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3009, 3, 'å·²å®Œæˆ', '3', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:47', '1', '2025-08-20 16:04:47', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3010, 4, 'å·²å–æ¶ˆ', '4', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:53', '1', '2025-08-20 16:04:53', 0);
```

##### æ–°å¢ä¸€é”®ç”Ÿæˆå¹´åº¦è®¡åˆ’è¡¨å’Œåˆ é™¤å¹´åº¦è¡¨

###### controller

```java
    @PostMapping("/generate-yearly-plan")
    @Operation(summary = "ä¸€é”®ç”Ÿæˆå¹´åº¦è®¡åˆ’")
    @PreAuthorize("@ss.hasPermission('coal:production-plan:create')")
    public CommonResult<Boolean> generateYearlyPlan(@Valid @RequestBody ProductionPlanSaveReqVO createReqVO) {
        productionPlanService.generateYearlyPlan(createReqVO);
        return success(true);
    }

    @DeleteMapping("/delete-by-year")
    @Operation(summary = "ä¸€é”®åˆ é™¤å¹´åº¦è®¡åˆ’")
    @Parameter(name = "year", description = "å¹´ä»½", required = true, example = "2025")
    @PreAuthorize("@ss.hasPermission('coal:production-plan:delete')")
    public CommonResult<Boolean> deleteProductionPlanByYear(@RequestParam("year") Integer year) {
        productionPlanService.deleteProductionPlanByYear(year);
        return success(true);
    }
    @DeleteMapping("/physical-delete-by-year")
        @Operation(summary = "ç‰©ç†åˆ é™¤å¹´åº¦è®¡åˆ’ï¼ˆè°ƒè¯•ç”¨ï¼‰")
        @Parameter(name = "year", description = "å¹´ä»½", required = true, example = "2025")
        @PreAuthorize("@ss.hasPermission('coal:production-plan:delete')") // æ³¨æ„ï¼šæƒé™ä¿æŒä¸€è‡´
        public CommonResult<Boolean> physicalDeleteProductionPlanByYear(@RequestParam("year") Integer year) {
            productionPlanService.physicalDeleteProductionPlanByYear(year);
            return success(true);
        }
```





###### mapper

```java
    default void deleteByYear(Integer year) {
            delete(new LambdaQueryWrapperX<ProductionPlanDO>()
                    .eq(ProductionPlanDO::getPlanYear, year));
        }

    @Delete("DELETE FROM coal_production_plan WHERE plan_year = #{year}")
    void physicalDeleteByYear(@Param("year") Integer year);
```





###### service

```java
	 /**
     * ä¸€é”®ç”Ÿæˆå¹´åº¦è®¡åˆ’
     *
     * @param createReqVO å¹´åº¦è®¡åˆ’ä¿¡æ¯
     */
    void generateYearlyPlan(@Valid ProductionPlanSaveReqVO createReqVO);

    /**
     * æ ¹æ®å¹´ä»½åˆ é™¤ç”Ÿäº§è®¡åˆ’
     *
     * @param year å¹´ä»½
     */
    void deleteProductionPlanByYear(Integer year);

    /**
     * æ ¹æ®å¹´ä»½ç‰©ç†åˆ é™¤ç”Ÿäº§è®¡åˆ’ï¼ˆè°ƒè¯•ç”¨ï¼‰
     *
     * @param year å¹´ä»½
     */
    void physicalDeleteProductionPlanByYear(Integer year);
```







###### serviceImp

```java
@Override
    @Transactional
    public void generateYearlyPlan(ProductionPlanSaveReqVO createReqVO) {
        // 1. æ’å…¥å¹´åº¦è®¡åˆ’
        ProductionPlanDO yearPlan = BeanUtils.toBean(createReqVO, ProductionPlanDO.class);
        yearPlan.setPlanYear(createReqVO.getPlanYear()); // æ˜¾å¼è®¾ç½®å¹´ä»½ï¼Œç¡®ä¿ä¿å­˜
        productionPlanMapper.insert(yearPlan); // æ’å…¥æ•°æ®åº“ï¼Œä¸ºäº†è·å¾— id

        // 2. æ‰¹é‡æ’å…¥åç»­è®¡åˆ’
        List<ProductionPlanDO> batchList = new ArrayList<>();

        // 2.1 ç”Ÿæˆæœˆåº¦è®¡åˆ’
        for (int i = 1; i <= 12; i++) {
            ProductionPlanDO monthPlan = generateSubPlan(yearPlan, yearPlan.getId(), i + "æœˆ", 12, 2); // planType = 2
            monthPlan.setPlanMonth(i);
            productionPlanMapper.insert(monthPlan); // æ’å…¥æ•°æ®åº“ï¼Œä¸ºäº†è·å¾— id

            // 2.2 ç”Ÿæˆæ—¥è®¡åˆ’
            int daysInMonth = java.time.YearMonth.of(yearPlan.getPlanYear(), i).lengthOfMonth();
            for (int j = 1; j <= daysInMonth; j++) {
                // æ³¨æ„ï¼šé™¤æ•°ä½¿ç”¨è¯¥æœˆçš„å®é™…å¤©æ•°ï¼Œä¿è¯æ—¥è®¡åˆ’åˆè®¡çº¦ç­‰äºæœˆè®¡åˆ’
                ProductionPlanDO dayPlan = generateSubPlan(monthPlan, monthPlan.getId(), j + "æ—¥", daysInMonth, 3); // planType = 3
                dayPlan.setPlanDate(LocalDate.of(yearPlan.getPlanYear(), monthPlan.getPlanMonth(), j));
                productionPlanMapper.insert(dayPlan); // æ’å…¥æ•°æ®åº“ï¼Œä¸ºäº†è·å¾— id

                // 2.3 ç”Ÿæˆç­æ¬¡è®¡åˆ’
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "æ—©ç­", 3, 4)); // planType = 4
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "ä¸­ç­", 3, 4)); // planType = 4
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "æ™šç­", 3, 4)); // planType = 4
            }
        }

        // æ‰¹é‡æ’å…¥æ‰€æœ‰ç­æ¬¡è®¡åˆ’
        for (ProductionPlanDO plan : batchList) {
            productionPlanMapper.insert(plan);
        }
    }
	/**
     * ç”Ÿæˆå­è®¡åˆ’
     *
     * @param parentPlan çˆ¶è®¡åˆ’
     * @param parentId çˆ¶è®¡åˆ’ç¼–å·
     * @param name è®¡åˆ’åç§°
     * @param subMultiple å­è®¡åˆ’çš„æ‹†åˆ†å€æ•°
     * @param planType è®¡åˆ’ç±»å‹
     * @return å­è®¡åˆ’
     */
    private ProductionPlanDO generateSubPlan(ProductionPlanDO parentPlan, Long parentId, String name, int subMultiple, Integer planType) {
        ProductionPlanDO subPlan = new ProductionPlanDO();
        subPlan.setName(parentPlan.getName() + "-" + name);
        subPlan.setParentId(parentId);
        subPlan.setPlanType(planType);
        subPlan.setStatus(parentPlan.getStatus());
        subPlan.setPlanYear(parentPlan.getPlanYear()); // ç»§æ‰¿çˆ¶è®¡åˆ’çš„å¹´ä»½

        // å°†â€œé‡â€ç›¸å…³çš„å­—æ®µï¼Œè¿›è¡Œé™¤æ³•
        subPlan.setRawCoalPlan(parentPlan.getRawCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setFineCoalPlan(parentPlan.getFineCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setGranularCoalPlan(parentPlan.getGranularCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setLargeBlockCoalPlan(parentPlan.getLargeBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setMediumBlockCoalPlan(parentPlan.getMediumBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setSmallBlockCoalPlan(parentPlan.getSmallBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setMiddlingCoalPlan(parentPlan.getMiddlingCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setSlimePlan(parentPlan.getSlimePlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setGanguePlan(parentPlan.getGanguePlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));

        // å°†â€œç°åˆ†â€ç›¸å…³çš„å­—æ®µï¼Œç›´æ¥å¤åˆ¶
        subPlan.setFineCoalAsh(parentPlan.getFineCoalAsh());
        subPlan.setGranularCoalAsh(parentPlan.getGranularCoalAsh());
        subPlan.setLargeBlockCoalAsh(parentPlan.getLargeBlockCoalAsh());
        subPlan.setMediumBlockCoalAsh(parentPlan.getMediumBlockCoalAsh());
        subPlan.setSmallBlockCoalAsh(parentPlan.getSmallBlockCoalAsh());
        subPlan.setMiddlingCoalAsh(parentPlan.getMiddlingCoalAsh());
        return subPlan;
    }

    @Override
    public void deleteProductionPlanByYear(Integer year) {
        productionPlanMapper.deleteByYear(year);
    }
    @Override
    public void physicalDeleteProductionPlanByYear(Integer year) {
        productionPlanMapper.physicalDeleteByYear(year);
    } 
```







###### å‰ç«¯

æ·»åŠ æç¤ºæ¡†

```vue
	<el-alert
      title="æœç´¢æç¤ºï¼šå¯¹äºâ€œä¸€é”®ç”Ÿæˆâ€çš„è®¡åˆ’ï¼Œå»ºè®®ä½¿ç”¨â€œè®¡åˆ’åç§°â€è¿›è¡Œç²¾ç¡®æœç´¢ã€‚æœç´¢æ ¼å¼ç¤ºä¾‹ï¼š'2025å¹´-12æœˆ-31æ—¥-æ™šç­' æˆ– '2025å¹´-12æœˆ-31æ—¥'ã€‚"
      type="success"
      show-icon
      :closable="true"
      style="margin-bottom: 20px; border:1px green solid;"
    />
```



æ·»åŠ ä¸¤ä¸ªæŒ‰é’®

```vue
		<el-button
          type="primary"
          @click="openForm('generate')"
          v-hasPermi="['coal:production-plan:create']"
        >
          <Icon icon="ep:plus" class="mr-5px" /> ä¸€é”®ç”Ÿæˆå¹´åº¦è®¡åˆ’
        </el-button>
        <el-button
          type="danger"
          plain
          @click="handleDeleteByYear"
          v-hasPermi="['coal:production-plan:delete']"
        >
          <Icon icon="ep:delete" class="mr-5px" /> æŒ‰å¹´åˆ é™¤
        </el-button>
```





å› ä¸ºä¸€é”®ç”Ÿæˆå¹´åº¦è®¡åˆ’é‡Œé¢ï¼Œéœ€è¦å¡«å†™å¹´åº¦è®¡åˆ’ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å¼•ç”¨æ–°å¢æˆ–ä¿®æ”¹çš„è¡¨æ ¼ï¼Œä¹Ÿå°±æ˜¯ProductionPlanForm.vueã€‚æ‰€ä»¥ç›´æ¥æ·»åŠ ä¸€ä¸ªgenerateæ ‡è¯†ä¸ºç”Ÿæˆçš„ï¼Œå¯¹åº”çš„æ˜¯è¿™é‡Œï¼š

![image-20250825113053844](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825113053844.png)



æ‰“å¼€å¼¹çª—çš„ProductionPlanForm.vueåï¼Œåˆ¤æ–­æ˜¯ç”Ÿæˆçš„æ—¶å€™è‡ªåŠ¨å¡«å†™å¹´åº¦è®¡åˆ’å’Œé¡¶çº§ID

```vue
// ä¸€é”®ç”Ÿæˆå¹´åº¦è®¡åˆ’æ—¶ï¼Œè®¾ç½®é»˜è®¤å€¼
  if (type === 'generate') {
    formData.value.planType = 1 // 1 ä»£è¡¨å¹´åº¦è®¡åˆ’
    formData.value.parentId = 0 // 0 ä»£è¡¨é¡¶çº§
  }
```





æäº¤æ˜¯æ‰§è¡ŒgenerationYearPlanæ–¹æ³•

```ts
if (formType.value === 'generate') {
      await ProductionPlanApi.generateYearlyPlan(data)
      message.success('ä¸€é”®ç”Ÿæˆå¹´åº¦è®¡åˆ’æˆåŠŸ')
```





```TS
// TSä»£ç 

// ä¸€é”®ç”Ÿæˆå¹´åº¦è®¡åˆ’
  generateYearlyPlan: async (data: ProductionPlan) => {
    return await request.post({ url: `/coal/production-plan/generate-yearly-plan`, data })
  },

  // æŒ‰å¹´ä»½åˆ é™¤ç”Ÿäº§è®¡åˆ’
  deleteProductionPlanByYear: async (year: number) => {
    return await request.delete({ url: `/coal/production-plan/delete-by-year?year=` + year })
  },
```



å¯¹äºåˆ é™¤é€»è¾‘å°±æ˜¯ä¼ é€’å¹´ä»½ç„¶åæ‰§è¡Œdelete-by-yearæ–¹æ³•

```ts
/** æŒ‰å¹´ä»½åˆ é™¤æŒ‰é’®æ“ä½œ */
const handleDeleteByYear = async () => {
  try {
    const { value } = await ElMessageBox.prompt('è¯·è¾“å…¥è¦åˆ é™¤çš„å¹´ä»½', 'æç¤º', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      inputPattern: /^\d{4}$/,
      inputErrorMessage: 'è¯·è¾“å…¥æœ‰æ•ˆçš„å››ä½å¹´ä»½'
    })
    if (value) {
      await message.delConfirm('ç¡®è®¤è¦åˆ é™¤ ' + value + ' å¹´çš„æ‰€æœ‰è®¡åˆ’æ•°æ®å—ï¼Ÿ')
      await ProductionPlanApi.deleteProductionPlanByYear(Number(value))
      message.success(t('common.delSuccess'))
      await getList()
    }
  } catch {}
}
```





###### è°ƒè¯•

![image-20250825112725106](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825112725106.png)

**ç”Ÿæˆå¹´åº¦è®¡åˆ’ï¼š**



![image-20250825143905527](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143905527.png)

![image-20250825143920623](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143920623.png)



![image-20250825143927935](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143927935.png)**åˆ é™¤ï¼š**

![image-20250825143414516](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143414516.png)

![image-20250825143420016](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143420016.png)

æ•°æ®åº“ä¸­ä¸æ˜¯çœŸçš„åˆ é™¤ï¼Œè€Œæ˜¯é€»è¾‘åˆ é™¤ã€‚

![image-20250825143450111](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143450111.png)

å¦‚æœè¦ç‰©ç†åˆ é™¤ï¼Œä½¿ç”¨http://127.0.0.1:48080/doc.html#/all/%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%20-%20%E7%94%9F%E4%BA%A7%E8%AE%A1%E5%88%92/physicalDeleteProductionPlanByYear

è¿›è¡Œç‰©ç†åˆ é™¤ã€‚



![image-20250825143524687](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143524687.png)

![image-20250825143531790](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143531790.png)

![image-20250825143537521](D:\code\ruoyi-vue-pro\learn\é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿå¼€å‘å¤§çº².assets\image-20250825143537521.png)















#### 1.2 ç°åœºç”Ÿäº§æ—¥æŠ¥è¡¨ (coal_production_daily_report)

```sql
CREATE TABLE coal_production_daily_report (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    report_date DATE NOT NULL COMMENT 'æ—¥æœŸ',
    shift_id BIGINT NOT NULL COMMENT 'ç­æ¬¡ID',

    -- äººå‘˜ä¿¡æ¯
    operator_id BIGINT COMMENT 'é›†æ§å‘˜ï¼ˆæ“ä½œäººï¼‰ID',
    shift_leader_id BIGINT COMMENT 'å¸¦ç­ä¸»ä»»/ç­é•¿ID',

    -- æ—¶é—´è®°å½•
    start_time TIME COMMENT 'å¯è½¦æ—¶é—´',
    coal_feeding_time INT COMMENT 'å¸¦ç…¤æ—¶é—´(åˆ†é’Ÿ)',
    stop_time TIME COMMENT 'åœè½¦æ—¶é—´',
    effective_feeding_time INT COMMENT 'æœ‰æ•ˆå¸¦ç…¤æ—¶é—´(åˆ†é’Ÿ)',
    fault_impact_time INT COMMENT 'æ•…éšœå½±å“æ—¶é—´(åˆ†é’Ÿ)',

    -- äº§é‡æ•°æ®
    raw_coal_input DECIMAL(10,2) COMMENT 'å…¥æ´—ç…¤é‡(å¨)',
    hourly_capacity DECIMAL(8,2) COMMENT 'å°æ—¶å¤„ç†é‡(å¨/å°æ—¶)',
    block_clean_coal_output DECIMAL(10,2) COMMENT 'å—ç²¾ç…¤äº§é‡(å¨)',
    fine_clean_coal_output DECIMAL(10,2) COMMENT 'æœ«ç²¾ç…¤äº§é‡(å¨)',
    gangue_output DECIMAL(10,2) COMMENT 'çŸ¸çŸ³äº§é‡(å¨)',
    middling_coal_output DECIMAL(10,2) COMMENT 'ä¸­ç…¤äº§é‡(å¨)',

    -- å‹æ»¤ç›¸å…³
    filter_press_cycles INT COMMENT 'å‹æ»¤æ¿æ¬¡',
    filter_press_coal_amount DECIMAL(8,2) COMMENT 'å‹æ»¤ç…¤é‡(å¨)',
    filter_cloth_usage INT COMMENT 'æ»¤å¸ƒä½¿ç”¨é‡(å¼ )',

    -- æ”¾èˆ±è®°å½•
    discharge_record VARCHAR(500) COMMENT 'æ”¾èˆ±è®°å½•',

    -- ä»‹è´¨æ·»åŠ 
    baffle_medium_addition DECIMAL(8,2) COMMENT 'æŒ¡æ¿æ·»åŠ ä»‹è´¨é‡(kg)',
    cao_amount DECIMAL(8,2) COMMENT 'CaOé‡(kg)',
    flocculant_amount DECIMAL(8,2) COMMENT 'çµ®å‡å‰‚(kg)',
    density_317 DECIMAL(5,2) COMMENT '317å¯†åº¦(kg/L)',

    -- ç¬¬ä¸€æ¬¡ç°åˆ†æ£€æµ‹å†…å®¹
    first_ash_block_clean DECIMAL(5,2) COMMENT 'ç¬¬ä¸€æ¬¡å—ç²¾ç…¤ç°åˆ†(%)',
    first_ash_fine_clean DECIMAL(5,2) COMMENT 'ç¬¬ä¸€æ¬¡æœ«ç²¾ç…¤ç°åˆ†(%)',
    first_ash_middling DECIMAL(5,2) COMMENT 'ç¬¬ä¸€æ¬¡ä¸­ç…¤ç°åˆ†(%)',
    first_ash_slime DECIMAL(5,2) COMMENT 'ç¬¬ä¸€æ¬¡ç…¤æ³¥ç°åˆ†(%)',
    first_ash_gangue DECIMAL(5,2) COMMENT 'ç¬¬ä¸€æ¬¡çŸ¸çŸ³ç°åˆ†(%)',

    -- ç¬¬äºŒæ¬¡ç°åˆ†æ£€æµ‹å†…å®¹
    second_ash_block_clean DECIMAL(5,2) COMMENT 'ç¬¬äºŒæ¬¡å—ç²¾ç…¤ç°åˆ†(%)',
    second_ash_fine_clean DECIMAL(5,2) COMMENT 'ç¬¬äºŒæ¬¡æœ«ç²¾ç…¤ç°åˆ†(%)',
    second_ash_middling DECIMAL(5,2) COMMENT 'ç¬¬äºŒæ¬¡ä¸­ç…¤ç°åˆ†(%)',
    second_ash_slime DECIMAL(5,2) COMMENT 'ç¬¬äºŒæ¬¡ç…¤æ³¥ç°åˆ†(%)',
    second_ash_gangue DECIMAL(5,2) COMMENT 'ç¬¬äºŒæ¬¡çŸ¸çŸ³ç°åˆ†(%)',

    -- å½±å“æ—¶é—´è®°å½•
    impact_time_record TEXT COMMENT 'å½±å“æ—¶é—´è®°å½•è¯¦æƒ…',

    -- äº¤åŠäº‹é¡¹
    assigned_tasks TEXT COMMENT 'äº¤åŠäº‹é¡¹',

    -- å¯è½¦æ—¶çš„ä»“ä½å’Œæ¶²ä½
    start_circulating_water_pool DECIMAL(6,2) COMMENT 'å¯è½¦å¾ªç¯æ°´æ± æ¶²ä½',
    start_clean_water_tank DECIMAL(6,2) COMMENT 'å¯è½¦æ¸…æ°´æ¡¶æ¶²ä½',
    start_fine_coal_level DECIMAL(6,2) COMMENT 'å¯è½¦æœ«ç…¤ä»“ä½',
    start_granular_coal_level DECIMAL(6,2) COMMENT 'å¯è½¦ç²’ç…¤ä»“ä½',
    start_large_block_level DECIMAL(6,2) COMMENT 'å¯è½¦å¤§å—ä»“ä½',
    start_medium_block_level DECIMAL(6,2) COMMENT 'å¯è½¦ä¸­å—ä»“ä½',
    start_small_block_level DECIMAL(6,2) COMMENT 'å¯è½¦å°å—ä»“ä½',
    start_middling_coal_level DECIMAL(6,2) COMMENT 'å¯è½¦ä¸­ç…¤ä»“ä½',
    start_gangue_level DECIMAL(6,2) COMMENT 'å¯è½¦çŸ¸çŸ³ä»“ä½',

    -- åœè½¦æ—¶çš„ä»“ä½å’Œæ¶²ä½
    stop_circulating_water_pool DECIMAL(6,2) COMMENT 'åœè½¦å¾ªç¯æ°´æ± æ¶²ä½',
    stop_clean_water_tank DECIMAL(6,2) COMMENT 'åœè½¦æ¸…æ°´æ¡¶æ¶²ä½',
    stop_fine_coal_level DECIMAL(6,2) COMMENT 'åœè½¦æœ«ç…¤ä»“ä½',
    stop_granular_coal_level DECIMAL(6,2) COMMENT 'åœè½¦ç²’ç…¤ä»“ä½',
    stop_large_block_level DECIMAL(6,2) COMMENT 'åœè½¦å¤§å—ä»“ä½',
    stop_medium_block_level DECIMAL(6,2) COMMENT 'åœè½¦ä¸­å—ä»“ä½',
    stop_small_block_level DECIMAL(6,2) COMMENT 'åœè½¦å°å—ä»“ä½',
    stop_middling_coal_level DECIMAL(6,2) COMMENT 'åœè½¦ä¸­ç…¤ä»“ä½',
    stop_gangue_level DECIMAL(6,2) COMMENT 'åœè½¦çŸ¸çŸ³ä»“ä½',

    -- å¤‡æ³¨
    remarks TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    -- é¢„ç•™å­—æ®µï¼ˆç”¨äºåç»­æ‰©å±•æ–°å­—æ®µï¼‰
    reserved_field1 VARCHAR(200) COMMENT 'é¢„ç•™å­—æ®µ1',
    reserved_field2 VARCHAR(200) COMMENT 'é¢„ç•™å­—æ®µ2',
    reserved_field3 DECIMAL(10,2) COMMENT 'é¢„ç•™å­—æ®µ3',
    reserved_field4 DECIMAL(10,2) COMMENT 'é¢„ç•™å­—æ®µ4',
    reserved_field5 TEXT COMMENT 'é¢„ç•™å­—æ®µ5',

    -- åŸºç¡€å­—æ®µ
    creator VARCHAR(64) DEFAULT '' COMMENT 'åˆ›å»ºè€…',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updater VARCHAR(64) DEFAULT '' COMMENT 'æ›´æ–°è€…',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    deleted TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤',
    tenant_id BIGINT DEFAULT 0 COMMENT 'ç§Ÿæˆ·ID'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç°åœºç”Ÿäº§æ—¥æŠ¥è¡¨';
```

#### 1.3 è®¡åˆ’å®Œæˆç‡ç»Ÿè®¡è¡¨ (coal_plan_completion_statistics)
```sql
CREATE TABLE coal_plan_completion_statistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plan_id BIGINT NOT NULL COMMENT 'è®¡åˆ’ID',
    statistics_date DATE NOT NULL COMMENT 'ç»Ÿè®¡æ—¥æœŸ',
    statistics_type TINYINT NOT NULL COMMENT 'ç»Ÿè®¡ç±»å‹ï¼š1æ—¥ç»Ÿè®¡ 2æœˆç»Ÿè®¡ 3å¹´ç»Ÿè®¡ 4ç­ç»Ÿè®¡',

    -- è®¡åˆ’æ•°æ®
    plan_raw_coal DECIMAL(10,2),                  -- è®¡åˆ’å…¥æ´—åŸç…¤é‡(å¨)
    plan_fine_coal DECIMAL(10,2),                 -- è®¡åˆ’æœ«ç…¤äº§é‡(å¨)
    plan_granular_coal DECIMAL(10,2),             -- è®¡åˆ’ç²’ç…¤äº§é‡(å¨)
    plan_large_block_coal DECIMAL(10,2),          -- è®¡åˆ’å¤§å—ç…¤äº§é‡(å¨)
    plan_medium_block_coal DECIMAL(10,2),         -- è®¡åˆ’ä¸­å—ç…¤äº§é‡(å¨)
    plan_small_block_coal DECIMAL(10,2),          -- è®¡åˆ’å°å—ç…¤äº§é‡(å¨)
    plan_middling_coal DECIMAL(10,2),             -- è®¡åˆ’ä¸­ç…¤äº§é‡(å¨)
    plan_gangue DECIMAL(10,2),                    -- è®¡åˆ’çŸ¸çŸ³äº§é‡(å¨)

    -- å®é™…å®Œæˆæ•°æ®
    actual_raw_coal DECIMAL(10,2),                -- å®é™…å…¥æ´—åŸç…¤é‡(å¨)
    actual_fine_coal DECIMAL(10,2),               -- å®é™…æœ«ç…¤äº§é‡(å¨)
    actual_granular_coal DECIMAL(10,2),           -- å®é™…ç²’ç…¤äº§é‡(å¨)
    actual_large_block_coal DECIMAL(10,2),        -- å®é™…å¤§å—ç…¤äº§é‡(å¨)
    actual_medium_block_coal DECIMAL(10,2),       -- å®é™…ä¸­å—ç…¤äº§é‡(å¨)
    actual_small_block_coal DECIMAL(10,2),        -- å®é™…å°å—ç…¤äº§é‡(å¨)
    actual_middling_coal DECIMAL(10,2),           -- å®é™…ä¸­ç…¤äº§é‡(å¨)
    actual_gangue DECIMAL(10,2),                  -- å®é™…çŸ¸çŸ³äº§é‡(å¨)

    -- å®Œæˆç‡æ•°æ®ï¼ˆç™¾åˆ†æ¯”ï¼‰
    completion_rate_raw_coal DECIMAL(5,2),        -- å…¥æ´—åŸç…¤å®Œæˆç‡(%)
    completion_rate_fine_coal DECIMAL(5,2),       -- æœ«ç…¤å®Œæˆç‡(%)
    completion_rate_granular_coal DECIMAL(5,2),   -- ç²’ç…¤å®Œæˆç‡(%)
    completion_rate_large_block DECIMAL(5,2),     -- å¤§å—ç…¤å®Œæˆç‡(%)
    completion_rate_medium_block DECIMAL(5,2),    -- ä¸­å—ç…¤å®Œæˆç‡(%)
    completion_rate_small_block DECIMAL(5,2),     -- å°å—ç…¤å®Œæˆç‡(%)
    completion_rate_middling_coal DECIMAL(5,2),   -- ä¸­ç…¤å®Œæˆç‡(%)
    completion_rate_gangue DECIMAL(5,2),          -- çŸ¸çŸ³å®Œæˆç‡(%)

    -- æ€»ä½“å®Œæˆç‡
    overall_completion_rate DECIMAL(5,2),         -- æ€»ä½“å®Œæˆç‡(%)

    -- ç»Ÿè®¡çŠ¶æ€
    statistics_status TINYINT DEFAULT 1,          -- ç»Ÿè®¡çŠ¶æ€ï¼š1æ­£å¸¸ 2å¼‚å¸¸ 3éœ€å…³æ³¨

    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.4 è°ƒåº¦ç®¡ç†è¡¨ (coal_dispatch_record)
> **è¯´æ˜ï¼š** æ­¤è¡¨ä¸ç°åœºç”Ÿäº§æ—¥æŠ¥è¡¨å…±ç”¨ï¼Œè°ƒåº¦ç®¡ç†åŠŸèƒ½å·²é›†æˆåœ¨ç”Ÿäº§æ—¥æŠ¥è®°å½•ä¸­ï¼Œé€šè¿‡ `assigned_tasks`ï¼ˆäº¤åŠäº‹é¡¹ï¼‰å’Œ `impact_time_record`ï¼ˆå½±å“æ—¶é—´è®°å½•ï¼‰ç­‰å­—æ®µå®ç°è°ƒåº¦ç®¡ç†åŠŸèƒ½ã€‚

```sql
CREATE TABLE coal_dispatch_record (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    record_date DATE NOT NULL,                    -- è®°å½•æ—¥æœŸ
    shift_id BIGINT NOT NULL,                     -- ç­æ¬¡ID
    dispatcher_id BIGINT NOT NULL,                -- è°ƒåº¦å‘˜ID

    -- è¿è½¬æƒ…å†µ
    system_status NVARCHAR(500),                  -- ç³»ç»Ÿè¿è½¬æƒ…å†µ
    coal_type NVARCHAR(100),                      -- å…¥æ´—åŸç…¤ç±»å‹

    -- é—®é¢˜äº‹æ•…
    accident_description NTEXT,                   -- äº‹æ•…æè¿°
    accident_level TINYINT,                       -- äº‹æ•…çº§åˆ«ï¼š1è½»å¾® 2ä¸€èˆ¬ 3ä¸¥é‡ 4é‡å¤§
    accident_type TINYINT,                        -- äº‹æ•…ç±»å‹ï¼š1ç”Ÿäº§ 2æœºç”µ 3å®‰å…¨

    -- æŒ‡ç¤ºå†…å®¹
    instruction_content NTEXT,                    -- ä¸Šä¼ ä¸‹è¾¾æŒ‡ç¤ºå†…å®¹
    instruction_from NVARCHAR(100),               -- æŒ‡ç¤ºæ¥æº
    instruction_to NVARCHAR(100),                 -- æŒ‡ç¤ºå¯¹è±¡

    -- äº¤æ¥ç­
    handover_issues NTEXT,                        -- äº¤æ¥ç­é—ç•™é—®é¢˜
    next_shift_notice NTEXT,                      -- ä¸‹ç­æ³¨æ„äº‹é¡¹

    -- åœç…¤è®°å½•
    stop_reason NVARCHAR(200),                    -- åœç…¤åŸå› 
    stop_start_time DATETIME,                     -- åœç…¤å¼€å§‹æ—¶é—´
    stop_end_time DATETIME,                       -- åœç…¤ç»“æŸæ—¶é—´

    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.4 ç­æ¬¡ç®¡ç†è¡¨ (coal_shift_config)
```sql
CREATE TABLE coal_shift_config (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    shift_name NVARCHAR(50) NOT NULL,             -- ç­æ¬¡åç§°
    shift_code NVARCHAR(20) NOT NULL,             -- ç­æ¬¡ç¼–ç 
    start_time TIME NOT NULL,                     -- å¼€å§‹æ—¶é—´
    end_time TIME NOT NULL,                       -- ç»“æŸæ—¶é—´
    shift_type TINYINT NOT NULL,                  -- ç­æ¬¡ç±»å‹ï¼š1ç”Ÿäº§ç­ 2æ£€ä¿®ç­ 3å€¼ç­
    is_production BIT DEFAULT 1,                  -- æ˜¯å¦ç”Ÿäº§ç­
    sort_order INT DEFAULT 0,                     -- æ’åº
    status TINYINT DEFAULT 1,                     -- çŠ¶æ€ï¼š0ç¦ç”¨ 1å¯ç”¨
    
    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.5 æ’ç­è¡¨ (coal_shift_schedule)
```sql
CREATE TABLE coal_shift_schedule (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    schedule_date DATE NOT NULL,                  -- æ’ç­æ—¥æœŸ
    shift_id BIGINT NOT NULL,                     -- ç­æ¬¡ID
    user_id BIGINT NOT NULL,                      -- å‘˜å·¥ID
    position_type TINYINT NOT NULL,               -- å²—ä½ç±»å‹ï¼š1è°ƒåº¦å‘˜ 2æ“ä½œå·¥ 3æ£€ä¿®å·¥
    is_leader BIT DEFAULT 0,                      -- æ˜¯å¦ç­é•¿
    
    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 2. è®¾å¤‡æ¡£æ¡ˆç®¡ç†æ¨¡å—

#### 2.1 è®¾å¤‡åŸºç¡€ä¿¡æ¯è¡¨ (coal_equipment_info)
```sql
CREATE TABLE coal_equipment_info (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    equipment_code NVARCHAR(50) NOT NULL,         -- è®¾å¤‡ç¼–å·
    equipment_name NVARCHAR(100) NOT NULL,        -- è®¾å¤‡åç§°
    equipment_type_id BIGINT NOT NULL,            -- è®¾å¤‡ç±»å‹ID
    system_id BIGINT NOT NULL,                    -- æ‰€å±ç³»ç»ŸID
    workshop_id BIGINT,                           -- æ‰€å±è½¦é—´ID
    
    -- è®¾å¤‡åŸºæœ¬ä¿¡æ¯
    model NVARCHAR(100),                          -- è®¾å¤‡å‹å·
    manufacturer NVARCHAR(100),                   -- åˆ¶é€ å‚å•†
    manufacture_date DATE,                        -- åˆ¶é€ æ—¥æœŸ
    install_date DATE,                            -- å®‰è£…æ—¥æœŸ
    commission_date DATE,                         -- æŠ•äº§æ—¥æœŸ
    
    -- æŠ€æœ¯å‚æ•°
    rated_power DECIMAL(10,2),                    -- é¢å®šåŠŸç‡(kW)
    rated_capacity DECIMAL(10,2),                 -- é¢å®šå¤„ç†èƒ½åŠ›(t/h)
    weight DECIMAL(10,2),                         -- è®¾å¤‡é‡é‡(t)
    dimensions NVARCHAR(100),                     -- å¤–å½¢å°ºå¯¸
    
    -- è®¾å¤‡çŠ¶æ€
    equipment_status TINYINT DEFAULT 1,           -- è®¾å¤‡çŠ¶æ€ï¼š1æ­£å¸¸ 2æ•…éšœ 3æ£€ä¿® 4åœç”¨
    health_level TINYINT DEFAULT 1,               -- å¥åº·ç­‰çº§ï¼š1ä¼˜è‰¯ 2è‰¯å¥½ 3æ³¨æ„ 4å¼‚å¸¸
    
    -- ä½ç½®ä¿¡æ¯
    location NVARCHAR(200),                       -- å®‰è£…ä½ç½®
    qr_code NVARCHAR(200),                        -- äºŒç»´ç 
    
    -- è´£ä»»äºº
    responsible_person_id BIGINT,                 -- è´£ä»»äººID
    maintenance_person_id BIGINT,                 -- ç»´æŠ¤äººID
    
    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 2.2 è®¾å¤‡ç±»å‹è¡¨ (coal_equipment_type)
```sql
CREATE TABLE coal_equipment_type (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    type_name NVARCHAR(100) NOT NULL,             -- ç±»å‹åç§°
    type_code NVARCHAR(50) NOT NULL,              -- ç±»å‹ç¼–ç 
    parent_id BIGINT DEFAULT 0,                   -- çˆ¶çº§ID
    level_path NVARCHAR(500),                     -- å±‚çº§è·¯å¾„
    sort_order INT DEFAULT 0,                     -- æ’åº
    description NVARCHAR(500),                    -- æè¿°
    
    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 2.3 è®¾å¤‡å±¥å†è¡¨ (coal_equipment_history)
```sql
CREATE TABLE coal_equipment_history (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    equipment_id BIGINT NOT NULL,                 -- è®¾å¤‡ID
    history_type TINYINT NOT NULL,                -- å±¥å†ç±»å‹ï¼š1è´­ä¹° 2å®‰è£… 3ç»´ä¿® 4ä¿å…» 5æ”¹é€  6æŠ¥åºŸ
    history_date DATE NOT NULL,                   -- å±¥å†æ—¥æœŸ
    
    -- å±¥å†å†…å®¹
    title NVARCHAR(200) NOT NULL,                 -- å±¥å†æ ‡é¢˜
    description NTEXT,                            -- è¯¦ç»†æè¿°
    cost DECIMAL(12,2),                           -- è´¹ç”¨
    supplier NVARCHAR(100),                       -- ä¾›åº”å•†/æ‰¿åŒ…å•†
    
    -- ç»´ä¿®ç›¸å…³
    fault_description NTEXT,                      -- æ•…éšœæè¿°
    repair_method NTEXT,                          -- ç»´ä¿®æ–¹æ³•
    replaced_parts NTEXT,                         -- æ›´æ¢éƒ¨ä»¶
    repair_person_id BIGINT,                      -- ç»´ä¿®äººå‘˜ID
    
    -- é™„ä»¶
    attachment_urls NTEXT,                        -- é™„ä»¶URLåˆ—è¡¨(JSON)
    
    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 3. èƒ½æºç®¡ç†æ¨¡å—

#### 3.1 èƒ½æºæ¶ˆè€—è®°å½•è¡¨ (coal_energy_consumption)
```sql
CREATE TABLE coal_energy_consumption (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    record_date DATE NOT NULL,                    -- è®°å½•æ—¥æœŸ
    shift_id BIGINT NOT NULL,                     -- ç­æ¬¡ID
    energy_type TINYINT NOT NULL,                 -- èƒ½æºç±»å‹ï¼š1ç”µ 2æ°´ 3ä»‹è´¨ 4è¯å‰‚ 5æ²¹æ–™
    
    -- æ¶ˆè€—æ•°æ®
    consumption_amount DECIMAL(12,2),             -- æ¶ˆè€—é‡
    unit NVARCHAR(20),                            -- å•ä½
    unit_price DECIMAL(8,4),                      -- å•ä»·
    total_cost DECIMAL(12,2),                     -- æ€»è´¹ç”¨
    
    -- è®¡é‡ä¿¡æ¯
    meter_reading_start DECIMAL(12,2),            -- èµ·å§‹è¯»æ•°
    meter_reading_end DECIMAL(12,2),              -- ç»“æŸè¯»æ•°
    meter_id NVARCHAR(50),                        -- è®¡é‡è¡¨ç¼–å·
    
    -- å½•å…¥ä¿¡æ¯
    recorder_id BIGINT,                           -- è®°å½•äººID
    record_time DATETIME,                         -- è®°å½•æ—¶é—´
    data_source TINYINT DEFAULT 1,                -- æ•°æ®æ¥æºï¼š1äººå·¥å½•å…¥ 2è‡ªåŠ¨é‡‡é›†
    
    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

---

## ğŸ“Š è®¡åˆ’å±‚çº§å…³è”è®¾è®¡

### è®¡åˆ’å±‚çº§å…³ç³»è¯´æ˜
```
å¹´åº¦è®¡åˆ’ (plan_level=1)
â”œâ”€â”€ æœˆåº¦è®¡åˆ’ (plan_level=2, parent_plan_id=å¹´åº¦è®¡åˆ’ID)
â”‚   â”œâ”€â”€ æ—¥è®¡åˆ’ (plan_level=3, parent_plan_id=æœˆåº¦è®¡åˆ’ID)
â”‚   â”‚   â”œâ”€â”€ æ—©ç­è®¡åˆ’ (plan_level=4, parent_plan_id=æ—¥è®¡åˆ’ID)
â”‚   â”‚   â”œâ”€â”€ ä¸­ç­è®¡åˆ’ (plan_level=4, parent_plan_id=æ—¥è®¡åˆ’ID)
â”‚   â”‚   â””â”€â”€ å¤œç­è®¡åˆ’ (plan_level=4, parent_plan_id=æ—¥è®¡åˆ’ID)
```

### è®¡åˆ’æ‹†åˆ†é€»è¾‘
```java
/**
 * è®¡åˆ’æ‹†åˆ†æœåŠ¡
 */
@Service
public class PlanSplitServiceImpl implements PlanSplitService {

    /**
     * å¹´åº¦è®¡åˆ’æ‹†åˆ†ä¸ºæœˆåº¦è®¡åˆ’
     */
    @Override
    @Transactional
    public List<Long> splitYearlyToMonthly(Long yearlyPlanId) {
        // 1. è·å–å¹´åº¦è®¡åˆ’
        ProductionPlanDO yearlyPlan = productionPlanMapper.selectById(yearlyPlanId);
        validatePlanExists(yearlyPlan);

        List<Long> monthlyPlanIds = new ArrayList<>();

        // 2. æŒ‰æœˆæ‹†åˆ†
        for (int month = 1; month <= 12; month++) {
            ProductionPlanDO monthlyPlan = new ProductionPlanDO();

            // åŸºç¡€ä¿¡æ¯
            monthlyPlan.setPlanCode(generatePlanCode(PlanTypeEnum.MONTHLY, yearlyPlan.getPlanYear(), month));
            monthlyPlan.setPlanType(PlanTypeEnum.MONTHLY.getType());
            monthlyPlan.setPlanLevel(2);
            monthlyPlan.setParentPlanId(yearlyPlanId);
            monthlyPlan.setPlanPath(yearlyPlanId + "/" + monthlyPlan.getId());
            monthlyPlan.setPlanYear(yearlyPlan.getPlanYear());
            monthlyPlan.setPlanMonth(month);

            // äº§é‡åˆ†é…ï¼ˆæŒ‰æœˆå¹³å‡åˆ†é…ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
            BigDecimal monthlyRatio = BigDecimal.valueOf(1.0 / 12);
            monthlyPlan.setRawCoalPlan(yearlyPlan.getRawCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setFineCoalPlan(yearlyPlan.getFineCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setGranularCoalPlan(yearlyPlan.getGranularCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setLargeBlockCoalPlan(yearlyPlan.getLargeBlockCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setMediumBlockCoalPlan(yearlyPlan.getMediumBlockCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setSmallBlockCoalPlan(yearlyPlan.getSmallBlockCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setMiddlingCoalPlan(yearlyPlan.getMiddlingCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setGanguePlan(yearlyPlan.getGanguePlan().multiply(monthlyRatio));

            // è´¨é‡æŒ‡æ ‡ç»§æ‰¿
            monthlyPlan.setFineCoalAsh(yearlyPlan.getFineCoalAsh());
            monthlyPlan.setGranularCoalAsh(yearlyPlan.getGranularCoalAsh());
            monthlyPlan.setLargeBlockCoalAsh(yearlyPlan.getLargeBlockCoalAsh());
            monthlyPlan.setMediumBlockCoalAsh(yearlyPlan.getMediumBlockCoalAsh());
            monthlyPlan.setSmallBlockCoalAsh(yearlyPlan.getSmallBlockCoalAsh());
            monthlyPlan.setMiddlingCoalAsh(yearlyPlan.getMiddlingCoalAsh());

            monthlyPlan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());

            productionPlanMapper.insert(monthlyPlan);
            monthlyPlanIds.add(monthlyPlan.getId());
        }

        return monthlyPlanIds;
    }

    /**
     * æœˆåº¦è®¡åˆ’æ‹†åˆ†ä¸ºæ—¥è®¡åˆ’
     */
    @Override
    @Transactional
    public List<Long> splitMonthlyToDaily(Long monthlyPlanId) {
        ProductionPlanDO monthlyPlan = productionPlanMapper.selectById(monthlyPlanId);
        validatePlanExists(monthlyPlan);

        List<Long> dailyPlanIds = new ArrayList<>();

        // è·å–è¯¥æœˆçš„å¤©æ•°
        LocalDate startDate = LocalDate.of(monthlyPlan.getPlanYear(), monthlyPlan.getPlanMonth(), 1);
        LocalDate endDate = startDate.with(TemporalAdjusters.lastDayOfMonth());
        int daysInMonth = endDate.getDayOfMonth();

        // æŒ‰æ—¥æ‹†åˆ†
        for (int day = 1; day <= daysInMonth; day++) {
            LocalDate planDate = LocalDate.of(monthlyPlan.getPlanYear(), monthlyPlan.getPlanMonth(), day);

            ProductionPlanDO dailyPlan = new ProductionPlanDO();

            // åŸºç¡€ä¿¡æ¯
            dailyPlan.setPlanCode(generatePlanCode(PlanTypeEnum.DAILY, planDate));
            dailyPlan.setPlanType(PlanTypeEnum.DAILY.getType());
            dailyPlan.setPlanLevel(3);
            dailyPlan.setParentPlanId(monthlyPlanId);
            dailyPlan.setPlanPath(monthlyPlan.getPlanPath() + "/" + dailyPlan.getId());
            dailyPlan.setPlanYear(monthlyPlan.getPlanYear());
            dailyPlan.setPlanMonth(monthlyPlan.getPlanMonth());
            dailyPlan.setPlanDate(planDate);

            // äº§é‡åˆ†é…ï¼ˆæŒ‰æ—¥å¹³å‡åˆ†é…ï¼‰
            BigDecimal dailyRatio = BigDecimal.valueOf(1.0 / daysInMonth);
            dailyPlan.setRawCoalPlan(monthlyPlan.getRawCoalPlan().multiply(dailyRatio));
            dailyPlan.setFineCoalPlan(monthlyPlan.getFineCoalPlan().multiply(dailyRatio));
            dailyPlan.setGranularCoalPlan(monthlyPlan.getGranularCoalPlan().multiply(dailyRatio));
            dailyPlan.setLargeBlockCoalPlan(monthlyPlan.getLargeBlockCoalPlan().multiply(dailyRatio));
            dailyPlan.setMediumBlockCoalPlan(monthlyPlan.getMediumBlockCoalPlan().multiply(dailyRatio));
            dailyPlan.setSmallBlockCoalPlan(monthlyPlan.getSmallBlockCoalPlan().multiply(dailyRatio));
            dailyPlan.setMiddlingCoalPlan(monthlyPlan.getMiddlingCoalPlan().multiply(dailyRatio));
            dailyPlan.setGanguePlan(monthlyPlan.getGanguePlan().multiply(dailyRatio));

            // è´¨é‡æŒ‡æ ‡ç»§æ‰¿
            copyQualityIndicators(dailyPlan, monthlyPlan);

            dailyPlan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());

            productionPlanMapper.insert(dailyPlan);
            dailyPlanIds.add(dailyPlan.getId());
        }

        return dailyPlanIds;
    }

    /**
     * æ—¥è®¡åˆ’æ‹†åˆ†ä¸ºç­è®¡åˆ’
     */
    @Override
    @Transactional
    public List<Long> splitDailyToShift(Long dailyPlanId) {
        ProductionPlanDO dailyPlan = productionPlanMapper.selectById(dailyPlanId);
        validatePlanExists(dailyPlan);

        // è·å–ç”Ÿäº§ç­æ¬¡é…ç½®
        List<ShiftConfigDO> shiftConfigs = shiftConfigMapper.selectProductionShifts();

        List<Long> shiftPlanIds = new ArrayList<>();

        for (ShiftConfigDO shiftConfig : shiftConfigs) {
            ProductionPlanDO shiftPlan = new ProductionPlanDO();

            // åŸºç¡€ä¿¡æ¯
            shiftPlan.setPlanCode(generatePlanCode(PlanTypeEnum.SHIFT, dailyPlan.getPlanDate(), shiftConfig.getId()));
            shiftPlan.setPlanType(PlanTypeEnum.SHIFT.getType());
            shiftPlan.setPlanLevel(4);
            shiftPlan.setParentPlanId(dailyPlanId);
            shiftPlan.setPlanPath(dailyPlan.getPlanPath() + "/" + shiftPlan.getId());
            shiftPlan.setPlanYear(dailyPlan.getPlanYear());
            shiftPlan.setPlanMonth(dailyPlan.getPlanMonth());
            shiftPlan.setPlanDate(dailyPlan.getPlanDate());
            shiftPlan.setShiftId(shiftConfig.getId());

            // äº§é‡åˆ†é…ï¼ˆæŒ‰ç­æ¬¡å¹³å‡åˆ†é…ï¼Œé€šå¸¸æ˜¯3ç­åˆ¶ï¼‰
            BigDecimal shiftRatio = BigDecimal.valueOf(1.0 / shiftConfigs.size());
            shiftPlan.setRawCoalPlan(dailyPlan.getRawCoalPlan().multiply(shiftRatio));
            shiftPlan.setFineCoalPlan(dailyPlan.getFineCoalPlan().multiply(shiftRatio));
            shiftPlan.setGranularCoalPlan(dailyPlan.getGranularCoalPlan().multiply(shiftRatio));
            shiftPlan.setLargeBlockCoalPlan(dailyPlan.getLargeBlockCoalPlan().multiply(shiftRatio));
            shiftPlan.setMediumBlockCoalPlan(dailyPlan.getMediumBlockCoalPlan().multiply(shiftRatio));
            shiftPlan.setSmallBlockCoalPlan(dailyPlan.getSmallBlockCoalPlan().multiply(shiftRatio));
            shiftPlan.setMiddlingCoalPlan(dailyPlan.getMiddlingCoalPlan().multiply(shiftRatio));
            shiftPlan.setGanguePlan(dailyPlan.getGanguePlan().multiply(shiftRatio));

            // è´¨é‡æŒ‡æ ‡ç»§æ‰¿
            copyQualityIndicators(shiftPlan, dailyPlan);

            shiftPlan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());

            productionPlanMapper.insert(shiftPlan);
            shiftPlanIds.add(shiftPlan.getId());
        }

        return shiftPlanIds;
    }
}
```

---

## ğŸ”§ åç«¯å¼€å‘åŠŸèƒ½è¯¦è§£

### 1. ç”Ÿäº§è°ƒåº¦ç®¡ç†æ¨¡å— (yudao-module-coal-production)

#### 1.1 ç”Ÿäº§è®¡åˆ’ç®¡ç†
**Controller æ¥å£ï¼š**
- `POST /coal/production/plan/create` - åˆ›å»ºç”Ÿäº§è®¡åˆ’
- `PUT /coal/production/plan/update` - æ›´æ–°ç”Ÿäº§è®¡åˆ’
- `DELETE /coal/production/plan/delete` - åˆ é™¤ç”Ÿäº§è®¡åˆ’
- `GET /coal/production/plan/page` - åˆ†é¡µæŸ¥è¯¢ç”Ÿäº§è®¡åˆ’
- `GET /coal/production/plan/get/{id}` - è·å–è®¡åˆ’è¯¦æƒ…
- `POST /coal/production/plan/approve` - å®¡æ‰¹ç”Ÿäº§è®¡åˆ’
- `POST /coal/production/plan/split` - æ‹†åˆ†è®¡åˆ’(å¹´åº¦â†’æœˆåº¦â†’æ—¥è®¡åˆ’)

**Service ä¸šåŠ¡é€»è¾‘ï¼š**
```java
@Service
public class ProductionPlanServiceImpl extends ServiceExceptionUtil implements ProductionPlanService {
    
    /**
     * åˆ›å»ºç”Ÿäº§è®¡åˆ’
     */
    @Override
    @Transactional
    public Long createPlan(PlanCreateReqVO reqVO) {
        // 1. æ ¡éªŒè®¡åˆ’æ—¶é—´ä¸å†²çª
        validatePlanTimeConflict(reqVO);
        
        // 2. æ ¡éªŒè®¡åˆ’æ•°æ®åˆç†æ€§
        validatePlanData(reqVO);
        
        // 3. åˆ›å»ºè®¡åˆ’
        ProductionPlanDO plan = BeanUtils.toBean(reqVO, ProductionPlanDO.class);
        plan.setPlanCode(generatePlanCode(reqVO.getPlanType()));
        plan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());
        
        productionPlanMapper.insert(plan);
        return plan.getId();
    }
    
    /**
     * æ‹†åˆ†è®¡åˆ’
     */
    @Override
    @Transactional
    public void splitPlan(Long planId, PlanSplitReqVO reqVO) {
        // 1. è·å–çˆ¶è®¡åˆ’
        ProductionPlanDO parentPlan = validatePlanExists(planId);
        
        // 2. æ ¹æ®æ‹†åˆ†ç±»å‹ç”Ÿæˆå­è®¡åˆ’
        List<ProductionPlanDO> childPlans = generateChildPlans(parentPlan, reqVO);
        
        // 3. æ‰¹é‡æ’å…¥å­è®¡åˆ’
        productionPlanMapper.insertBatch(childPlans);
    }
}
```

#### 1.2 è®¡åˆ’å®Œæˆç‡ç»Ÿè®¡åˆ†æ
**Controller æ¥å£ï¼š**
- `GET /coal/production/plan/completion-rate` - è·å–è®¡åˆ’å®Œæˆç‡ç»Ÿè®¡
- `GET /coal/production/plan/dashboard-data` - è·å–å¤§å±å±•ç¤ºæ•°æ®
- `POST /coal/production/plan/calculate-completion` - æ‰‹åŠ¨è§¦å‘å®Œæˆç‡è®¡ç®—
- `GET /coal/production/plan/completion-trend` - è·å–å®Œæˆç‡è¶‹åŠ¿æ•°æ®

**Service ä¸šåŠ¡é€»è¾‘ï¼š**
```java
@Service
public class PlanCompletionStatisticsServiceImpl implements PlanCompletionStatisticsService {

    /**
     * è®¡ç®—è®¡åˆ’å®Œæˆç‡
     */
    @Override
    @Transactional
    public void calculatePlanCompletion(Long planId, LocalDate statisticsDate) {
        // 1. è·å–è®¡åˆ’æ•°æ®
        ProductionPlanDO plan = productionPlanMapper.selectById(planId);
        if (plan == null) {
            throw exception(PLAN_NOT_EXISTS);
        }

        // 2. è·å–å®é™…äº§é‡æ•°æ®
        ProductionActualVO actualData = getActualProductionData(plan, statisticsDate);

        // 3. è®¡ç®—å®Œæˆç‡
        PlanCompletionStatisticsDO statistics = new PlanCompletionStatisticsDO();
        statistics.setPlanId(planId);
        statistics.setStatisticsDate(statisticsDate);
        statistics.setStatisticsType(plan.getPlanType());

        // è®¾ç½®è®¡åˆ’æ•°æ®
        setPlanData(statistics, plan);

        // è®¾ç½®å®é™…æ•°æ®
        setActualData(statistics, actualData);

        // è®¡ç®—å®Œæˆç‡
        calculateCompletionRates(statistics);

        // 4. ä¿å­˜ç»Ÿè®¡æ•°æ®
        planCompletionStatisticsMapper.insertOrUpdate(statistics);
    }

    /**
     * è®¡ç®—å„é¡¹å®Œæˆç‡
     */
    private void calculateCompletionRates(PlanCompletionStatisticsDO statistics) {
        // å…¥æ´—åŸç…¤å®Œæˆç‡
        if (statistics.getPlanRawCoal() != null && statistics.getPlanRawCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualRawCoal()
                .divide(statistics.getPlanRawCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateRawCoal(rate);
        }

        // æœ«ç…¤å®Œæˆç‡
        if (statistics.getPlanFineCoal() != null && statistics.getPlanFineCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualFineCoal()
                .divide(statistics.getPlanFineCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateFineCoal(rate);
        }

        // ç²’ç…¤å®Œæˆç‡
        if (statistics.getPlanGranularCoal() != null && statistics.getPlanGranularCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualGranularCoal()
                .divide(statistics.getPlanGranularCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateGranularCoal(rate);
        }

        // å¤§å—ç…¤å®Œæˆç‡
        if (statistics.getPlanLargeBlockCoal() != null && statistics.getPlanLargeBlockCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualLargeBlockCoal()
                .divide(statistics.getPlanLargeBlockCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateLargeBlock(rate);
        }

        // ä¸­å—ç…¤å®Œæˆç‡
        if (statistics.getPlanMediumBlockCoal() != null && statistics.getPlanMediumBlockCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualMediumBlockCoal()
                .divide(statistics.getPlanMediumBlockCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateMediumBlock(rate);
        }

        // å°å—ç…¤å®Œæˆç‡
        if (statistics.getPlanSmallBlockCoal() != null && statistics.getPlanSmallBlockCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualSmallBlockCoal()
                .divide(statistics.getPlanSmallBlockCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateSmallBlock(rate);
        }

        // ä¸­ç…¤å®Œæˆç‡
        if (statistics.getPlanMiddlingCoal() != null && statistics.getPlanMiddlingCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualMiddlingCoal()
                .divide(statistics.getPlanMiddlingCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateMiddlingCoal(rate);
        }

        // çŸ¸çŸ³å®Œæˆç‡
        if (statistics.getPlanGangue() != null && statistics.getPlanGangue().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualGangue()
                .divide(statistics.getPlanGangue(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateGangue(rate);
        }

        // è®¡ç®—æ€»ä½“å®Œæˆç‡ï¼ˆä»¥å…¥æ´—åŸç…¤ä¸ºä¸»è¦æŒ‡æ ‡ï¼‰
        statistics.setOverallCompletionRate(statistics.getCompletionRateRawCoal());
    }

    /**
     * è·å–å¤§å±å±•ç¤ºæ•°æ®
     */
    @Override
    public DashboardDataVO getDashboardData(DashboardDataReqVO reqVO) {
        DashboardDataVO dashboardData = new DashboardDataVO();

        // 1. å½“æœˆè®¡åˆ’å®Œæˆç‡
        PlanCompletionStatisticsDO monthlyStats = planCompletionStatisticsMapper
            .selectByTypeAndDate(PlanTypeEnum.MONTHLY.getType(), reqVO.getStatisticsDate());
        if (monthlyStats != null) {
            dashboardData.setMonthlyCompletionRate(monthlyStats.getOverallCompletionRate());
            dashboardData.setMonthlyPlanAmount(monthlyStats.getPlanRawCoal());
            dashboardData.setMonthlyActualAmount(monthlyStats.getActualRawCoal());
        }

        // 2. å½“æ—¥è®¡åˆ’å®Œæˆç‡
        PlanCompletionStatisticsDO dailyStats = planCompletionStatisticsMapper
            .selectByTypeAndDate(PlanTypeEnum.DAILY.getType(), reqVO.getStatisticsDate());
        if (dailyStats != null) {
            dashboardData.setDailyCompletionRate(dailyStats.getOverallCompletionRate());
            dashboardData.setDailyPlanAmount(dailyStats.getPlanRawCoal());
            dashboardData.setDailyActualAmount(dailyStats.getActualRawCoal());
        }

        // 3. å„äº§å“å®Œæˆç‡
        List<ProductCompletionRateVO> productRates = new ArrayList<>();
        if (monthlyStats != null) {
            productRates.add(new ProductCompletionRateVO("æœ«ç…¤", monthlyStats.getCompletionRateFineCoal()));
            productRates.add(new ProductCompletionRateVO("ç²’ç…¤", monthlyStats.getCompletionRateGranularCoal()));
            productRates.add(new ProductCompletionRateVO("å¤§å—", monthlyStats.getCompletionRateLargeBlock()));
            productRates.add(new ProductCompletionRateVO("ä¸­å—", monthlyStats.getCompletionRateMediumBlock()));
            productRates.add(new ProductCompletionRateVO("å°å—", monthlyStats.getCompletionRateSmallBlock()));
            productRates.add(new ProductCompletionRateVO("ä¸­ç…¤", monthlyStats.getCompletionRateMiddlingCoal()));
            productRates.add(new ProductCompletionRateVO("çŸ¸çŸ³", monthlyStats.getCompletionRateGangue()));
        }
        dashboardData.setProductCompletionRates(productRates);

        // 4. å®Œæˆç‡è¶‹åŠ¿æ•°æ®ï¼ˆæœ€è¿‘7å¤©ï¼‰
        List<CompletionTrendVO> trendData = planCompletionStatisticsMapper
            .selectTrendData(reqVO.getStatisticsDate().minusDays(6), reqVO.getStatisticsDate());
        dashboardData.setCompletionTrend(trendData);

        return dashboardData;
    }

    /**
     * è·å–å®é™…äº§é‡æ•°æ®
     */
    private ProductionActualVO getActualProductionData(ProductionPlanDO plan, LocalDate statisticsDate) {
        ProductionActualVO actualData = new ProductionActualVO();

        switch (plan.getPlanType()) {
            case 1: // å¹´åº¦è®¡åˆ’
                actualData = getYearlyActualData(plan.getPlanYear());
                break;
            case 2: // æœˆåº¦è®¡åˆ’
                actualData = getMonthlyActualData(plan.getPlanYear(), plan.getPlanMonth());
                break;
            case 3: // æ—¥è®¡åˆ’
                actualData = getDailyActualData(plan.getPlanDate());
                break;
            case 4: // ç­è®¡åˆ’
                actualData = getShiftActualData(plan.getPlanDate(), plan.getShiftId());
                break;
        }

        return actualData;
    }

    /**
     * è·å–æœˆåº¦å®é™…äº§é‡æ•°æ®
     */
    private ProductionActualVO getMonthlyActualData(Integer year, Integer month) {
        // ä»ç”Ÿäº§æ—¥æŠ¥è¡¨ä¸­ç»Ÿè®¡æœˆåº¦å®é™…äº§é‡
        LocalDate startDate = LocalDate.of(year, month, 1);
        LocalDate endDate = startDate.with(TemporalAdjusters.lastDayOfMonth());

        return productionDailyReportMapper.sumActualDataByDateRange(startDate, endDate);
    }
}
```

#### 1.3 äº§é‡ç»Ÿè®¡åˆ†æ
**Service ä¸šåŠ¡é€»è¾‘ï¼š**
```java
@Service
public class ProductionStatisticsServiceImpl implements ProductionStatisticsService {
    
    /**
     * ç”Ÿæˆäº§å“å¹³è¡¡è¡¨
     */
    @Override
    public ProductBalanceVO generateProductBalance(ProductBalanceReqVO reqVO) {
        // 1. æŸ¥è¯¢æ—¶é—´æ®µå†…çš„äº§é‡æ•°æ®
        List<ProductionOutputDO> outputs = productionOutputMapper.selectByDateRange(
            reqVO.getStartDate(), reqVO.getEndDate());
        
        // 2. è®¡ç®—å¹³è¡¡æ•°æ®
        ProductBalanceVO balance = calculateProductBalance(outputs);
        
        // 3. è®¡ç®—å®Œæˆç‡
        calculateCompletionRate(balance, reqVO);
        
        return balance;
    }
    
    /**
     * ç”Ÿæˆäº§ç‡åˆ†ææŠ¥å‘Š
     */
    @Override
    public YieldAnalysisVO analyzeYield(YieldAnalysisReqVO reqVO) {
        // 1. æŸ¥è¯¢äº§é‡æ•°æ®
        List<ProductionOutputDO> outputs = getOutputsByCondition(reqVO);
        
        // 2. è®¡ç®—å„ç§äº§ç‡
        YieldAnalysisVO analysis = new YieldAnalysisVO();
        analysis.setCleanCoalYield(calculateCleanCoalYield(outputs));
        analysis.setRecoveryRate(calculateRecoveryRate(outputs));
        analysis.setRejectRate(calculateRejectRate(outputs));
        
        // 3. å¯¹æ¯”ç›®æ ‡äº§ç‡
        compareWithTarget(analysis, reqVO);
        
        return analysis;
    }
}
```

### 2. è®¾å¤‡ç®¡ç†æ¨¡å— (yudao-module-coal-equipment)

#### 2.1 è®¾å¤‡æ¡£æ¡ˆç®¡ç†
**Controller æ¥å£ï¼š**
- `POST /coal/equipment/create` - åˆ›å»ºè®¾å¤‡æ¡£æ¡ˆ
- `PUT /coal/equipment/update` - æ›´æ–°è®¾å¤‡ä¿¡æ¯
- `GET /coal/equipment/page` - åˆ†é¡µæŸ¥è¯¢è®¾å¤‡
- `GET /coal/equipment/get/{id}` - è·å–è®¾å¤‡è¯¦æƒ…
- `GET /coal/equipment/qrcode/{code}` - é€šè¿‡äºŒç»´ç è·å–è®¾å¤‡ä¿¡æ¯
- `POST /coal/equipment/upload-document` - ä¸Šä¼ è®¾å¤‡æ–‡æ¡£

#### 2.2 è®¾å¤‡KPIç»Ÿè®¡
**Service ä¸šåŠ¡é€»è¾‘ï¼š**
```java
@Service
public class EquipmentKpiServiceImpl implements EquipmentKpiService {
    
    /**
     * è®¡ç®—è®¾å¤‡å®Œå¥½ç‡
     */
    @Override
    public BigDecimal calculateIntactRate(KpiCalculateReqVO reqVO) {
        // å®Œå¥½ç‡ = å®Œå¥½è®¾å¤‡æ•° / æ€»è®¾å¤‡æ•° * 100%
        long totalCount = equipmentMapper.countByCondition(reqVO);
        long intactCount = equipmentMapper.countByStatus(reqVO, EquipmentStatusEnum.NORMAL);
        
        return BigDecimal.valueOf(intactCount)
                .divide(BigDecimal.valueOf(totalCount), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
    }
    
    /**
     * è®¡ç®—è®¾å¤‡åˆ©ç”¨ç‡
     */
    @Override
    public BigDecimal calculateUtilizationRate(KpiCalculateReqVO reqVO) {
        // åˆ©ç”¨ç‡ = å®é™…è¿è¡Œæ—¶é—´ / è®¡åˆ’è¿è¡Œæ—¶é—´ * 100%
        BigDecimal actualRunTime = getActualRunTime(reqVO);
        BigDecimal plannedRunTime = getPlannedRunTime(reqVO);
        
        return actualRunTime.divide(plannedRunTime, 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
    }
}
```

### 3. ç…¤è´¨ç®¡ç†æ¨¡å— (yudao-module-coal-quality)

#### 3.1 ç…¤è´¨æ£€æµ‹æ•°æ®ç®¡ç†
**Controller æ¥å£ï¼š**
- `POST /coal/quality/test-data/create` - å½•å…¥æ£€æµ‹æ•°æ®
- `GET /coal/quality/test-data/page` - åˆ†é¡µæŸ¥è¯¢æ£€æµ‹æ•°æ®
- `GET /coal/quality/test-data/realtime` - è·å–å®æ—¶æ£€æµ‹æ•°æ®
- `POST /coal/quality/test-data/batch-import` - æ‰¹é‡å¯¼å…¥æ£€æµ‹æ•°æ®

---

## ğŸ¨ å‰ç«¯å¼€å‘åŠŸèƒ½è¯¦è§£

### 1. ç”Ÿäº§è°ƒåº¦ç®¡ç†å‰ç«¯

#### 1.1 ç”Ÿäº§è®¡åˆ’ç®¡ç†é¡µé¢
**é¡µé¢è·¯å¾„ï¼š** `src/views/coal/production/plan/index.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- è®¡åˆ’åˆ—è¡¨å±•ç¤ºï¼ˆæ”¯æŒå¹´åº¦/æœˆåº¦/æ—¥è®¡åˆ’åˆ‡æ¢ï¼‰
- è®¡åˆ’åˆ›å»ºè¡¨å•ï¼ˆæ”¯æŒæ¨¡æ¿é€‰æ‹©ï¼‰
- è®¡åˆ’æ‹†åˆ†åŠŸèƒ½ï¼ˆå¹´åº¦â†’æœˆåº¦â†’æ—¥è®¡åˆ’ï¼‰
- è®¡åˆ’å®¡æ‰¹æµç¨‹
- è®¡åˆ’æ‰§è¡Œè¿›åº¦è·Ÿè¸ª
- è®¡åˆ’å¯¹æ¯”åˆ†æå›¾è¡¨

**å…³é”®ç»„ä»¶ï¼š**
```vue
<template>
  <div class="production-plan">
    <!-- è®¡åˆ’ç±»å‹åˆ‡æ¢ -->
    <el-tabs v-model="activeTab" @tab-click="handleTabClick">
      <el-tab-pane label="å¹´åº¦è®¡åˆ’" name="yearly" />
      <el-tab-pane label="æœˆåº¦è®¡åˆ’" name="monthly" />
      <el-tab-pane label="æ—¥è®¡åˆ’" name="daily" />
    </el-tabs>
    
    <!-- æœç´¢æ¡ä»¶ -->
    <el-form :model="queryParams" inline>
      <el-form-item label="è®¡åˆ’å¹´åº¦">
        <el-date-picker v-model="queryParams.planYear" type="year" />
      </el-form-item>
      <el-form-item label="å®¡æ‰¹çŠ¶æ€">
        <el-select v-model="queryParams.planStatus">
          <el-option label="å¾…å®¡æ‰¹" value="1" />
          <el-option label="å·²å®¡æ‰¹" value="2" />
        </el-select>
      </el-form-item>
    </el-form>
    
    <!-- è®¡åˆ’åˆ—è¡¨ -->
    <el-table :data="planList" v-loading="loading">
      <el-table-column prop="planCode" label="è®¡åˆ’ç¼–å·" />
      <el-table-column prop="planYear" label="è®¡åˆ’å¹´åº¦" />
      <el-table-column prop="rawCoalPlan" label="è®¡åˆ’å…¥æ´—é‡(å¨)" />
      <el-table-column prop="cleanCoalPlan" label="è®¡åˆ’ç²¾ç…¤äº§é‡(å¨)" />
      <el-table-column label="å®Œæˆç‡">
        <template #default="{ row }">
          <el-progress :percentage="row.completionRate" />
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ">
        <template #default="{ row }">
          <el-button @click="handleEdit(row)">ç¼–è¾‘</el-button>
          <el-button @click="handleSplit(row)">æ‹†åˆ†</el-button>
          <el-button @click="handleApprove(row)">å®¡æ‰¹</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

#### 1.2 ç”Ÿäº§çœ‹æ¿é¡µé¢ï¼ˆå¤§å±å±•ç¤ºï¼‰
**é¡µé¢è·¯å¾„ï¼š** `src/views/coal/production/dashboard/index.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- å®æ—¶ç”Ÿäº§æ•°æ®å±•ç¤º
- è®¡åˆ’å®Œæˆç‡ç™¾åˆ†æ¯”å±•ç¤º
- äº§é‡å®Œæˆæƒ…å†µå›¾è¡¨
- è®¾å¤‡è¿è¡ŒçŠ¶æ€ç›‘æ§
- è´¨é‡æŒ‡æ ‡è¶‹åŠ¿å›¾
- å¼‚å¸¸æŠ¥è­¦æé†’

**å…³é”®ç»„ä»¶ï¼ˆå¤§å±å±•ç¤ºï¼‰ï¼š**
```vue
<template>
  <div class="production-dashboard">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div class="dashboard-header">
      <h1>é€‰ç…¤å‚ç”Ÿäº§ç®¡æ§å¤§å±</h1>
      <div class="current-time">{{ currentTime }}</div>
    </div>

    <!-- ä¸»è¦æŒ‡æ ‡å¡ç‰‡ -->
    <div class="main-indicators">
      <!-- æœˆåº¦è®¡åˆ’å®Œæˆç‡ -->
      <div class="indicator-card monthly-completion">
        <div class="card-header">
          <h3>æœˆåº¦è®¡åˆ’å®Œæˆç‡</h3>
          <div class="date-info">{{ currentMonth }}</div>
        </div>
        <div class="completion-rate">
          <div class="rate-circle">
            <el-progress
              type="circle"
              :percentage="dashboardData.monthlyCompletionRate"
              :width="120"
              :stroke-width="8"
              :color="getCompletionRateColor(dashboardData.monthlyCompletionRate)"
            >
              <template #default="{ percentage }">
                <span class="percentage-text">{{ percentage }}%</span>
              </template>
            </el-progress>
          </div>
          <div class="rate-details">
            <div class="detail-item">
              <span class="label">è®¡åˆ’äº§é‡ï¼š</span>
              <span class="value">{{ formatNumber(dashboardData.monthlyPlanAmount) }}ä¸‡å¨</span>
            </div>
            <div class="detail-item">
              <span class="label">å®é™…äº§é‡ï¼š</span>
              <span class="value">{{ formatNumber(dashboardData.monthlyActualAmount) }}ä¸‡å¨</span>
            </div>
          </div>
        </div>
      </div>

      <!-- æ—¥è®¡åˆ’å®Œæˆç‡ -->
      <div class="indicator-card daily-completion">
        <div class="card-header">
          <h3>æ—¥è®¡åˆ’å®Œæˆç‡</h3>
          <div class="date-info">{{ currentDate }}</div>
        </div>
        <div class="completion-rate">
          <div class="rate-circle">
            <el-progress
              type="circle"
              :percentage="dashboardData.dailyCompletionRate"
              :width="120"
              :stroke-width="8"
              :color="getCompletionRateColor(dashboardData.dailyCompletionRate)"
            >
              <template #default="{ percentage }">
                <span class="percentage-text">{{ percentage }}%</span>
              </template>
            </el-progress>
          </div>
          <div class="rate-details">
            <div class="detail-item">
              <span class="label">è®¡åˆ’äº§é‡ï¼š</span>
              <span class="value">{{ formatNumber(dashboardData.dailyPlanAmount) }}å¨</span>
            </div>
            <div class="detail-item">
              <span class="label">å®é™…äº§é‡ï¼š</span>
              <span class="value">{{ formatNumber(dashboardData.dailyActualAmount) }}å¨</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- äº§å“å®Œæˆç‡å¯¹æ¯” -->
    <div class="product-completion-section">
      <div class="section-header">
        <h3>å„äº§å“å®Œæˆç‡å¯¹æ¯”</h3>
      </div>
      <div class="product-completion-chart">
        <div
          v-for="product in dashboardData.productCompletionRates"
          :key="product.productName"
          class="product-item"
        >
          <div class="product-name">{{ product.productName }}</div>
          <div class="product-progress">
            <el-progress
              :percentage="product.completionRate"
              :stroke-width="20"
              :color="getCompletionRateColor(product.completionRate)"
            />
          </div>
          <div class="product-rate">{{ product.completionRate }}%</div>
        </div>
      </div>
    </div>

    <!-- å®Œæˆç‡è¶‹åŠ¿å›¾ -->
    <div class="trend-section">
      <div class="section-header">
        <h3>å®Œæˆç‡è¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰</h3>
      </div>
      <div class="trend-chart" ref="trendChartRef"></div>
    </div>

    <!-- å®æ—¶æ•°æ®æ»šåŠ¨ -->
    <div class="realtime-data-section">
      <div class="section-header">
        <h3>å®æ—¶ç”Ÿäº§æ•°æ®</h3>
      </div>
      <div class="data-scroll">
        <div class="scroll-content">
          <div class="data-item">
            <span class="data-label">å½“å‰ç­æ¬¡ï¼š</span>
            <span class="data-value">{{ currentShift }}</span>
          </div>
          <div class="data-item">
            <span class="data-label">ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼š</span>
            <span class="data-value status-normal">æ­£å¸¸è¿è¡Œ</span>
          </div>
          <div class="data-item">
            <span class="data-label">å°æ—¶å¤„ç†é‡ï¼š</span>
            <span class="data-value">{{ realtimeData.hourlyCapacity }}å¨/å°æ—¶</span>
          </div>
          <div class="data-item">
            <span class="data-label">è®¾å¤‡å®Œå¥½ç‡ï¼š</span>
            <span class="data-value">{{ realtimeData.equipmentIntactRate }}%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { ref, reactive, onMounted, onUnmounted } from 'vue'
import * as echarts from 'echarts'
import * as ProductionApi from '@/api/coal/production'

// å“åº”å¼æ•°æ®
const currentTime = ref('')
const currentDate = ref('')
const currentMonth = ref('')
const currentShift = ref('')
const trendChartRef = ref()
let trendChart: echarts.ECharts | null = null
let timer: NodeJS.Timeout | null = null

const dashboardData = reactive({
  monthlyCompletionRate: 0,
  monthlyPlanAmount: 0,
  monthlyActualAmount: 0,
  dailyCompletionRate: 0,
  dailyPlanAmount: 0,
  dailyActualAmount: 0,
  productCompletionRates: [],
  completionTrend: []
})

const realtimeData = reactive({
  hourlyCapacity: 0,
  equipmentIntactRate: 0
})

// è·å–å¤§å±æ•°æ®
const getDashboardData = async () => {
  try {
    const data = await ProductionApi.getDashboardData({
      statisticsDate: new Date().toISOString().split('T')[0]
    })

    Object.assign(dashboardData, data)

    // æ›´æ–°è¶‹åŠ¿å›¾
    updateTrendChart()
  } catch (error) {
    console.error('è·å–å¤§å±æ•°æ®å¤±è´¥:', error)
  }
}

// å®Œæˆç‡é¢œè‰²åˆ¤æ–­
const getCompletionRateColor = (rate: number) => {
  if (rate >= 100) return '#67C23A' // ç»¿è‰²
  if (rate >= 90) return '#E6A23C'  // æ©™è‰²
  if (rate >= 80) return '#F56C6C'  // çº¢è‰²
  return '#909399' // ç°è‰²
}

// æ•°å­—æ ¼å¼åŒ–
const formatNumber = (num: number) => {
  if (num >= 10000) {
    return (num / 10000).toFixed(1)
  }
  return num.toFixed(1)
}

// æ›´æ–°è¶‹åŠ¿å›¾
const updateTrendChart = () => {
  if (!trendChart) return

  const option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'cross'
      }
    },
    legend: {
      data: ['è®¡åˆ’å®Œæˆç‡'],
      textStyle: {
        color: '#fff'
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: dashboardData.completionTrend.map(item => item.date),
      axisLine: {
        lineStyle: {
          color: '#fff'
        }
      }
    },
    yAxis: {
      type: 'value',
      name: 'å®Œæˆç‡(%)',
      axisLine: {
        lineStyle: {
          color: '#fff'
        }
      }
    },
    series: [
      {
        name: 'è®¡åˆ’å®Œæˆç‡',
        type: 'line',
        data: dashboardData.completionTrend.map(item => item.completionRate),
        smooth: true,
        lineStyle: {
          color: '#00D4FF'
        },
        itemStyle: {
          color: '#00D4FF'
        },
        areaStyle: {
          color: {
            type: 'linear',
            x: 0,
            y: 0,
            x2: 0,
            y2: 1,
            colorStops: [
              { offset: 0, color: 'rgba(0, 212, 255, 0.3)' },
              { offset: 1, color: 'rgba(0, 212, 255, 0)' }
            ]
          }
        }
      }
    ]
  }

  trendChart.setOption(option)
}

// æ›´æ–°æ—¶é—´
const updateTime = () => {
  const now = new Date()
  currentTime.value = now.toLocaleString()
  currentDate.value = now.toLocaleDateString()
  currentMonth.value = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`
}

// åˆå§‹åŒ–è¶‹åŠ¿å›¾
const initTrendChart = () => {
  trendChart = echarts.init(trendChartRef.value)
  updateTrendChart()
}

onMounted(() => {
  // åˆå§‹åŒ–æ—¶é—´
  updateTime()

  // è·å–åˆå§‹æ•°æ®
  getDashboardData()

  // åˆå§‹åŒ–å›¾è¡¨
  nextTick(() => {
    initTrendChart()
  })

  // è®¾ç½®å®šæ—¶å™¨ï¼Œæ¯30ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
  timer = setInterval(() => {
    updateTime()
    getDashboardData()
  }, 30000)
})

onUnmounted(() => {
  if (timer) {
    clearInterval(timer)
  }
  if (trendChart) {
    trendChart.dispose()
  }
})
</script>

<style lang="scss" scoped>
.production-dashboard {
  width: 100%;
  height: 100vh;
  background: linear-gradient(135deg, #0c1e35 0%, #1a365d 100%);
  color: #fff;
  padding: 20px;
  overflow: hidden;

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;

    h1 {
      font-size: 36px;
      font-weight: bold;
      color: #00D4FF;
      text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }

    .current-time {
      font-size: 18px;
      color: #E6A23C;
    }
  }

  .main-indicators {
    display: flex;
    gap: 30px;
    margin-bottom: 30px;

    .indicator-card {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;

        h3 {
          font-size: 20px;
          color: #00D4FF;
        }

        .date-info {
          font-size: 14px;
          color: #E6A23C;
        }
      }

      .completion-rate {
        display: flex;
        align-items: center;
        gap: 30px;

        .percentage-text {
          font-size: 24px;
          font-weight: bold;
        }

        .rate-details {
          .detail-item {
            margin-bottom: 10px;

            .label {
              color: #B0BEC5;
            }

            .value {
              color: #00D4FF;
              font-weight: bold;
              margin-left: 10px;
            }
          }
        }
      }
    }
  }

  .product-completion-section {
    margin-bottom: 30px;

    .section-header {
      margin-bottom: 20px;

      h3 {
        font-size: 24px;
        color: #00D4FF;
      }
    }

    .product-completion-chart {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;

      .product-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        text-align: center;

        .product-name {
          font-size: 16px;
          margin-bottom: 15px;
          color: #fff;
        }

        .product-progress {
          margin-bottom: 10px;
        }

        .product-rate {
          font-size: 18px;
          font-weight: bold;
          color: #00D4FF;
        }
      }
    }
  }

  .trend-section {
    margin-bottom: 30px;

    .trend-chart {
      height: 300px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
  }

  .realtime-data-section {
    .data-scroll {
      height: 60px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;

      .scroll-content {
        display: flex;
        animation: scroll 20s linear infinite;

        .data-item {
          flex-shrink: 0;
          padding: 0 30px;
          line-height: 60px;

          .data-label {
            color: #B0BEC5;
          }

          .data-value {
            color: #00D4FF;
            font-weight: bold;
            margin-left: 10px;

            &.status-normal {
              color: #67C23A;
            }
          }
        }
      }
    }
  }
}

@keyframes scroll {
  0% {
    transform: translateX(100%);
  }
  100% {
    transform: translateX(-100%);
  }
}
</style>
```

### 2. è®¾å¤‡ç®¡ç†å‰ç«¯

#### 2.1 è®¾å¤‡æ¡£æ¡ˆé¡µé¢
**é¡µé¢è·¯å¾„ï¼š** `src/views/coal/equipment/archive/index.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- è®¾å¤‡æ ‘å½¢ç»“æ„å±•ç¤º
- è®¾å¤‡è¯¦ç»†ä¿¡æ¯æŸ¥çœ‹
- è®¾å¤‡äºŒç»´ç ç”Ÿæˆ
- è®¾å¤‡æ–‡æ¡£ç®¡ç†
- è®¾å¤‡å±¥å†è®°å½•

#### 2.2 è®¾å¤‡KPIçœ‹æ¿
**é¡µé¢è·¯å¾„ï¼š** `src/views/coal/equipment/kpi/index.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- KPIæŒ‡æ ‡å¡ç‰‡å±•ç¤º
- è®¾å¤‡å®Œå¥½ç‡è¶‹åŠ¿å›¾
- æ•…éšœç‡ç»Ÿè®¡å›¾è¡¨
- è®¾å¤‡åˆ©ç”¨ç‡åˆ†æ
- å¯¹æ¯”åˆ†æåŠŸèƒ½

---

## ğŸ“± ç§»åŠ¨ç«¯å¼€å‘

### 1. è®¾å¤‡å·¡æ£€APP
**æŠ€æœ¯æ ˆï¼š** uni-app + Vue 3

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- æ‰«ç æŸ¥çœ‹è®¾å¤‡æ¡£æ¡ˆ
- è®¾å¤‡å·¡æ£€è®°å½•
- æ•…éšœæŠ¥ä¿®æäº¤
- æ£€ä¿®ä»»åŠ¡æ¥æ”¶
- ç¦»çº¿æ•°æ®åŒæ­¥

### 2. ç”Ÿäº§æ•°æ®å½•å…¥APP
**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- äº§é‡æ•°æ®å½•å…¥
- ç…¤è´¨æ£€æµ‹æ•°æ®å½•å…¥
- èƒ½æºæ¶ˆè€—è®°å½•
- è°ƒåº¦è®°å½•å¡«å†™

---

## ğŸ”„ ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ

### 1. PLCæ•°æ®é‡‡é›†
**æŠ€æœ¯æ–¹æ¡ˆï¼š** OPC UA + MQTT

**é‡‡é›†å†…å®¹ï¼š**
- è®¾å¤‡è¿è¡ŒçŠ¶æ€
- ç”Ÿäº§è¿‡ç¨‹æ•°æ®
- æŠ¥è­¦ä¿¡æ¯
- èƒ½æºæ¶ˆè€—æ•°æ®

### 2. ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆ
- **ERPç³»ç»Ÿ**ï¼šç”Ÿäº§è®¡åˆ’ã€ç‰©æ–™ç®¡ç†
- **åŒ–éªŒç³»ç»Ÿ**ï¼šç…¤è´¨æ£€æµ‹æ•°æ®
- **è§†é¢‘ç›‘æ§**ï¼šå®‰å…¨ç›‘æ§é›†æˆ
- **é—¨ç¦ç³»ç»Ÿ**ï¼šäººå‘˜è¿›å‡ºè®°å½•

---

## ğŸ“Š æŠ¥è¡¨ç³»ç»Ÿè®¾è®¡

### 1. ç”Ÿäº§æŠ¥è¡¨
- æ—¥äº§é‡æŠ¥è¡¨
- æœˆåº¦ç”Ÿäº§æ€»ç»“
- äº§å“å¹³è¡¡è¡¨
- äº§ç‡åˆ†ææŠ¥è¡¨

### 2. è®¾å¤‡æŠ¥è¡¨
- è®¾å¤‡è¿è¡ŒæŠ¥è¡¨
- æ•…éšœç»Ÿè®¡æŠ¥è¡¨
- ç»´ä¿®è®°å½•æŠ¥è¡¨
- KPIåˆ†ææŠ¥è¡¨

### 3. è´¨é‡æŠ¥è¡¨
- ç…¤è´¨æ£€æµ‹æŠ¥è¡¨
- è´¨é‡è¶‹åŠ¿åˆ†æ
- åˆæ ¼ç‡ç»Ÿè®¡
- è´¨é‡å¼‚å¸¸æŠ¥å‘Š

---

## ğŸš€ å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰
1. åŸºç¡€æ¡†æ¶æ­å»º
2. æ•°æ®åº“è®¾è®¡å®ç°
3. ç”¨æˆ·æƒé™ç®¡ç†
4. ç”Ÿäº§è®¡åˆ’ç®¡ç†æ¨¡å—

### ç¬¬äºŒé˜¶æ®µï¼ˆ2-3ä¸ªæœˆï¼‰
1. äº§é‡ç»Ÿè®¡æ¨¡å—
2. è®¾å¤‡æ¡£æ¡ˆç®¡ç†
3. åŸºç¡€æŠ¥è¡¨åŠŸèƒ½
4. ç§»åŠ¨ç«¯æ¡†æ¶

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4ä¸ªæœˆï¼‰
1. ç…¤è´¨ç®¡ç†æ¨¡å—
2. å®‰å…¨ç®¡ç†æ¨¡å—
3. èƒ½æºç®¡ç†æ¨¡å—
4. é«˜çº§æŠ¥è¡¨å’Œåˆ†æ

### ç¬¬å››é˜¶æ®µï¼ˆ4-5ä¸ªæœˆï¼‰
1. PLCæ•°æ®é›†æˆ
2. ç§»åŠ¨ç«¯å®Œå–„
3. ç³»ç»Ÿä¼˜åŒ–
4. éƒ¨ç½²ä¸Šçº¿

---

## ğŸ“‹ å¼€å‘è§„èŒƒ

### 1. ä»£ç è§„èŒƒ
- éµå¾ªé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œ
- ä½¿ç”¨ESLintè¿›è¡Œå‰ç«¯ä»£ç æ£€æŸ¥
- ç»Ÿä¸€çš„æ³¨é‡Šè§„èŒƒ
- Gitæäº¤è§„èŒƒ

### 2. æ•°æ®åº“è§„èŒƒ
- ç»Ÿä¸€çš„å‘½åè§„èŒƒ
- å®Œæ•´çš„ç´¢å¼•è®¾è®¡
- æ•°æ®å­—å…¸ç»´æŠ¤
- å¤‡ä»½æ¢å¤ç­–ç•¥

### 3. æ¥å£è§„èŒƒ
- RESTful APIè®¾è®¡
- ç»Ÿä¸€çš„è¿”å›æ ¼å¼
- å®Œæ•´çš„æ¥å£æ–‡æ¡£
- ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

### 4. å®‰å…¨ç®¡ç†æ¨¡å—æ•°æ®è¡¨

#### 4.1 å®‰å…¨æ£€æŸ¥è¡¨ (coal_safety_inspection)
```sql
CREATE TABLE coal_safety_inspection (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    inspection_code NVARCHAR(50) NOT NULL,        -- æ£€æŸ¥ç¼–å·
    inspection_date DATE NOT NULL,                -- æ£€æŸ¥æ—¥æœŸ
    inspection_type TINYINT NOT NULL,             -- æ£€æŸ¥ç±»å‹ï¼š1æ—¥æ£€ 2å‘¨æ£€ 3æœˆæ£€ 4ä¸“é¡¹æ£€æŸ¥
    inspector_id BIGINT NOT NULL,                 -- æ£€æŸ¥äººID

    -- æ£€æŸ¥åŒºåŸŸ
    area_id BIGINT,                               -- æ£€æŸ¥åŒºåŸŸID
    equipment_id BIGINT,                          -- æ£€æŸ¥è®¾å¤‡ID

    -- æ£€æŸ¥å†…å®¹
    inspection_items NTEXT,                       -- æ£€æŸ¥é¡¹ç›®(JSONæ ¼å¼)
    risk_level TINYINT,                           -- é£é™©ç­‰çº§ï¼š1ä½ 2ä¸­ 3é«˜ 4æé«˜

    -- å‘ç°é—®é¢˜
    problem_description NTEXT,                    -- é—®é¢˜æè¿°
    problem_photos NTEXT,                         -- é—®é¢˜ç…§ç‰‡(JSONæ•°ç»„)
    problem_videos NTEXT,                         -- é—®é¢˜è§†é¢‘(JSONæ•°ç»„)
    voice_record NVARCHAR(500),                   -- è¯­éŸ³è®°å½•URL

    -- æ•´æ”¹è¦æ±‚
    rectification_requirement NTEXT,             -- æ•´æ”¹è¦æ±‚
    rectification_deadline DATE,                 -- æ•´æ”¹æœŸé™
    rectification_person_id BIGINT,              -- æ•´æ”¹è´£ä»»äººID

    -- æ£€æŸ¥çŠ¶æ€
    inspection_status TINYINT DEFAULT 1,          -- æ£€æŸ¥çŠ¶æ€ï¼š1å¾…æ•´æ”¹ 2æ•´æ”¹ä¸­ 3å·²æ•´æ”¹ 4å·²éªŒæ”¶

    -- æ•´æ”¹ç»“æœ
    rectification_result NTEXT,                  -- æ•´æ”¹ç»“æœ
    rectification_photos NTEXT,                  -- æ•´æ”¹ç…§ç‰‡
    rectification_date DATE,                     -- æ•´æ”¹å®Œæˆæ—¥æœŸ
    verifier_id BIGINT,                          -- éªŒæ”¶äººID
    verify_date DATE,                            -- éªŒæ”¶æ—¥æœŸ

    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 4.2 å®‰å…¨äº‹æ•…è¡¨ (coal_safety_accident)
```sql
CREATE TABLE coal_safety_accident (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    accident_code NVARCHAR(50) NOT NULL,          -- äº‹æ•…ç¼–å·
    accident_date DATETIME NOT NULL,              -- äº‹æ•…å‘ç”Ÿæ—¶é—´
    accident_type TINYINT NOT NULL,               -- äº‹æ•…ç±»å‹ï¼š1äººèº«ä¼¤å®³ 2è®¾å¤‡äº‹æ•… 3ç«ç¾ 4å…¶ä»–
    accident_level TINYINT NOT NULL,              -- äº‹æ•…ç­‰çº§ï¼š1è½»å¾® 2ä¸€èˆ¬ 3è¾ƒå¤§ 4é‡å¤§

    -- äº‹æ•…åœ°ç‚¹
    accident_location NVARCHAR(200),              -- äº‹æ•…åœ°ç‚¹
    equipment_id BIGINT,                          -- ç›¸å…³è®¾å¤‡ID

    -- äº‹æ•…æè¿°
    accident_description NTEXT NOT NULL,          -- äº‹æ•…ç»è¿‡
    accident_cause NTEXT,                         -- äº‹æ•…åŸå› 
    accident_photos NTEXT,                        -- äº‹æ•…ç°åœºç…§ç‰‡
    accident_videos NTEXT,                        -- äº‹æ•…ç°åœºè§†é¢‘

    -- äººå‘˜ä¼¤äº¡
    injured_count INT DEFAULT 0,                  -- å—ä¼¤äººæ•°
    death_count INT DEFAULT 0,                    -- æ­»äº¡äººæ•°
    injured_persons NTEXT,                        -- å—ä¼¤äººå‘˜ä¿¡æ¯(JSON)

    -- ç»æµæŸå¤±
    direct_loss DECIMAL(12,2) DEFAULT 0,          -- ç›´æ¥ç»æµæŸå¤±
    indirect_loss DECIMAL(12,2) DEFAULT 0,        -- é—´æ¥ç»æµæŸå¤±

    -- åº”æ€¥å¤„ç†
    emergency_measures NTEXT,                     -- åº”æ€¥å¤„ç†æªæ–½
    rescue_persons NTEXT,                         -- æ•‘æ´äººå‘˜

    -- äº‹æ•…è°ƒæŸ¥
    investigation_team NTEXT,                     -- è°ƒæŸ¥ç»„æˆå‘˜
    investigation_report NTEXT,                   -- è°ƒæŸ¥æŠ¥å‘Š
    responsibility_analysis NTEXT,                -- è´£ä»»åˆ†æ

    -- æ•´æ”¹æªæ–½
    corrective_measures NTEXT,                    -- çº æ­£æªæ–½
    preventive_measures NTEXT,                    -- é¢„é˜²æªæ–½

    -- å¤„ç†çŠ¶æ€
    handle_status TINYINT DEFAULT 1,              -- å¤„ç†çŠ¶æ€ï¼š1å¾…å¤„ç† 2å¤„ç†ä¸­ 3å·²å¤„ç† 4å·²ç»“æ¡ˆ

    -- æŠ¥å‘Šäºº
    reporter_id BIGINT,                           -- æŠ¥å‘ŠäººID
    report_time DATETIME,                         -- æŠ¥å‘Šæ—¶é—´

    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 5. ç…¤è´¨ç®¡ç†æ¨¡å—æ•°æ®è¡¨

#### 5.1 ç…¤è´¨æ£€æµ‹æ•°æ®è¡¨ (coal_quality_test_data)
```sql
CREATE TABLE coal_quality_test_data (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    test_code NVARCHAR(50) NOT NULL,              -- æ£€æµ‹ç¼–å·
    test_date DATE NOT NULL,                      -- æ£€æµ‹æ—¥æœŸ
    shift_id BIGINT,                              -- ç­æ¬¡ID
    test_type TINYINT NOT NULL,                   -- æ£€æµ‹ç±»å‹ï¼š1å¿«ç° 2å¿«æ°´ 3å¿«æµ® 4ç­ç° 5å…¨åˆ†æ

    -- æ ·å“ä¿¡æ¯
    sample_source TINYINT NOT NULL,               -- æ ·å“æ¥æºï¼š1åŸç…¤ 2ç²¾ç…¤ 3ä¸­ç…¤ 4ç…¤æ³¥ 5çŸ¸çŸ³
    sample_location NVARCHAR(100),                -- å–æ ·åœ°ç‚¹
    sample_person_id BIGINT,                      -- å–æ ·äººID
    sample_time DATETIME,                         -- å–æ ·æ—¶é—´

    -- æ£€æµ‹é¡¹ç›®
    ash_content DECIMAL(5,2),                     -- ç°åˆ†(%)
    moisture_content DECIMAL(5,2),                -- æ°´åˆ†(%)
    volatile_matter DECIMAL(5,2),                 -- æŒ¥å‘åˆ†(%)
    fixed_carbon DECIMAL(5,2),                    -- å›ºå®šç¢³(%)
    sulfur_content DECIMAL(5,2),                  -- ç¡«åˆ†(%)
    calorific_value DECIMAL(8,2),                 -- å‘çƒ­é‡(cal/g)

    -- æµ®é€‰è¯•éªŒæ•°æ®
    float_test_density DECIMAL(4,2),              -- æµ®é€‰å¯†åº¦
    float_test_yield DECIMAL(5,2),                -- æµ®é€‰äº§ç‡(%)
    float_test_ash DECIMAL(5,2),                  -- æµ®é€‰ç°åˆ†(%)

    -- æ£€æµ‹äººå‘˜
    tester_id BIGINT,                             -- æ£€æµ‹äººå‘˜ID
    test_time DATETIME,                           -- æ£€æµ‹æ—¶é—´
    test_equipment NVARCHAR(100),                 -- æ£€æµ‹è®¾å¤‡

    -- æ£€æµ‹ç»“æœ
    test_result TINYINT DEFAULT 1,                -- æ£€æµ‹ç»“æœï¼š1åˆæ ¼ 2ä¸åˆæ ¼
    result_description NVARCHAR(500),             -- ç»“æœè¯´æ˜

    -- æ•°æ®æ¥æº
    data_source TINYINT DEFAULT 1,                -- æ•°æ®æ¥æºï¼š1äººå·¥å½•å…¥ 2è®¾å¤‡é‡‡é›† 3åŒ–éªŒå®¤

    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 5.2 äº§å“é”€å”®è´¨é‡è¡¨ (coal_product_sales_quality)
```sql
CREATE TABLE coal_product_sales_quality (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    sales_date DATE NOT NULL,                     -- é”€å”®æ—¥æœŸ
    product_type TINYINT NOT NULL,                -- äº§å“ç±»å‹ï¼š1ç²¾ç…¤ 2ä¸­ç…¤ 3ç…¤æ³¥
    customer_id BIGINT,                           -- å®¢æˆ·ID
    transport_type TINYINT,                       -- è¿è¾“æ–¹å¼ï¼š1æ±½è¿ 2é“è¿ 3æ°´è¿

    -- é”€å”®æ•°é‡
    sales_quantity DECIMAL(10,2),                 -- é”€å”®æ•°é‡(å¨)
    unit_price DECIMAL(8,2),                      -- å•ä»·(å…ƒ/å¨)
    total_amount DECIMAL(12,2),                   -- æ€»é‡‘é¢

    -- è´¨é‡æŒ‡æ ‡
    ash_content DECIMAL(5,2),                     -- ç°åˆ†(%)
    moisture_content DECIMAL(5,2),                -- æ°´åˆ†(%)
    sulfur_content DECIMAL(5,2),                  -- ç¡«åˆ†(%)
    calorific_value DECIMAL(8,2),                 -- å‘çƒ­é‡(cal/g)

    -- è´¨é‡è¯„ä»·
    quality_grade NVARCHAR(20),                   -- è´¨é‡ç­‰çº§
    is_qualified BIT DEFAULT 1,                   -- æ˜¯å¦åˆæ ¼
    quality_feedback NTEXT,                       -- å®¢æˆ·è´¨é‡åé¦ˆ

    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 6. ç³»ç»ŸåŸºç¡€æ•°æ®è¡¨

#### 6.1 ç”Ÿäº§ç³»ç»Ÿè¡¨ (coal_production_system)
```sql
CREATE TABLE coal_production_system (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    system_name NVARCHAR(100) NOT NULL,           -- ç³»ç»Ÿåç§°
    system_code NVARCHAR(50) NOT NULL,            -- ç³»ç»Ÿç¼–ç 
    system_type TINYINT NOT NULL,                 -- ç³»ç»Ÿç±»å‹ï¼š1ä¸»æ´—ç³»ç»Ÿ 2æµ®é€‰ç³»ç»Ÿ 3å‹æ»¤ç³»ç»Ÿ
    design_capacity DECIMAL(10,2),                -- è®¾è®¡å¤„ç†èƒ½åŠ›(t/h)

    -- å·¥è‰ºå‚æ•°
    process_flow NTEXT,                           -- å·¥è‰ºæµç¨‹æè¿°
    key_equipment NTEXT,                          -- å…³é”®è®¾å¤‡åˆ—è¡¨(JSON)

    -- ç³»ç»ŸçŠ¶æ€
    system_status TINYINT DEFAULT 1,              -- ç³»ç»ŸçŠ¶æ€ï¼š1æ­£å¸¸ 2æ•…éšœ 3æ£€ä¿® 4åœç”¨

    -- è´Ÿè´£äºº
    manager_id BIGINT,                            -- ç³»ç»Ÿè´Ÿè´£äººID
    operator_ids NTEXT,                           -- æ“ä½œäººå‘˜IDåˆ—è¡¨(JSON)

    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 6.2 è½¦é—´éƒ¨é—¨è¡¨ (coal_workshop)
```sql
CREATE TABLE coal_workshop (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    workshop_name NVARCHAR(100) NOT NULL,         -- è½¦é—´åç§°
    workshop_code NVARCHAR(50) NOT NULL,          -- è½¦é—´ç¼–ç 
    workshop_type TINYINT NOT NULL,               -- è½¦é—´ç±»å‹ï¼š1ç”Ÿäº§è½¦é—´ 2è¾…åŠ©è½¦é—´ 3ç®¡ç†éƒ¨é—¨
    parent_id BIGINT DEFAULT 0,                   -- çˆ¶çº§éƒ¨é—¨ID

    -- è½¦é—´ä¿¡æ¯
    description NVARCHAR(500),                    -- è½¦é—´æè¿°
    location NVARCHAR(200),                       -- è½¦é—´ä½ç½®
    area_size DECIMAL(10,2),                      -- è½¦é—´é¢ç§¯(mÂ²)

    -- è´Ÿè´£äºº
    manager_id BIGINT,                            -- è½¦é—´ä¸»ä»»ID
    deputy_manager_id BIGINT,                     -- å‰¯ä¸»ä»»ID

    -- è”ç³»æ–¹å¼
    phone NVARCHAR(20),                           -- è”ç³»ç”µè¯
    email NVARCHAR(100),                          -- é‚®ç®±

    -- åŸºç¡€å­—æ®µ
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

---

## ğŸ”§ åç«¯å¼€å‘åŠŸèƒ½è¯¦è§£ï¼ˆç»­ï¼‰

### 4. å®‰å…¨ç®¡ç†æ¨¡å— (yudao-module-coal-safety)

#### 4.1 å®‰å…¨æ£€æŸ¥ç®¡ç†
**Controller æ¥å£ï¼š**
- `POST /coal/safety/inspection/create` - åˆ›å»ºå®‰å…¨æ£€æŸ¥è®°å½•
- `PUT /coal/safety/inspection/update` - æ›´æ–°æ£€æŸ¥è®°å½•
- `GET /coal/safety/inspection/page` - åˆ†é¡µæŸ¥è¯¢æ£€æŸ¥è®°å½•
- `POST /coal/safety/inspection/upload-media` - ä¸Šä¼ æ£€æŸ¥ç…§ç‰‡/è§†é¢‘
- `POST /coal/safety/inspection/rectify` - æäº¤æ•´æ”¹ç»“æœ
- `POST /coal/safety/inspection/verify` - éªŒæ”¶æ•´æ”¹ç»“æœ

**Service ä¸šåŠ¡é€»è¾‘ï¼š**
```java
@Service
public class SafetyInspectionServiceImpl extends ServiceExceptionUtil implements SafetyInspectionService {

    /**
     * åˆ›å»ºå®‰å…¨æ£€æŸ¥è®°å½•
     */
    @Override
    @Transactional
    public Long createInspection(SafetyInspectionCreateReqVO reqVO) {
        // 1. ç”Ÿæˆæ£€æŸ¥ç¼–å·
        String inspectionCode = generateInspectionCode();

        // 2. åˆ›å»ºæ£€æŸ¥è®°å½•
        SafetyInspectionDO inspection = BeanUtils.toBean(reqVO, SafetyInspectionDO.class);
        inspection.setInspectionCode(inspectionCode);
        inspection.setInspectionStatus(InspectionStatusEnum.PENDING_RECTIFICATION.getStatus());

        safetyInspectionMapper.insert(inspection);

        // 3. å¦‚æœæœ‰é—®é¢˜ï¼Œæ¨é€æ•´æ”¹é€šçŸ¥
        if (CollUtil.isNotEmpty(reqVO.getProblems())) {
            pushRectificationNotice(inspection);
        }

        return inspection.getId();
    }

    /**
     * æ¨é€æ•´æ”¹é€šçŸ¥
     */
    private void pushRectificationNotice(SafetyInspectionDO inspection) {
        // æ„å»ºé€šçŸ¥å†…å®¹
        NotificationReqVO notification = new NotificationReqVO();
        notification.setTitle("å®‰å…¨æ£€æŸ¥æ•´æ”¹é€šçŸ¥");
        notification.setContent(String.format("æ£€æŸ¥ç¼–å·ï¼š%sï¼Œè¯·åŠæ—¶æ•´æ”¹", inspection.getInspectionCode()));
        notification.setRecipientId(inspection.getRectificationPersonId());
        notification.setType(NotificationTypeEnum.SAFETY_RECTIFICATION.getType());

        // å‘é€é€šçŸ¥
        notificationService.sendNotification(notification);
    }
}
```

#### 4.2 äº‹æ•…ç®¡ç†
**Service ä¸šåŠ¡é€»è¾‘ï¼š**
```java
@Service
public class SafetyAccidentServiceImpl extends ServiceExceptionUtil implements SafetyAccidentService {

    /**
     * åˆ›å»ºäº‹æ•…è®°å½•
     */
    @Override
    @Transactional
    public Long createAccident(SafetyAccidentCreateReqVO reqVO) {
        // 1. ç”Ÿæˆäº‹æ•…ç¼–å·
        String accidentCode = generateAccidentCode(reqVO.getAccidentLevel());

        // 2. åˆ›å»ºäº‹æ•…è®°å½•
        SafetyAccidentDO accident = BeanUtils.toBean(reqVO, SafetyAccidentDO.class);
        accident.setAccidentCode(accidentCode);
        accident.setHandleStatus(AccidentHandleStatusEnum.PENDING.getStatus());

        safetyAccidentMapper.insert(accident);

        // 3. æ ¹æ®äº‹æ•…ç­‰çº§æ¨é€ç´§æ€¥é€šçŸ¥
        pushEmergencyNotification(accident);

        // 4. è‡ªåŠ¨å¯åŠ¨åº”æ€¥é¢„æ¡ˆ
        if (accident.getAccidentLevel() >= AccidentLevelEnum.MAJOR.getLevel()) {
            emergencyPlanService.activateEmergencyPlan(accident.getId());
        }

        return accident.getId();
    }

    /**
     * äº‹æ•…ç»Ÿè®¡åˆ†æ
     */
    @Override
    public AccidentStatisticsVO getAccidentStatistics(AccidentStatisticsReqVO reqVO) {
        AccidentStatisticsVO statistics = new AccidentStatisticsVO();

        // 1. æŒ‰äº‹æ•…ç±»å‹ç»Ÿè®¡
        List<AccidentTypeStatisticsVO> typeStats = safetyAccidentMapper.statisticsByType(reqVO);
        statistics.setTypeStatistics(typeStats);

        // 2. æŒ‰äº‹æ•…ç­‰çº§ç»Ÿè®¡
        List<AccidentLevelStatisticsVO> levelStats = safetyAccidentMapper.statisticsByLevel(reqVO);
        statistics.setLevelStatistics(levelStats);

        // 3. äº‹æ•…è¶‹åŠ¿åˆ†æ
        List<AccidentTrendVO> trendData = safetyAccidentMapper.getAccidentTrend(reqVO);
        statistics.setTrendData(trendData);

        // 4. è®¡ç®—äº‹æ•…ç‡
        BigDecimal accidentRate = calculateAccidentRate(reqVO);
        statistics.setAccidentRate(accidentRate);

        return statistics;
    }
}
```

### 5. ç…¤è´¨ç®¡ç†æ¨¡å— (yudao-module-coal-quality)

#### 5.1 ç…¤è´¨æ£€æµ‹æ•°æ®ç®¡ç†
**Controller æ¥å£ï¼š**
- `POST /coal/quality/test-data/create` - å½•å…¥æ£€æµ‹æ•°æ®
- `PUT /coal/quality/test-data/update` - æ›´æ–°æ£€æµ‹æ•°æ®
- `GET /coal/quality/test-data/page` - åˆ†é¡µæŸ¥è¯¢æ£€æµ‹æ•°æ®
- `GET /coal/quality/test-data/realtime` - è·å–å®æ—¶æ£€æµ‹æ•°æ®
- `POST /coal/quality/test-data/batch-import` - æ‰¹é‡å¯¼å…¥æ£€æµ‹æ•°æ®
- `GET /coal/quality/test-data/export` - å¯¼å‡ºæ£€æµ‹æ•°æ®

**Service ä¸šåŠ¡é€»è¾‘ï¼š**
```java
@Service
public class QualityTestDataServiceImpl extends ServiceExceptionUtil implements QualityTestDataService {

    /**
     * å½•å…¥æ£€æµ‹æ•°æ®
     */
    @Override
    @Transactional
    public Long createTestData(QualityTestDataCreateReqVO reqVO) {
        // 1. ç”Ÿæˆæ£€æµ‹ç¼–å·
        String testCode = generateTestCode(reqVO.getTestType());

        // 2. æ•°æ®æ ¡éªŒ
        validateTestData(reqVO);

        // 3. åˆ›å»ºæ£€æµ‹è®°å½•
        QualityTestDataDO testData = BeanUtils.toBean(reqVO, QualityTestDataDO.class);
        testData.setTestCode(testCode);

        // 4. è‡ªåŠ¨åˆ¤æ–­æ£€æµ‹ç»“æœ
        determineTestResult(testData);

        qualityTestDataMapper.insert(testData);

        // 5. å¦‚æœæ£€æµ‹ä¸åˆæ ¼ï¼Œå‘é€é¢„è­¦
        if (testData.getTestResult().equals(TestResultEnum.UNQUALIFIED.getResult())) {
            sendQualityAlert(testData);
        }

        return testData.getId();
    }

    /**
     * è´¨é‡ç»Ÿè®¡åˆ†æ
     */
    @Override
    public QualityStatisticsVO getQualityStatistics(QualityStatisticsReqVO reqVO) {
        QualityStatisticsVO statistics = new QualityStatisticsVO();

        // 1. ç°åˆ†ç»Ÿè®¡
        QualityTrendVO ashTrend = getQualityTrend(reqVO, "ash_content");
        statistics.setAshTrend(ashTrend);

        // 2. æ°´åˆ†ç»Ÿè®¡
        QualityTrendVO moistureTrend = getQualityTrend(reqVO, "moisture_content");
        statistics.setMoistureTrend(moistureTrend);

        // 3. åˆæ ¼ç‡ç»Ÿè®¡
        BigDecimal qualificationRate = calculateQualificationRate(reqVO);
        statistics.setQualificationRate(qualificationRate);

        // 4. ç¨³å®šæ€§åˆ†æ
        QualityStabilityVO stability = analyzeQualityStability(reqVO);
        statistics.setStability(stability);

        return statistics;
    }

    /**
     * è‡ªåŠ¨åˆ¤æ–­æ£€æµ‹ç»“æœ
     */
    private void determineTestResult(QualityTestDataDO testData) {
        // æ ¹æ®äº§å“æ ‡å‡†åˆ¤æ–­æ˜¯å¦åˆæ ¼
        ProductStandardDO standard = productStandardMapper.selectByProductType(testData.getSampleSource());

        boolean isQualified = true;

        // æ£€æŸ¥ç°åˆ†
        if (testData.getAshContent() != null && standard.getMaxAshContent() != null) {
            if (testData.getAshContent().compareTo(standard.getMaxAshContent()) > 0) {
                isQualified = false;
            }
        }

        // æ£€æŸ¥æ°´åˆ†
        if (testData.getMoistureContent() != null && standard.getMaxMoistureContent() != null) {
            if (testData.getMoistureContent().compareTo(standard.getMaxMoistureContent()) > 0) {
                isQualified = false;
            }
        }

        // æ£€æŸ¥ç¡«åˆ†
        if (testData.getSulfurContent() != null && standard.getMaxSulfurContent() != null) {
            if (testData.getSulfurContent().compareTo(standard.getMaxSulfurContent()) > 0) {
                isQualified = false;
            }
        }

        testData.setTestResult(isQualified ? TestResultEnum.QUALIFIED.getResult() : TestResultEnum.UNQUALIFIED.getResult());
    }
}
```

---

## ğŸ¨ å‰ç«¯å¼€å‘åŠŸèƒ½è¯¦è§£ï¼ˆç»­ï¼‰

### 3. å®‰å…¨ç®¡ç†å‰ç«¯

#### 3.1 å®‰å…¨æ£€æŸ¥é¡µé¢
**é¡µé¢è·¯å¾„ï¼š** `src/views/coal/safety/inspection/index.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- æ£€æŸ¥è®°å½•åˆ—è¡¨å±•ç¤º
- æ£€æŸ¥è¡¨å•å½•å…¥ï¼ˆæ”¯æŒæ‹ç…§ã€å½•éŸ³ã€å½•åƒï¼‰
- æ•´æ”¹ä»»åŠ¡åˆ†é…
- æ•´æ”¹è¿›åº¦è·Ÿè¸ª
- éªŒæ”¶ç»“æœç¡®è®¤

**å…³é”®ç»„ä»¶ï¼š**
```vue
<template>
  <div class="safety-inspection">
    <!-- æ£€æŸ¥è®°å½•è¡¨å• -->
    <el-form :model="inspectionForm" :rules="inspectionRules">
      <el-form-item label="æ£€æŸ¥ç±»å‹" prop="inspectionType">
        <el-select v-model="inspectionForm.inspectionType">
          <el-option label="æ—¥å¸¸æ£€æŸ¥" :value="1" />
          <el-option label="ä¸“é¡¹æ£€æŸ¥" :value="2" />
          <el-option label="éšæ‚£æ’æŸ¥" :value="3" />
        </el-select>
      </el-form-item>

      <el-form-item label="æ£€æŸ¥åŒºåŸŸ" prop="areaId">
        <el-cascader
          v-model="inspectionForm.areaId"
          :options="areaOptions"
          :props="{ checkStrictly: true }"
        />
      </el-form-item>

      <el-form-item label="é—®é¢˜æè¿°" prop="problemDescription">
        <el-input
          v-model="inspectionForm.problemDescription"
          type="textarea"
          :rows="4"
        />
      </el-form-item>

      <!-- å¤šåª’ä½“ä¸Šä¼  -->
      <el-form-item label="é—®é¢˜ç…§ç‰‡">
        <el-upload
          :action="uploadUrl"
          list-type="picture-card"
          :on-success="handlePhotoSuccess"
          :before-upload="beforePhotoUpload"
        >
          <el-icon><Plus /></el-icon>
        </el-upload>
      </el-form-item>

      <el-form-item label="è¯­éŸ³è®°å½•">
        <voice-recorder @on-record="handleVoiceRecord" />
      </el-form-item>

      <el-form-item label="æ•´æ”¹è¦æ±‚" prop="rectificationRequirement">
        <el-input
          v-model="inspectionForm.rectificationRequirement"
          type="textarea"
          :rows="3"
        />
      </el-form-item>

      <el-form-item label="æ•´æ”¹æœŸé™" prop="rectificationDeadline">
        <el-date-picker
          v-model="inspectionForm.rectificationDeadline"
          type="date"
        />
      </el-form-item>

      <el-form-item label="æ•´æ”¹è´£ä»»äºº" prop="rectificationPersonId">
        <user-selector v-model="inspectionForm.rectificationPersonId" />
      </el-form-item>
    </el-form>

    <!-- æ£€æŸ¥è®°å½•åˆ—è¡¨ -->
    <el-table :data="inspectionList" v-loading="loading">
      <el-table-column prop="inspectionCode" label="æ£€æŸ¥ç¼–å·" />
      <el-table-column prop="inspectionDate" label="æ£€æŸ¥æ—¥æœŸ" />
      <el-table-column prop="inspectionTypeName" label="æ£€æŸ¥ç±»å‹" />
      <el-table-column prop="riskLevelName" label="é£é™©ç­‰çº§">
        <template #default="{ row }">
          <el-tag :type="getRiskLevelType(row.riskLevel)">
            {{ row.riskLevelName }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="inspectionStatusName" label="çŠ¶æ€" />
      <el-table-column label="æ“ä½œ">
        <template #default="{ row }">
          <el-button @click="handleView(row)">æŸ¥çœ‹</el-button>
          <el-button
            v-if="row.inspectionStatus === 1"
            @click="handleRectify(row)"
          >
            æ•´æ”¹
          </el-button>
          <el-button
            v-if="row.inspectionStatus === 3"
            @click="handleVerify(row)"
          >
            éªŒæ”¶
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script lang="ts" setup>
import { ref, reactive, onMounted } from 'vue'
import * as SafetyApi from '@/api/coal/safety'
import VoiceRecorder from '@/components/VoiceRecorder/index.vue'
import UserSelector from '@/components/UserSelector/index.vue'

// å“åº”å¼æ•°æ®
const loading = ref(false)
const inspectionList = ref([])
const inspectionForm = reactive({
  inspectionType: null,
  areaId: null,
  problemDescription: '',
  rectificationRequirement: '',
  rectificationDeadline: null,
  rectificationPersonId: null
})

// è¡¨å•æ ¡éªŒè§„åˆ™
const inspectionRules = {
  inspectionType: [{ required: true, message: 'è¯·é€‰æ‹©æ£€æŸ¥ç±»å‹', trigger: 'change' }],
  areaId: [{ required: true, message: 'è¯·é€‰æ‹©æ£€æŸ¥åŒºåŸŸ', trigger: 'change' }],
  problemDescription: [{ required: true, message: 'è¯·è¾“å…¥é—®é¢˜æè¿°', trigger: 'blur' }]
}

// è·å–æ£€æŸ¥è®°å½•åˆ—è¡¨
const getInspectionList = async () => {
  loading.value = true
  try {
    const data = await SafetyApi.getInspectionPage(queryParams)
    inspectionList.value = data.list
  } finally {
    loading.value = false
  }
}

// å¤„ç†è¯­éŸ³è®°å½•
const handleVoiceRecord = (voiceUrl: string) => {
  inspectionForm.voiceRecord = voiceUrl
}

// é£é™©ç­‰çº§æ ·å¼
const getRiskLevelType = (level: number) => {
  const types = { 1: 'info', 2: 'warning', 3: 'danger', 4: 'danger' }
  return types[level] || 'info'
}

onMounted(() => {
  getInspectionList()
})
</script>
```

#### 3.2 å®‰å…¨çœ‹æ¿é¡µé¢
**é¡µé¢è·¯å¾„ï¼š** `src/views/coal/safety/dashboard/index.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- å®‰å…¨æŒ‡æ ‡å¡ç‰‡å±•ç¤º
- äº‹æ•…ç»Ÿè®¡å›¾è¡¨
- éšæ‚£æ•´æ”¹è¿›åº¦
- å®‰å…¨æ£€æŸ¥å®Œæˆç‡
- å®æ—¶å®‰å…¨çŠ¶æ€ç›‘æ§

### 4. ç…¤è´¨ç®¡ç†å‰ç«¯

#### 4.1 ç…¤è´¨æ£€æµ‹æ•°æ®å½•å…¥é¡µé¢
**é¡µé¢è·¯å¾„ï¼š** `src/views/coal/quality/test-data/index.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- æ£€æµ‹æ•°æ®å½•å…¥è¡¨å•
- æ£€æµ‹ç»“æœè‡ªåŠ¨åˆ¤æ–­
- å†å²æ£€æµ‹æ•°æ®æŸ¥è¯¢
- è´¨é‡è¶‹åŠ¿å›¾è¡¨å±•ç¤º
- ä¸åˆæ ¼æ•°æ®é¢„è­¦

#### 4.2 è´¨é‡ç»Ÿè®¡åˆ†æé¡µé¢
**é¡µé¢è·¯å¾„ï¼š** `src/views/coal/quality/statistics/index.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- è´¨é‡æŒ‡æ ‡è¶‹åŠ¿å›¾
- åˆæ ¼ç‡ç»Ÿè®¡å›¾è¡¨
- è´¨é‡ç¨³å®šæ€§åˆ†æ
- äº§å“è´¨é‡å¯¹æ¯”
- è´¨é‡å¼‚å¸¸é¢„è­¦

---

## ğŸ“± ç§»åŠ¨ç«¯å¼€å‘è¯¦è§£

### 1. æŠ€æœ¯æ¶æ„
**æ¡†æ¶é€‰æ‹©ï¼š** uni-app + Vue 3 + TypeScript
**UIç»„ä»¶ï¼š** uni-ui + è‡ªå®šä¹‰ç»„ä»¶
**çŠ¶æ€ç®¡ç†ï¼š** Pinia
**ç½‘ç»œè¯·æ±‚ï¼š** uni.request å°è£…

### 2. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 2.1 è®¾å¤‡å·¡æ£€æ¨¡å—
```vue
<!-- pages/equipment/inspection/index.vue -->
<template>
  <view class="inspection-page">
    <!-- æ‰«ç å…¥å£ -->
    <view class="scan-section">
      <button @click="scanQRCode" class="scan-btn">
        <uni-icons type="scan" size="30"></uni-icons>
        <text>æ‰«ç å·¡æ£€</text>
      </button>
    </view>

    <!-- å·¡æ£€è¡¨å• -->
    <uni-forms :model="inspectionForm" :rules="rules" ref="form">
      <uni-forms-item label="è®¾å¤‡åç§°" name="equipmentName">
        <uni-easyinput v-model="inspectionForm.equipmentName" disabled />
      </uni-forms-item>

      <uni-forms-item label="å·¡æ£€é¡¹ç›®" name="inspectionItems">
        <view class="inspection-items">
          <view
            v-for="item in inspectionItems"
            :key="item.id"
            class="inspection-item"
          >
            <text>{{ item.name }}</text>
            <uni-data-checkbox
              v-model="item.result"
              :localdata="[{value: 1, text: 'æ­£å¸¸'}, {value: 0, text: 'å¼‚å¸¸'}]"
            />
          </view>
        </view>
      </uni-forms-item>

      <uni-forms-item label="å¼‚å¸¸æè¿°" name="abnormalDescription">
        <uni-easyinput
          v-model="inspectionForm.abnormalDescription"
          type="textarea"
          placeholder="è¯·æè¿°å‘ç°çš„å¼‚å¸¸æƒ…å†µ"
        />
      </uni-forms-item>

      <uni-forms-item label="ç°åœºç…§ç‰‡">
        <view class="photo-upload">
          <view
            v-for="(photo, index) in photos"
            :key="index"
            class="photo-item"
          >
            <image :src="photo" mode="aspectFill" />
            <view class="photo-delete" @click="deletePhoto(index)">
              <uni-icons type="clear" size="16" color="#fff" />
            </view>
          </view>
          <view class="photo-add" @click="chooseImage">
            <uni-icons type="camera" size="30" />
            <text>æ·»åŠ ç…§ç‰‡</text>
          </view>
        </view>
      </uni-forms-item>
    </uni-forms>

    <view class="submit-section">
      <button @click="submitInspection" class="submit-btn">æäº¤å·¡æ£€</button>
    </view>
  </view>
</template>

<script lang="ts" setup>
import { ref, reactive } from 'vue'
import * as EquipmentApi from '@/api/equipment'

// å“åº”å¼æ•°æ®
const inspectionForm = reactive({
  equipmentId: '',
  equipmentName: '',
  abnormalDescription: ''
})

const inspectionItems = ref([])
const photos = ref([])

// æ‰«ç åŠŸèƒ½
const scanQRCode = () => {
  uni.scanCode({
    success: async (res) => {
      try {
        // è§£æäºŒç»´ç è·å–è®¾å¤‡ä¿¡æ¯
        const equipmentInfo = await EquipmentApi.getEquipmentByQRCode(res.result)
        inspectionForm.equipmentId = equipmentInfo.id
        inspectionForm.equipmentName = equipmentInfo.name

        // è·å–å·¡æ£€é¡¹ç›®
        const items = await EquipmentApi.getInspectionItems(equipmentInfo.id)
        inspectionItems.value = items
      } catch (error) {
        uni.showToast({
          title: 'è®¾å¤‡ä¿¡æ¯è·å–å¤±è´¥',
          icon: 'error'
        })
      }
    }
  })
}

// é€‰æ‹©å›¾ç‰‡
const chooseImage = () => {
  uni.chooseImage({
    count: 9 - photos.value.length,
    success: (res) => {
      photos.value.push(...res.tempFilePaths)
    }
  })
}

// æäº¤å·¡æ£€
const submitInspection = async () => {
  try {
    // ä¸Šä¼ ç…§ç‰‡
    const photoUrls = await uploadPhotos()

    // æäº¤å·¡æ£€æ•°æ®
    const inspectionData = {
      ...inspectionForm,
      inspectionItems: inspectionItems.value,
      photos: photoUrls
    }

    await EquipmentApi.submitInspection(inspectionData)

    uni.showToast({
      title: 'æäº¤æˆåŠŸ',
      icon: 'success'
    })

    // è¿”å›ä¸Šä¸€é¡µ
    uni.navigateBack()
  } catch (error) {
    uni.showToast({
      title: 'æäº¤å¤±è´¥',
      icon: 'error'
    })
  }
}
</script>
```

#### 2.2 æ•…éšœæŠ¥ä¿®æ¨¡å—
```vue
<!-- pages/equipment/repair/index.vue -->
<template>
  <view class="repair-page">
    <uni-forms :model="repairForm" :rules="rules" ref="form">
      <uni-forms-item label="æ•…éšœè®¾å¤‡" name="equipmentId">
        <uni-data-select
          v-model="repairForm.equipmentId"
          :localdata="equipmentOptions"
          placeholder="è¯·é€‰æ‹©æ•…éšœè®¾å¤‡"
        />
      </uni-forms-item>

      <uni-forms-item label="æ•…éšœç±»å‹" name="faultType">
        <uni-data-checkbox
          v-model="repairForm.faultType"
          :localdata="faultTypeOptions"
        />
      </uni-forms-item>

      <uni-forms-item label="æ•…éšœæè¿°" name="faultDescription">
        <uni-easyinput
          v-model="repairForm.faultDescription"
          type="textarea"
          placeholder="è¯·è¯¦ç»†æè¿°æ•…éšœç°è±¡"
        />
      </uni-forms-item>

      <uni-forms-item label="ç´§æ€¥ç¨‹åº¦" name="urgencyLevel">
        <uni-data-checkbox
          v-model="repairForm.urgencyLevel"
          :localdata="urgencyOptions"
        />
      </uni-forms-item>

      <uni-forms-item label="ç°åœºç…§ç‰‡">
        <view class="media-upload">
          <view class="photo-section">
            <view
              v-for="(photo, index) in photos"
              :key="index"
              class="media-item"
            >
              <image :src="photo" mode="aspectFill" />
              <view class="media-delete" @click="deletePhoto(index)">Ã—</view>
            </view>
            <view class="media-add" @click="chooseImage">
              <uni-icons type="camera" size="30" />
              <text>æ‹ç…§</text>
            </view>
          </view>
        </view>
      </uni-forms-item>

      <uni-forms-item label="ç°åœºå½•éŸ³">
        <view class="voice-section">
          <button
            @click="startRecord"
            :disabled="isRecording"
            class="record-btn"
          >
            {{ isRecording ? 'å½•éŸ³ä¸­...' : 'å¼€å§‹å½•éŸ³' }}
          </button>
          <button
            @click="stopRecord"
            :disabled="!isRecording"
            class="stop-btn"
          >
            åœæ­¢å½•éŸ³
          </button>
          <view v-if="voiceUrl" class="voice-player">
            <button @click="playVoice">æ’­æ”¾å½•éŸ³</button>
          </view>
        </view>
      </uni-forms-item>
    </uni-forms>

    <view class="submit-section">
      <button @click="submitRepair" class="submit-btn">æäº¤æŠ¥ä¿®</button>
    </view>
  </view>
</template>

<script lang="ts" setup>
import { ref, reactive, onMounted } from 'vue'
import * as RepairApi from '@/api/repair'

// å“åº”å¼æ•°æ®
const repairForm = reactive({
  equipmentId: '',
  faultType: '',
  faultDescription: '',
  urgencyLevel: 1
})

const photos = ref([])
const voiceUrl = ref('')
const isRecording = ref(false)
const recorderManager = uni.getRecorderManager()

// å¼€å§‹å½•éŸ³
const startRecord = () => {
  isRecording.value = true
  recorderManager.start({
    duration: 60000, // æœ€é•¿60ç§’
    sampleRate: 16000,
    numberOfChannels: 1,
    encodeBitRate: 96000,
    format: 'mp3'
  })
}

// åœæ­¢å½•éŸ³
const stopRecord = () => {
  isRecording.value = false
  recorderManager.stop()
}

// å½•éŸ³äº‹ä»¶ç›‘å¬
recorderManager.onStop((res) => {
  voiceUrl.value = res.tempFilePath
})

// æäº¤æŠ¥ä¿®
const submitRepair = async () => {
  try {
    // ä¸Šä¼ ç…§ç‰‡å’Œå½•éŸ³
    const photoUrls = await uploadPhotos()
    const voiceFileUrl = voiceUrl.value ? await uploadVoice() : ''

    // æäº¤æŠ¥ä¿®æ•°æ®
    const repairData = {
      ...repairForm,
      photos: photoUrls,
      voiceUrl: voiceFileUrl
    }

    await RepairApi.submitRepair(repairData)

    uni.showToast({
      title: 'æŠ¥ä¿®æˆåŠŸ',
      icon: 'success'
    })

    uni.navigateBack()
  } catch (error) {
    uni.showToast({
      title: 'æŠ¥ä¿®å¤±è´¥',
      icon: 'error'
    })
  }
}
</script>
```

è¿™ä¸ªå¤§çº²æ¶µç›–äº†é€‰ç…¤å‚ç”Ÿäº§ç®¡ç†ç³»ç»Ÿçš„å®Œæ•´å¼€å‘æ–¹æ¡ˆï¼ŒåŒ…æ‹¬è¯¦ç»†çš„æ•°æ®åº“è®¾è®¡ã€åç«¯åŠŸèƒ½å¼€å‘ã€å‰ç«¯é¡µé¢å®ç°å’Œç§»åŠ¨ç«¯å¼€å‘ã€‚æˆ‘ä»¬å¯ä»¥æŒ‰ç…§è¿™ä¸ªå¤§çº²é€æ­¥å®æ–½å¼€å‘ã€‚
