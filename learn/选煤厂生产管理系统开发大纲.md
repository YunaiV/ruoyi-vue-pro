# 选煤厂生产管理系统开发大纲

## 🎯 项目概述

基于芋道开源框架开发的选煤厂智能生产管控系统，实现生产调度、设备管理、煤质管理、安全管理等全流程数字化管理。

### 技术架构
- **后端**：Spring Boot + MyBatis-Plus + SQL Server
- **前端**：Vue 3 + TypeScript + Element Plus
- **框架**：芋道开源框架 (ruoyi-vue-pro)
- **数据库**：SQL Server 2019+
- **部署**：Docker + Nginx

---

## 📊 系统架构设计

### 模块划分

```
yudao-module-coal/                    # 选煤厂核心模块
├── production/                       # 生产调度管理
├── equipment/                        # 设备档案管理  
├── quality/                          # 煤质管理
├── safety/                          # 安全管理
├── energy/                          # 能源管理
├── report/                          # 报表统计
└── common/                          # 公共组件
```

### 数据库设计原则
- 采用 SQL Server 数据库
- 遵循第三范式设计
- 支持多租户架构
- 预留扩展字段
- 建立完整的索引体系

---

## 🗄️ 数据库设计详解

### 1. 生产调度管理模块

#### 1.1 生产计划表 (coal_production_plan)
```sql
CREATE TABLE coal_production_plan (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    plan_code NVARCHAR(50) NOT NULL,              -- 计划编号
    plan_type TINYINT NOT NULL,                   -- 计划类型：1年度 2月度 3日计划 4班计划
    plan_year INT,                                -- 计划年度
    plan_month TINYINT,                           -- 计划月份
    plan_date DATE,                               -- 计划日期
    shift_id BIGINT,                              -- 班次ID
    
    -- 计划产量数据
    raw_coal_plan DECIMAL(10,2),                  -- 计划入洗原煤量(吨)
    clean_coal_plan DECIMAL(10,2),                -- 计划精煤产量(吨)
    middling_coal_plan DECIMAL(10,2),             -- 计划中煤产量(吨)
    slime_plan DECIMAL(10,2),                     -- 计划煤泥产量(吨)
    gangue_plan DECIMAL(10,2),                    -- 计划矸石产量(吨)
    
    -- 质量指标
    clean_coal_ash DECIMAL(5,2),                  -- 精煤灰分(%)
    middling_coal_ash DECIMAL(5,2),               -- 中煤灰分(%)
    
    -- 计划状态
    plan_status TINYINT DEFAULT 1,                -- 计划状态：1待执行 2执行中 3已完成 4已取消
    
    -- 审批信息
    creator_id BIGINT,                            -- 制定人ID
    approver_id BIGINT,                           -- 审批人ID
    approve_time DATETIME,                        -- 审批时间
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.2 产量报表 (coal_production_output)
```sql
CREATE TABLE coal_production_output (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    output_date DATE NOT NULL,                    -- 生产日期
    shift_id BIGINT NOT NULL,                     -- 班次ID
    system_id BIGINT,                             -- 生产系统ID
    
    -- 实际产量数据
    raw_coal_actual DECIMAL(10,2),                -- 实际入洗原煤量(吨)
    clean_coal_actual DECIMAL(10,2),              -- 实际精煤产量(吨)
    middling_coal_actual DECIMAL(10,2),           -- 实际中煤产量(吨)
    slime_actual DECIMAL(10,2),                   -- 实际煤泥产量(吨)
    gangue_actual DECIMAL(10,2),                  -- 实际矸石产量(吨)
    
    -- 质量数据
    clean_coal_ash_actual DECIMAL(5,2),           -- 实际精煤灰分(%)
    clean_coal_moisture DECIMAL(5,2),             -- 精煤水分(%)
    
    -- 效率指标
    clean_coal_yield DECIMAL(5,2),                -- 精煤产率(%)
    recovery_rate DECIMAL(5,2),                   -- 回收率(%)
    
    -- 运行时间
    coal_feeding_time INT,                        -- 带煤时间(分钟)
    stop_time INT,                                -- 停煤时间(分钟)
    
    -- 录入人员
    recorder_id BIGINT,                           -- 记录人ID
    record_time DATETIME,                         -- 记录时间
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.3 调度管理表 (coal_dispatch_record)
```sql
CREATE TABLE coal_dispatch_record (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    record_date DATE NOT NULL,                    -- 记录日期
    shift_id BIGINT NOT NULL,                     -- 班次ID
    dispatcher_id BIGINT NOT NULL,                -- 调度员ID
    
    -- 运转情况
    system_status NVARCHAR(500),                  -- 系统运转情况
    coal_type NVARCHAR(100),                      -- 入洗原煤类型
    
    -- 问题事故
    accident_description NTEXT,                   -- 事故描述
    accident_level TINYINT,                       -- 事故级别：1轻微 2一般 3严重 4重大
    accident_type TINYINT,                        -- 事故类型：1生产 2机电 3安全
    
    -- 指示内容
    instruction_content NTEXT,                    -- 上传下达指示内容
    instruction_from NVARCHAR(100),               -- 指示来源
    instruction_to NVARCHAR(100),                 -- 指示对象
    
    -- 交接班
    handover_issues NTEXT,                        -- 交接班遗留问题
    next_shift_notice NTEXT,                      -- 下班注意事项
    
    -- 停煤记录
    stop_reason NVARCHAR(200),                    -- 停煤原因
    stop_start_time DATETIME,                     -- 停煤开始时间
    stop_end_time DATETIME,                       -- 停煤结束时间
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.4 班次管理表 (coal_shift_config)
```sql
CREATE TABLE coal_shift_config (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    shift_name NVARCHAR(50) NOT NULL,             -- 班次名称
    shift_code NVARCHAR(20) NOT NULL,             -- 班次编码
    start_time TIME NOT NULL,                     -- 开始时间
    end_time TIME NOT NULL,                       -- 结束时间
    shift_type TINYINT NOT NULL,                  -- 班次类型：1生产班 2检修班 3值班
    is_production BIT DEFAULT 1,                  -- 是否生产班
    sort_order INT DEFAULT 0,                     -- 排序
    status TINYINT DEFAULT 1,                     -- 状态：0禁用 1启用
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.5 排班表 (coal_shift_schedule)
```sql
CREATE TABLE coal_shift_schedule (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    schedule_date DATE NOT NULL,                  -- 排班日期
    shift_id BIGINT NOT NULL,                     -- 班次ID
    user_id BIGINT NOT NULL,                      -- 员工ID
    position_type TINYINT NOT NULL,               -- 岗位类型：1调度员 2操作工 3检修工
    is_leader BIT DEFAULT 0,                      -- 是否班长
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 2. 设备档案管理模块

#### 2.1 设备基础信息表 (coal_equipment_info)
```sql
CREATE TABLE coal_equipment_info (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    equipment_code NVARCHAR(50) NOT NULL,         -- 设备编号
    equipment_name NVARCHAR(100) NOT NULL,        -- 设备名称
    equipment_type_id BIGINT NOT NULL,            -- 设备类型ID
    system_id BIGINT NOT NULL,                    -- 所属系统ID
    workshop_id BIGINT,                           -- 所属车间ID
    
    -- 设备基本信息
    model NVARCHAR(100),                          -- 设备型号
    manufacturer NVARCHAR(100),                   -- 制造厂商
    manufacture_date DATE,                        -- 制造日期
    install_date DATE,                            -- 安装日期
    commission_date DATE,                         -- 投产日期
    
    -- 技术参数
    rated_power DECIMAL(10,2),                    -- 额定功率(kW)
    rated_capacity DECIMAL(10,2),                 -- 额定处理能力(t/h)
    weight DECIMAL(10,2),                         -- 设备重量(t)
    dimensions NVARCHAR(100),                     -- 外形尺寸
    
    -- 设备状态
    equipment_status TINYINT DEFAULT 1,           -- 设备状态：1正常 2故障 3检修 4停用
    health_level TINYINT DEFAULT 1,               -- 健康等级：1优良 2良好 3注意 4异常
    
    -- 位置信息
    location NVARCHAR(200),                       -- 安装位置
    qr_code NVARCHAR(200),                        -- 二维码
    
    -- 责任人
    responsible_person_id BIGINT,                 -- 责任人ID
    maintenance_person_id BIGINT,                 -- 维护人ID
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 2.2 设备类型表 (coal_equipment_type)
```sql
CREATE TABLE coal_equipment_type (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    type_name NVARCHAR(100) NOT NULL,             -- 类型名称
    type_code NVARCHAR(50) NOT NULL,              -- 类型编码
    parent_id BIGINT DEFAULT 0,                   -- 父级ID
    level_path NVARCHAR(500),                     -- 层级路径
    sort_order INT DEFAULT 0,                     -- 排序
    description NVARCHAR(500),                    -- 描述
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 2.3 设备履历表 (coal_equipment_history)
```sql
CREATE TABLE coal_equipment_history (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    equipment_id BIGINT NOT NULL,                 -- 设备ID
    history_type TINYINT NOT NULL,                -- 履历类型：1购买 2安装 3维修 4保养 5改造 6报废
    history_date DATE NOT NULL,                   -- 履历日期
    
    -- 履历内容
    title NVARCHAR(200) NOT NULL,                 -- 履历标题
    description NTEXT,                            -- 详细描述
    cost DECIMAL(12,2),                           -- 费用
    supplier NVARCHAR(100),                       -- 供应商/承包商
    
    -- 维修相关
    fault_description NTEXT,                      -- 故障描述
    repair_method NTEXT,                          -- 维修方法
    replaced_parts NTEXT,                         -- 更换部件
    repair_person_id BIGINT,                      -- 维修人员ID
    
    -- 附件
    attachment_urls NTEXT,                        -- 附件URL列表(JSON)
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 3. 能源管理模块

#### 3.1 能源消耗记录表 (coal_energy_consumption)
```sql
CREATE TABLE coal_energy_consumption (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    record_date DATE NOT NULL,                    -- 记录日期
    shift_id BIGINT NOT NULL,                     -- 班次ID
    energy_type TINYINT NOT NULL,                 -- 能源类型：1电 2水 3介质 4药剂 5油料
    
    -- 消耗数据
    consumption_amount DECIMAL(12,2),             -- 消耗量
    unit NVARCHAR(20),                            -- 单位
    unit_price DECIMAL(8,4),                      -- 单价
    total_cost DECIMAL(12,2),                     -- 总费用
    
    -- 计量信息
    meter_reading_start DECIMAL(12,2),            -- 起始读数
    meter_reading_end DECIMAL(12,2),              -- 结束读数
    meter_id NVARCHAR(50),                        -- 计量表编号
    
    -- 录入信息
    recorder_id BIGINT,                           -- 记录人ID
    record_time DATETIME,                         -- 记录时间
    data_source TINYINT DEFAULT 1,                -- 数据来源：1人工录入 2自动采集
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

---

## 🔧 后端开发功能详解

### 1. 生产调度管理模块 (yudao-module-coal-production)

#### 1.1 生产计划管理
**Controller 接口：**
- `POST /coal/production/plan/create` - 创建生产计划
- `PUT /coal/production/plan/update` - 更新生产计划
- `DELETE /coal/production/plan/delete` - 删除生产计划
- `GET /coal/production/plan/page` - 分页查询生产计划
- `GET /coal/production/plan/get/{id}` - 获取计划详情
- `POST /coal/production/plan/approve` - 审批生产计划
- `POST /coal/production/plan/split` - 拆分计划(年度→月度→日计划)

**Service 业务逻辑：**
```java
@Service
public class ProductionPlanServiceImpl extends ServiceExceptionUtil implements ProductionPlanService {
    
    /**
     * 创建生产计划
     */
    @Override
    @Transactional
    public Long createPlan(PlanCreateReqVO reqVO) {
        // 1. 校验计划时间不冲突
        validatePlanTimeConflict(reqVO);
        
        // 2. 校验计划数据合理性
        validatePlanData(reqVO);
        
        // 3. 创建计划
        ProductionPlanDO plan = BeanUtils.toBean(reqVO, ProductionPlanDO.class);
        plan.setPlanCode(generatePlanCode(reqVO.getPlanType()));
        plan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());
        
        productionPlanMapper.insert(plan);
        return plan.getId();
    }
    
    /**
     * 拆分计划
     */
    @Override
    @Transactional
    public void splitPlan(Long planId, PlanSplitReqVO reqVO) {
        // 1. 获取父计划
        ProductionPlanDO parentPlan = validatePlanExists(planId);
        
        // 2. 根据拆分类型生成子计划
        List<ProductionPlanDO> childPlans = generateChildPlans(parentPlan, reqVO);
        
        // 3. 批量插入子计划
        productionPlanMapper.insertBatch(childPlans);
    }
}
```

#### 1.2 产量统计分析
**Service 业务逻辑：**
```java
@Service
public class ProductionStatisticsServiceImpl implements ProductionStatisticsService {
    
    /**
     * 生成产品平衡表
     */
    @Override
    public ProductBalanceVO generateProductBalance(ProductBalanceReqVO reqVO) {
        // 1. 查询时间段内的产量数据
        List<ProductionOutputDO> outputs = productionOutputMapper.selectByDateRange(
            reqVO.getStartDate(), reqVO.getEndDate());
        
        // 2. 计算平衡数据
        ProductBalanceVO balance = calculateProductBalance(outputs);
        
        // 3. 计算完成率
        calculateCompletionRate(balance, reqVO);
        
        return balance;
    }
    
    /**
     * 生成产率分析报告
     */
    @Override
    public YieldAnalysisVO analyzeYield(YieldAnalysisReqVO reqVO) {
        // 1. 查询产量数据
        List<ProductionOutputDO> outputs = getOutputsByCondition(reqVO);
        
        // 2. 计算各种产率
        YieldAnalysisVO analysis = new YieldAnalysisVO();
        analysis.setCleanCoalYield(calculateCleanCoalYield(outputs));
        analysis.setRecoveryRate(calculateRecoveryRate(outputs));
        analysis.setRejectRate(calculateRejectRate(outputs));
        
        // 3. 对比目标产率
        compareWithTarget(analysis, reqVO);
        
        return analysis;
    }
}
```

### 2. 设备管理模块 (yudao-module-coal-equipment)

#### 2.1 设备档案管理
**Controller 接口：**
- `POST /coal/equipment/create` - 创建设备档案
- `PUT /coal/equipment/update` - 更新设备信息
- `GET /coal/equipment/page` - 分页查询设备
- `GET /coal/equipment/get/{id}` - 获取设备详情
- `GET /coal/equipment/qrcode/{code}` - 通过二维码获取设备信息
- `POST /coal/equipment/upload-document` - 上传设备文档

#### 2.2 设备KPI统计
**Service 业务逻辑：**
```java
@Service
public class EquipmentKpiServiceImpl implements EquipmentKpiService {
    
    /**
     * 计算设备完好率
     */
    @Override
    public BigDecimal calculateIntactRate(KpiCalculateReqVO reqVO) {
        // 完好率 = 完好设备数 / 总设备数 * 100%
        long totalCount = equipmentMapper.countByCondition(reqVO);
        long intactCount = equipmentMapper.countByStatus(reqVO, EquipmentStatusEnum.NORMAL);
        
        return BigDecimal.valueOf(intactCount)
                .divide(BigDecimal.valueOf(totalCount), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
    }
    
    /**
     * 计算设备利用率
     */
    @Override
    public BigDecimal calculateUtilizationRate(KpiCalculateReqVO reqVO) {
        // 利用率 = 实际运行时间 / 计划运行时间 * 100%
        BigDecimal actualRunTime = getActualRunTime(reqVO);
        BigDecimal plannedRunTime = getPlannedRunTime(reqVO);
        
        return actualRunTime.divide(plannedRunTime, 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
    }
}
```

### 3. 煤质管理模块 (yudao-module-coal-quality)

#### 3.1 煤质检测数据管理
**Controller 接口：**
- `POST /coal/quality/test-data/create` - 录入检测数据
- `GET /coal/quality/test-data/page` - 分页查询检测数据
- `GET /coal/quality/test-data/realtime` - 获取实时检测数据
- `POST /coal/quality/test-data/batch-import` - 批量导入检测数据

---

## 🎨 前端开发功能详解

### 1. 生产调度管理前端

#### 1.1 生产计划管理页面
**页面路径：** `src/views/coal/production/plan/index.vue`

**功能特性：**
- 计划列表展示（支持年度/月度/日计划切换）
- 计划创建表单（支持模板选择）
- 计划拆分功能（年度→月度→日计划）
- 计划审批流程
- 计划执行进度跟踪
- 计划对比分析图表

**关键组件：**
```vue
<template>
  <div class="production-plan">
    <!-- 计划类型切换 -->
    <el-tabs v-model="activeTab" @tab-click="handleTabClick">
      <el-tab-pane label="年度计划" name="yearly" />
      <el-tab-pane label="月度计划" name="monthly" />
      <el-tab-pane label="日计划" name="daily" />
    </el-tabs>
    
    <!-- 搜索条件 -->
    <el-form :model="queryParams" inline>
      <el-form-item label="计划年度">
        <el-date-picker v-model="queryParams.planYear" type="year" />
      </el-form-item>
      <el-form-item label="审批状态">
        <el-select v-model="queryParams.planStatus">
          <el-option label="待审批" value="1" />
          <el-option label="已审批" value="2" />
        </el-select>
      </el-form-item>
    </el-form>
    
    <!-- 计划列表 -->
    <el-table :data="planList" v-loading="loading">
      <el-table-column prop="planCode" label="计划编号" />
      <el-table-column prop="planYear" label="计划年度" />
      <el-table-column prop="rawCoalPlan" label="计划入洗量(吨)" />
      <el-table-column prop="cleanCoalPlan" label="计划精煤产量(吨)" />
      <el-table-column label="完成率">
        <template #default="{ row }">
          <el-progress :percentage="row.completionRate" />
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button @click="handleEdit(row)">编辑</el-button>
          <el-button @click="handleSplit(row)">拆分</el-button>
          <el-button @click="handleApprove(row)">审批</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

#### 1.2 生产看板页面
**页面路径：** `src/views/coal/production/dashboard/index.vue`

**功能特性：**
- 实时生产数据展示
- 产量完成情况图表
- 设备运行状态监控
- 质量指标趋势图
- 异常报警提醒

### 2. 设备管理前端

#### 2.1 设备档案页面
**页面路径：** `src/views/coal/equipment/archive/index.vue`

**功能特性：**
- 设备树形结构展示
- 设备详细信息查看
- 设备二维码生成
- 设备文档管理
- 设备履历记录

#### 2.2 设备KPI看板
**页面路径：** `src/views/coal/equipment/kpi/index.vue`

**功能特性：**
- KPI指标卡片展示
- 设备完好率趋势图
- 故障率统计图表
- 设备利用率分析
- 对比分析功能

---

## 📱 移动端开发

### 1. 设备巡检APP
**技术栈：** uni-app + Vue 3

**核心功能：**
- 扫码查看设备档案
- 设备巡检记录
- 故障报修提交
- 检修任务接收
- 离线数据同步

### 2. 生产数据录入APP
**核心功能：**
- 产量数据录入
- 煤质检测数据录入
- 能源消耗记录
- 调度记录填写

---

## 🔄 系统集成方案

### 1. PLC数据采集
**技术方案：** OPC UA + MQTT

**采集内容：**
- 设备运行状态
- 生产过程数据
- 报警信息
- 能源消耗数据

### 2. 第三方系统集成
- **ERP系统**：生产计划、物料管理
- **化验系统**：煤质检测数据
- **视频监控**：安全监控集成
- **门禁系统**：人员进出记录

---

## 📊 报表系统设计

### 1. 生产报表
- 日产量报表
- 月度生产总结
- 产品平衡表
- 产率分析报表

### 2. 设备报表
- 设备运行报表
- 故障统计报表
- 维修记录报表
- KPI分析报表

### 3. 质量报表
- 煤质检测报表
- 质量趋势分析
- 合格率统计
- 质量异常报告

---

## 🚀 开发计划

### 第一阶段（1-2个月）
1. 基础框架搭建
2. 数据库设计实现
3. 用户权限管理
4. 生产计划管理模块

### 第二阶段（2-3个月）
1. 产量统计模块
2. 设备档案管理
3. 基础报表功能
4. 移动端框架

### 第三阶段（3-4个月）
1. 煤质管理模块
2. 安全管理模块
3. 能源管理模块
4. 高级报表和分析

### 第四阶段（4-5个月）
1. PLC数据集成
2. 移动端完善
3. 系统优化
4. 部署上线

---

## 📋 开发规范

### 1. 代码规范
- 遵循阿里巴巴Java开发手册
- 使用ESLint进行前端代码检查
- 统一的注释规范
- Git提交规范

### 2. 数据库规范
- 统一的命名规范
- 完整的索引设计
- 数据字典维护
- 备份恢复策略

### 3. 接口规范
- RESTful API设计
- 统一的返回格式
- 完整的接口文档
- 版本管理策略

### 4. 安全管理模块数据表

#### 4.1 安全检查表 (coal_safety_inspection)
```sql
CREATE TABLE coal_safety_inspection (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    inspection_code NVARCHAR(50) NOT NULL,        -- 检查编号
    inspection_date DATE NOT NULL,                -- 检查日期
    inspection_type TINYINT NOT NULL,             -- 检查类型：1日检 2周检 3月检 4专项检查
    inspector_id BIGINT NOT NULL,                 -- 检查人ID

    -- 检查区域
    area_id BIGINT,                               -- 检查区域ID
    equipment_id BIGINT,                          -- 检查设备ID

    -- 检查内容
    inspection_items NTEXT,                       -- 检查项目(JSON格式)
    risk_level TINYINT,                           -- 风险等级：1低 2中 3高 4极高

    -- 发现问题
    problem_description NTEXT,                    -- 问题描述
    problem_photos NTEXT,                         -- 问题照片(JSON数组)
    problem_videos NTEXT,                         -- 问题视频(JSON数组)
    voice_record NVARCHAR(500),                   -- 语音记录URL

    -- 整改要求
    rectification_requirement NTEXT,             -- 整改要求
    rectification_deadline DATE,                 -- 整改期限
    rectification_person_id BIGINT,              -- 整改责任人ID

    -- 检查状态
    inspection_status TINYINT DEFAULT 1,          -- 检查状态：1待整改 2整改中 3已整改 4已验收

    -- 整改结果
    rectification_result NTEXT,                  -- 整改结果
    rectification_photos NTEXT,                  -- 整改照片
    rectification_date DATE,                     -- 整改完成日期
    verifier_id BIGINT,                          -- 验收人ID
    verify_date DATE,                            -- 验收日期

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 4.2 安全事故表 (coal_safety_accident)
```sql
CREATE TABLE coal_safety_accident (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    accident_code NVARCHAR(50) NOT NULL,          -- 事故编号
    accident_date DATETIME NOT NULL,              -- 事故发生时间
    accident_type TINYINT NOT NULL,               -- 事故类型：1人身伤害 2设备事故 3火灾 4其他
    accident_level TINYINT NOT NULL,              -- 事故等级：1轻微 2一般 3较大 4重大

    -- 事故地点
    accident_location NVARCHAR(200),              -- 事故地点
    equipment_id BIGINT,                          -- 相关设备ID

    -- 事故描述
    accident_description NTEXT NOT NULL,          -- 事故经过
    accident_cause NTEXT,                         -- 事故原因
    accident_photos NTEXT,                        -- 事故现场照片
    accident_videos NTEXT,                        -- 事故现场视频

    -- 人员伤亡
    injured_count INT DEFAULT 0,                  -- 受伤人数
    death_count INT DEFAULT 0,                    -- 死亡人数
    injured_persons NTEXT,                        -- 受伤人员信息(JSON)

    -- 经济损失
    direct_loss DECIMAL(12,2) DEFAULT 0,          -- 直接经济损失
    indirect_loss DECIMAL(12,2) DEFAULT 0,        -- 间接经济损失

    -- 应急处理
    emergency_measures NTEXT,                     -- 应急处理措施
    rescue_persons NTEXT,                         -- 救援人员

    -- 事故调查
    investigation_team NTEXT,                     -- 调查组成员
    investigation_report NTEXT,                   -- 调查报告
    responsibility_analysis NTEXT,                -- 责任分析

    -- 整改措施
    corrective_measures NTEXT,                    -- 纠正措施
    preventive_measures NTEXT,                    -- 预防措施

    -- 处理状态
    handle_status TINYINT DEFAULT 1,              -- 处理状态：1待处理 2处理中 3已处理 4已结案

    -- 报告人
    reporter_id BIGINT,                           -- 报告人ID
    report_time DATETIME,                         -- 报告时间

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 5. 煤质管理模块数据表

#### 5.1 煤质检测数据表 (coal_quality_test_data)
```sql
CREATE TABLE coal_quality_test_data (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    test_code NVARCHAR(50) NOT NULL,              -- 检测编号
    test_date DATE NOT NULL,                      -- 检测日期
    shift_id BIGINT,                              -- 班次ID
    test_type TINYINT NOT NULL,                   -- 检测类型：1快灰 2快水 3快浮 4班灰 5全分析

    -- 样品信息
    sample_source TINYINT NOT NULL,               -- 样品来源：1原煤 2精煤 3中煤 4煤泥 5矸石
    sample_location NVARCHAR(100),                -- 取样地点
    sample_person_id BIGINT,                      -- 取样人ID
    sample_time DATETIME,                         -- 取样时间

    -- 检测项目
    ash_content DECIMAL(5,2),                     -- 灰分(%)
    moisture_content DECIMAL(5,2),                -- 水分(%)
    volatile_matter DECIMAL(5,2),                 -- 挥发分(%)
    fixed_carbon DECIMAL(5,2),                    -- 固定碳(%)
    sulfur_content DECIMAL(5,2),                  -- 硫分(%)
    calorific_value DECIMAL(8,2),                 -- 发热量(cal/g)

    -- 浮选试验数据
    float_test_density DECIMAL(4,2),              -- 浮选密度
    float_test_yield DECIMAL(5,2),                -- 浮选产率(%)
    float_test_ash DECIMAL(5,2),                  -- 浮选灰分(%)

    -- 检测人员
    tester_id BIGINT,                             -- 检测人员ID
    test_time DATETIME,                           -- 检测时间
    test_equipment NVARCHAR(100),                 -- 检测设备

    -- 检测结果
    test_result TINYINT DEFAULT 1,                -- 检测结果：1合格 2不合格
    result_description NVARCHAR(500),             -- 结果说明

    -- 数据来源
    data_source TINYINT DEFAULT 1,                -- 数据来源：1人工录入 2设备采集 3化验室

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 5.2 产品销售质量表 (coal_product_sales_quality)
```sql
CREATE TABLE coal_product_sales_quality (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    sales_date DATE NOT NULL,                     -- 销售日期
    product_type TINYINT NOT NULL,                -- 产品类型：1精煤 2中煤 3煤泥
    customer_id BIGINT,                           -- 客户ID
    transport_type TINYINT,                       -- 运输方式：1汽运 2铁运 3水运

    -- 销售数量
    sales_quantity DECIMAL(10,2),                 -- 销售数量(吨)
    unit_price DECIMAL(8,2),                      -- 单价(元/吨)
    total_amount DECIMAL(12,2),                   -- 总金额

    -- 质量指标
    ash_content DECIMAL(5,2),                     -- 灰分(%)
    moisture_content DECIMAL(5,2),                -- 水分(%)
    sulfur_content DECIMAL(5,2),                  -- 硫分(%)
    calorific_value DECIMAL(8,2),                 -- 发热量(cal/g)

    -- 质量评价
    quality_grade NVARCHAR(20),                   -- 质量等级
    is_qualified BIT DEFAULT 1,                   -- 是否合格
    quality_feedback NTEXT,                       -- 客户质量反馈

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 6. 系统基础数据表

#### 6.1 生产系统表 (coal_production_system)
```sql
CREATE TABLE coal_production_system (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    system_name NVARCHAR(100) NOT NULL,           -- 系统名称
    system_code NVARCHAR(50) NOT NULL,            -- 系统编码
    system_type TINYINT NOT NULL,                 -- 系统类型：1主洗系统 2浮选系统 3压滤系统
    design_capacity DECIMAL(10,2),                -- 设计处理能力(t/h)

    -- 工艺参数
    process_flow NTEXT,                           -- 工艺流程描述
    key_equipment NTEXT,                          -- 关键设备列表(JSON)

    -- 系统状态
    system_status TINYINT DEFAULT 1,              -- 系统状态：1正常 2故障 3检修 4停用

    -- 负责人
    manager_id BIGINT,                            -- 系统负责人ID
    operator_ids NTEXT,                           -- 操作人员ID列表(JSON)

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 6.2 车间部门表 (coal_workshop)
```sql
CREATE TABLE coal_workshop (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    workshop_name NVARCHAR(100) NOT NULL,         -- 车间名称
    workshop_code NVARCHAR(50) NOT NULL,          -- 车间编码
    workshop_type TINYINT NOT NULL,               -- 车间类型：1生产车间 2辅助车间 3管理部门
    parent_id BIGINT DEFAULT 0,                   -- 父级部门ID

    -- 车间信息
    description NVARCHAR(500),                    -- 车间描述
    location NVARCHAR(200),                       -- 车间位置
    area_size DECIMAL(10,2),                      -- 车间面积(m²)

    -- 负责人
    manager_id BIGINT,                            -- 车间主任ID
    deputy_manager_id BIGINT,                     -- 副主任ID

    -- 联系方式
    phone NVARCHAR(20),                           -- 联系电话
    email NVARCHAR(100),                          -- 邮箱

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

---

## 🔧 后端开发功能详解（续）

### 4. 安全管理模块 (yudao-module-coal-safety)

#### 4.1 安全检查管理
**Controller 接口：**
- `POST /coal/safety/inspection/create` - 创建安全检查记录
- `PUT /coal/safety/inspection/update` - 更新检查记录
- `GET /coal/safety/inspection/page` - 分页查询检查记录
- `POST /coal/safety/inspection/upload-media` - 上传检查照片/视频
- `POST /coal/safety/inspection/rectify` - 提交整改结果
- `POST /coal/safety/inspection/verify` - 验收整改结果

**Service 业务逻辑：**
```java
@Service
public class SafetyInspectionServiceImpl extends ServiceExceptionUtil implements SafetyInspectionService {

    /**
     * 创建安全检查记录
     */
    @Override
    @Transactional
    public Long createInspection(SafetyInspectionCreateReqVO reqVO) {
        // 1. 生成检查编号
        String inspectionCode = generateInspectionCode();

        // 2. 创建检查记录
        SafetyInspectionDO inspection = BeanUtils.toBean(reqVO, SafetyInspectionDO.class);
        inspection.setInspectionCode(inspectionCode);
        inspection.setInspectionStatus(InspectionStatusEnum.PENDING_RECTIFICATION.getStatus());

        safetyInspectionMapper.insert(inspection);

        // 3. 如果有问题，推送整改通知
        if (CollUtil.isNotEmpty(reqVO.getProblems())) {
            pushRectificationNotice(inspection);
        }

        return inspection.getId();
    }

    /**
     * 推送整改通知
     */
    private void pushRectificationNotice(SafetyInspectionDO inspection) {
        // 构建通知内容
        NotificationReqVO notification = new NotificationReqVO();
        notification.setTitle("安全检查整改通知");
        notification.setContent(String.format("检查编号：%s，请及时整改", inspection.getInspectionCode()));
        notification.setRecipientId(inspection.getRectificationPersonId());
        notification.setType(NotificationTypeEnum.SAFETY_RECTIFICATION.getType());

        // 发送通知
        notificationService.sendNotification(notification);
    }
}
```

#### 4.2 事故管理
**Service 业务逻辑：**
```java
@Service
public class SafetyAccidentServiceImpl extends ServiceExceptionUtil implements SafetyAccidentService {

    /**
     * 创建事故记录
     */
    @Override
    @Transactional
    public Long createAccident(SafetyAccidentCreateReqVO reqVO) {
        // 1. 生成事故编号
        String accidentCode = generateAccidentCode(reqVO.getAccidentLevel());

        // 2. 创建事故记录
        SafetyAccidentDO accident = BeanUtils.toBean(reqVO, SafetyAccidentDO.class);
        accident.setAccidentCode(accidentCode);
        accident.setHandleStatus(AccidentHandleStatusEnum.PENDING.getStatus());

        safetyAccidentMapper.insert(accident);

        // 3. 根据事故等级推送紧急通知
        pushEmergencyNotification(accident);

        // 4. 自动启动应急预案
        if (accident.getAccidentLevel() >= AccidentLevelEnum.MAJOR.getLevel()) {
            emergencyPlanService.activateEmergencyPlan(accident.getId());
        }

        return accident.getId();
    }

    /**
     * 事故统计分析
     */
    @Override
    public AccidentStatisticsVO getAccidentStatistics(AccidentStatisticsReqVO reqVO) {
        AccidentStatisticsVO statistics = new AccidentStatisticsVO();

        // 1. 按事故类型统计
        List<AccidentTypeStatisticsVO> typeStats = safetyAccidentMapper.statisticsByType(reqVO);
        statistics.setTypeStatistics(typeStats);

        // 2. 按事故等级统计
        List<AccidentLevelStatisticsVO> levelStats = safetyAccidentMapper.statisticsByLevel(reqVO);
        statistics.setLevelStatistics(levelStats);

        // 3. 事故趋势分析
        List<AccidentTrendVO> trendData = safetyAccidentMapper.getAccidentTrend(reqVO);
        statistics.setTrendData(trendData);

        // 4. 计算事故率
        BigDecimal accidentRate = calculateAccidentRate(reqVO);
        statistics.setAccidentRate(accidentRate);

        return statistics;
    }
}
```

### 5. 煤质管理模块 (yudao-module-coal-quality)

#### 5.1 煤质检测数据管理
**Controller 接口：**
- `POST /coal/quality/test-data/create` - 录入检测数据
- `PUT /coal/quality/test-data/update` - 更新检测数据
- `GET /coal/quality/test-data/page` - 分页查询检测数据
- `GET /coal/quality/test-data/realtime` - 获取实时检测数据
- `POST /coal/quality/test-data/batch-import` - 批量导入检测数据
- `GET /coal/quality/test-data/export` - 导出检测数据

**Service 业务逻辑：**
```java
@Service
public class QualityTestDataServiceImpl extends ServiceExceptionUtil implements QualityTestDataService {

    /**
     * 录入检测数据
     */
    @Override
    @Transactional
    public Long createTestData(QualityTestDataCreateReqVO reqVO) {
        // 1. 生成检测编号
        String testCode = generateTestCode(reqVO.getTestType());

        // 2. 数据校验
        validateTestData(reqVO);

        // 3. 创建检测记录
        QualityTestDataDO testData = BeanUtils.toBean(reqVO, QualityTestDataDO.class);
        testData.setTestCode(testCode);

        // 4. 自动判断检测结果
        determineTestResult(testData);

        qualityTestDataMapper.insert(testData);

        // 5. 如果检测不合格，发送预警
        if (testData.getTestResult().equals(TestResultEnum.UNQUALIFIED.getResult())) {
            sendQualityAlert(testData);
        }

        return testData.getId();
    }

    /**
     * 质量统计分析
     */
    @Override
    public QualityStatisticsVO getQualityStatistics(QualityStatisticsReqVO reqVO) {
        QualityStatisticsVO statistics = new QualityStatisticsVO();

        // 1. 灰分统计
        QualityTrendVO ashTrend = getQualityTrend(reqVO, "ash_content");
        statistics.setAshTrend(ashTrend);

        // 2. 水分统计
        QualityTrendVO moistureTrend = getQualityTrend(reqVO, "moisture_content");
        statistics.setMoistureTrend(moistureTrend);

        // 3. 合格率统计
        BigDecimal qualificationRate = calculateQualificationRate(reqVO);
        statistics.setQualificationRate(qualificationRate);

        // 4. 稳定性分析
        QualityStabilityVO stability = analyzeQualityStability(reqVO);
        statistics.setStability(stability);

        return statistics;
    }

    /**
     * 自动判断检测结果
     */
    private void determineTestResult(QualityTestDataDO testData) {
        // 根据产品标准判断是否合格
        ProductStandardDO standard = productStandardMapper.selectByProductType(testData.getSampleSource());

        boolean isQualified = true;

        // 检查灰分
        if (testData.getAshContent() != null && standard.getMaxAshContent() != null) {
            if (testData.getAshContent().compareTo(standard.getMaxAshContent()) > 0) {
                isQualified = false;
            }
        }

        // 检查水分
        if (testData.getMoistureContent() != null && standard.getMaxMoistureContent() != null) {
            if (testData.getMoistureContent().compareTo(standard.getMaxMoistureContent()) > 0) {
                isQualified = false;
            }
        }

        // 检查硫分
        if (testData.getSulfurContent() != null && standard.getMaxSulfurContent() != null) {
            if (testData.getSulfurContent().compareTo(standard.getMaxSulfurContent()) > 0) {
                isQualified = false;
            }
        }

        testData.setTestResult(isQualified ? TestResultEnum.QUALIFIED.getResult() : TestResultEnum.UNQUALIFIED.getResult());
    }
}
```

---

## 🎨 前端开发功能详解（续）

### 3. 安全管理前端

#### 3.1 安全检查页面
**页面路径：** `src/views/coal/safety/inspection/index.vue`

**功能特性：**
- 检查记录列表展示
- 检查表单录入（支持拍照、录音、录像）
- 整改任务分配
- 整改进度跟踪
- 验收结果确认

**关键组件：**
```vue
<template>
  <div class="safety-inspection">
    <!-- 检查记录表单 -->
    <el-form :model="inspectionForm" :rules="inspectionRules">
      <el-form-item label="检查类型" prop="inspectionType">
        <el-select v-model="inspectionForm.inspectionType">
          <el-option label="日常检查" :value="1" />
          <el-option label="专项检查" :value="2" />
          <el-option label="隐患排查" :value="3" />
        </el-select>
      </el-form-item>

      <el-form-item label="检查区域" prop="areaId">
        <el-cascader
          v-model="inspectionForm.areaId"
          :options="areaOptions"
          :props="{ checkStrictly: true }"
        />
      </el-form-item>

      <el-form-item label="问题描述" prop="problemDescription">
        <el-input
          v-model="inspectionForm.problemDescription"
          type="textarea"
          :rows="4"
        />
      </el-form-item>

      <!-- 多媒体上传 -->
      <el-form-item label="问题照片">
        <el-upload
          :action="uploadUrl"
          list-type="picture-card"
          :on-success="handlePhotoSuccess"
          :before-upload="beforePhotoUpload"
        >
          <el-icon><Plus /></el-icon>
        </el-upload>
      </el-form-item>

      <el-form-item label="语音记录">
        <voice-recorder @on-record="handleVoiceRecord" />
      </el-form-item>

      <el-form-item label="整改要求" prop="rectificationRequirement">
        <el-input
          v-model="inspectionForm.rectificationRequirement"
          type="textarea"
          :rows="3"
        />
      </el-form-item>

      <el-form-item label="整改期限" prop="rectificationDeadline">
        <el-date-picker
          v-model="inspectionForm.rectificationDeadline"
          type="date"
        />
      </el-form-item>

      <el-form-item label="整改责任人" prop="rectificationPersonId">
        <user-selector v-model="inspectionForm.rectificationPersonId" />
      </el-form-item>
    </el-form>

    <!-- 检查记录列表 -->
    <el-table :data="inspectionList" v-loading="loading">
      <el-table-column prop="inspectionCode" label="检查编号" />
      <el-table-column prop="inspectionDate" label="检查日期" />
      <el-table-column prop="inspectionTypeName" label="检查类型" />
      <el-table-column prop="riskLevelName" label="风险等级">
        <template #default="{ row }">
          <el-tag :type="getRiskLevelType(row.riskLevel)">
            {{ row.riskLevelName }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="inspectionStatusName" label="状态" />
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button @click="handleView(row)">查看</el-button>
          <el-button
            v-if="row.inspectionStatus === 1"
            @click="handleRectify(row)"
          >
            整改
          </el-button>
          <el-button
            v-if="row.inspectionStatus === 3"
            @click="handleVerify(row)"
          >
            验收
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script lang="ts" setup>
import { ref, reactive, onMounted } from 'vue'
import * as SafetyApi from '@/api/coal/safety'
import VoiceRecorder from '@/components/VoiceRecorder/index.vue'
import UserSelector from '@/components/UserSelector/index.vue'

// 响应式数据
const loading = ref(false)
const inspectionList = ref([])
const inspectionForm = reactive({
  inspectionType: null,
  areaId: null,
  problemDescription: '',
  rectificationRequirement: '',
  rectificationDeadline: null,
  rectificationPersonId: null
})

// 表单校验规则
const inspectionRules = {
  inspectionType: [{ required: true, message: '请选择检查类型', trigger: 'change' }],
  areaId: [{ required: true, message: '请选择检查区域', trigger: 'change' }],
  problemDescription: [{ required: true, message: '请输入问题描述', trigger: 'blur' }]
}

// 获取检查记录列表
const getInspectionList = async () => {
  loading.value = true
  try {
    const data = await SafetyApi.getInspectionPage(queryParams)
    inspectionList.value = data.list
  } finally {
    loading.value = false
  }
}

// 处理语音记录
const handleVoiceRecord = (voiceUrl: string) => {
  inspectionForm.voiceRecord = voiceUrl
}

// 风险等级样式
const getRiskLevelType = (level: number) => {
  const types = { 1: 'info', 2: 'warning', 3: 'danger', 4: 'danger' }
  return types[level] || 'info'
}

onMounted(() => {
  getInspectionList()
})
</script>
```

#### 3.2 安全看板页面
**页面路径：** `src/views/coal/safety/dashboard/index.vue`

**功能特性：**
- 安全指标卡片展示
- 事故统计图表
- 隐患整改进度
- 安全检查完成率
- 实时安全状态监控

### 4. 煤质管理前端

#### 4.1 煤质检测数据录入页面
**页面路径：** `src/views/coal/quality/test-data/index.vue`

**功能特性：**
- 检测数据录入表单
- 检测结果自动判断
- 历史检测数据查询
- 质量趋势图表展示
- 不合格数据预警

#### 4.2 质量统计分析页面
**页面路径：** `src/views/coal/quality/statistics/index.vue`

**功能特性：**
- 质量指标趋势图
- 合格率统计图表
- 质量稳定性分析
- 产品质量对比
- 质量异常预警

---

## 📱 移动端开发详解

### 1. 技术架构
**框架选择：** uni-app + Vue 3 + TypeScript
**UI组件：** uni-ui + 自定义组件
**状态管理：** Pinia
**网络请求：** uni.request 封装

### 2. 核心功能模块

#### 2.1 设备巡检模块
```vue
<!-- pages/equipment/inspection/index.vue -->
<template>
  <view class="inspection-page">
    <!-- 扫码入口 -->
    <view class="scan-section">
      <button @click="scanQRCode" class="scan-btn">
        <uni-icons type="scan" size="30"></uni-icons>
        <text>扫码巡检</text>
      </button>
    </view>

    <!-- 巡检表单 -->
    <uni-forms :model="inspectionForm" :rules="rules" ref="form">
      <uni-forms-item label="设备名称" name="equipmentName">
        <uni-easyinput v-model="inspectionForm.equipmentName" disabled />
      </uni-forms-item>

      <uni-forms-item label="巡检项目" name="inspectionItems">
        <view class="inspection-items">
          <view
            v-for="item in inspectionItems"
            :key="item.id"
            class="inspection-item"
          >
            <text>{{ item.name }}</text>
            <uni-data-checkbox
              v-model="item.result"
              :localdata="[{value: 1, text: '正常'}, {value: 0, text: '异常'}]"
            />
          </view>
        </view>
      </uni-forms-item>

      <uni-forms-item label="异常描述" name="abnormalDescription">
        <uni-easyinput
          v-model="inspectionForm.abnormalDescription"
          type="textarea"
          placeholder="请描述发现的异常情况"
        />
      </uni-forms-item>

      <uni-forms-item label="现场照片">
        <view class="photo-upload">
          <view
            v-for="(photo, index) in photos"
            :key="index"
            class="photo-item"
          >
            <image :src="photo" mode="aspectFill" />
            <view class="photo-delete" @click="deletePhoto(index)">
              <uni-icons type="clear" size="16" color="#fff" />
            </view>
          </view>
          <view class="photo-add" @click="chooseImage">
            <uni-icons type="camera" size="30" />
            <text>添加照片</text>
          </view>
        </view>
      </uni-forms-item>
    </uni-forms>

    <view class="submit-section">
      <button @click="submitInspection" class="submit-btn">提交巡检</button>
    </view>
  </view>
</template>

<script lang="ts" setup>
import { ref, reactive } from 'vue'
import * as EquipmentApi from '@/api/equipment'

// 响应式数据
const inspectionForm = reactive({
  equipmentId: '',
  equipmentName: '',
  abnormalDescription: ''
})

const inspectionItems = ref([])
const photos = ref([])

// 扫码功能
const scanQRCode = () => {
  uni.scanCode({
    success: async (res) => {
      try {
        // 解析二维码获取设备信息
        const equipmentInfo = await EquipmentApi.getEquipmentByQRCode(res.result)
        inspectionForm.equipmentId = equipmentInfo.id
        inspectionForm.equipmentName = equipmentInfo.name

        // 获取巡检项目
        const items = await EquipmentApi.getInspectionItems(equipmentInfo.id)
        inspectionItems.value = items
      } catch (error) {
        uni.showToast({
          title: '设备信息获取失败',
          icon: 'error'
        })
      }
    }
  })
}

// 选择图片
const chooseImage = () => {
  uni.chooseImage({
    count: 9 - photos.value.length,
    success: (res) => {
      photos.value.push(...res.tempFilePaths)
    }
  })
}

// 提交巡检
const submitInspection = async () => {
  try {
    // 上传照片
    const photoUrls = await uploadPhotos()

    // 提交巡检数据
    const inspectionData = {
      ...inspectionForm,
      inspectionItems: inspectionItems.value,
      photos: photoUrls
    }

    await EquipmentApi.submitInspection(inspectionData)

    uni.showToast({
      title: '提交成功',
      icon: 'success'
    })

    // 返回上一页
    uni.navigateBack()
  } catch (error) {
    uni.showToast({
      title: '提交失败',
      icon: 'error'
    })
  }
}
</script>
```

#### 2.2 故障报修模块
```vue
<!-- pages/equipment/repair/index.vue -->
<template>
  <view class="repair-page">
    <uni-forms :model="repairForm" :rules="rules" ref="form">
      <uni-forms-item label="故障设备" name="equipmentId">
        <uni-data-select
          v-model="repairForm.equipmentId"
          :localdata="equipmentOptions"
          placeholder="请选择故障设备"
        />
      </uni-forms-item>

      <uni-forms-item label="故障类型" name="faultType">
        <uni-data-checkbox
          v-model="repairForm.faultType"
          :localdata="faultTypeOptions"
        />
      </uni-forms-item>

      <uni-forms-item label="故障描述" name="faultDescription">
        <uni-easyinput
          v-model="repairForm.faultDescription"
          type="textarea"
          placeholder="请详细描述故障现象"
        />
      </uni-forms-item>

      <uni-forms-item label="紧急程度" name="urgencyLevel">
        <uni-data-checkbox
          v-model="repairForm.urgencyLevel"
          :localdata="urgencyOptions"
        />
      </uni-forms-item>

      <uni-forms-item label="现场照片">
        <view class="media-upload">
          <view class="photo-section">
            <view
              v-for="(photo, index) in photos"
              :key="index"
              class="media-item"
            >
              <image :src="photo" mode="aspectFill" />
              <view class="media-delete" @click="deletePhoto(index)">×</view>
            </view>
            <view class="media-add" @click="chooseImage">
              <uni-icons type="camera" size="30" />
              <text>拍照</text>
            </view>
          </view>
        </view>
      </uni-forms-item>

      <uni-forms-item label="现场录音">
        <view class="voice-section">
          <button
            @click="startRecord"
            :disabled="isRecording"
            class="record-btn"
          >
            {{ isRecording ? '录音中...' : '开始录音' }}
          </button>
          <button
            @click="stopRecord"
            :disabled="!isRecording"
            class="stop-btn"
          >
            停止录音
          </button>
          <view v-if="voiceUrl" class="voice-player">
            <button @click="playVoice">播放录音</button>
          </view>
        </view>
      </uni-forms-item>
    </uni-forms>

    <view class="submit-section">
      <button @click="submitRepair" class="submit-btn">提交报修</button>
    </view>
  </view>
</template>

<script lang="ts" setup>
import { ref, reactive, onMounted } from 'vue'
import * as RepairApi from '@/api/repair'

// 响应式数据
const repairForm = reactive({
  equipmentId: '',
  faultType: '',
  faultDescription: '',
  urgencyLevel: 1
})

const photos = ref([])
const voiceUrl = ref('')
const isRecording = ref(false)
const recorderManager = uni.getRecorderManager()

// 开始录音
const startRecord = () => {
  isRecording.value = true
  recorderManager.start({
    duration: 60000, // 最长60秒
    sampleRate: 16000,
    numberOfChannels: 1,
    encodeBitRate: 96000,
    format: 'mp3'
  })
}

// 停止录音
const stopRecord = () => {
  isRecording.value = false
  recorderManager.stop()
}

// 录音事件监听
recorderManager.onStop((res) => {
  voiceUrl.value = res.tempFilePath
})

// 提交报修
const submitRepair = async () => {
  try {
    // 上传照片和录音
    const photoUrls = await uploadPhotos()
    const voiceFileUrl = voiceUrl.value ? await uploadVoice() : ''

    // 提交报修数据
    const repairData = {
      ...repairForm,
      photos: photoUrls,
      voiceUrl: voiceFileUrl
    }

    await RepairApi.submitRepair(repairData)

    uni.showToast({
      title: '报修成功',
      icon: 'success'
    })

    uni.navigateBack()
  } catch (error) {
    uni.showToast({
      title: '报修失败',
      icon: 'error'
    })
  }
}
</script>
```

这个大纲涵盖了选煤厂生产管理系统的完整开发方案，包括详细的数据库设计、后端功能开发、前端页面实现和移动端开发。我们可以按照这个大纲逐步实施开发。
