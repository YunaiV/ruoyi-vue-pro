# 选煤厂生产管理系统开发大纲

## 🎯 项目概述

基于芋道开源框架开发的选煤厂智能生产管控系统，实现生产调度、设备管理、煤质管理、安全管理等全流程数字化管理。系统采用标准数据库设计，数据标准指导后续各种选煤智能化新技术开发，确保选煤信息"一次输入，全局共享"，提高数据的真实性和唯一性。

### 技术架构
- **后端**：Spring Boot + MyBatis-Plus + SQL Server
- **前端**：Vue 3 + TypeScript + Element Plus
- **框架**：芋道开源框架 (ruoyi-vue-pro)
- **数据库**：MySQL 8.0+（支持JSON数据类型，存储半结构化数据）
- **部署**：Docker + Nginx
- **集成**：PLC数据采集、OPC UA、MQTT协议支持

---

## 📊 系统架构设计

### 模块划分

```
yudao-module-coal/                    # 选煤厂核心模块
├── production/                       # 生产调度管理
├── equipment/                        # 设备档案管理  
├── quality/                          # 煤质管理
├── safety/                          # 安全管理
├── energy/                          # 能源管理
├── report/                          # 报表统计
└── common/                          # 公共组件
```

### 数据库设计原则
- 采用 MySQL 8.0+ 数据库，支持JSON数据类型存储半结构化数据
- 遵循第三范式设计，确保数据标准化
- 支持多租户架构，数据隔离安全
- 预留扩展字段，支持后续功能扩展
- 建立完整的索引体系，优化查询性能
- 数据标准统一，支持"一次输入，全局共享"

---

## 🗄️ 数据库设计详解

### 1. 生产调度管理模块

#### 1.1 生产计划表 (coal_production_plan) - 树表结构
```sql
DROP TABLE IF EXISTS `coal_production_plan`;
CREATE TABLE `coal_production_plan` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '计划ID',
    `name` VARCHAR(100) NOT NULL COMMENT '计划名称',
    `parent_id` BIGINT NOT NULL DEFAULT 0 COMMENT '父计划ID',
    `sort` INT NOT NULL DEFAULT 0 COMMENT '显示顺序',
    `plan_code` VARCHAR(50) NOT NULL DEFAULT '' COMMENT '计划编号',
    `plan_type` TINYINT NOT NULL COMMENT '计划类型：1年度 2月度 3日计划 4班计划',
    `plan_year` INT NULL COMMENT '计划年度',
    `plan_month` TINYINT NULL COMMENT '计划月份',
    `plan_date` DATE NULL COMMENT '计划日期',
    `shift_id` BIGINT NULL COMMENT '班次ID',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '计划状态：0停用 1正常',
    plan_path VARCHAR(500) COMMENT '计划层级路径（如：1/2/3表示年/月/日）',

    -- 计划产量数据（基础）
    `raw_coal_plan` DECIMAL(10,2) NULL COMMENT '计划入洗原煤量(吨)',

    -- 精煤产量计划（按粒度分类）
    `fine_coal_plan` DECIMAL(10,2) NULL COMMENT '计划末煤产量(吨)',
    `granular_coal_plan` DECIMAL(10,2) NULL COMMENT '计划粒煤产量(吨)',
    `large_block_coal_plan` DECIMAL(10,2) NULL COMMENT '计划大块煤产量(吨)',
    `medium_block_coal_plan` DECIMAL(10,2) NULL COMMENT '计划中块煤产量(吨)',
    `small_block_coal_plan` DECIMAL(10,2) NULL COMMENT '计划小块煤产量(吨)',

    -- 其他产品计划产量
    `middling_coal_plan` DECIMAL(10,2) NULL COMMENT '计划中煤产量(吨)',
    `slime_plan` DECIMAL(10,2) NULL COMMENT '计划煤泥产量(吨)',
    `gangue_plan` DECIMAL(10,2) NULL COMMENT '计划矸石产量(吨)',

    -- 预留计划产量字段
    `reserved_product_plan1` DECIMAL(10,2) NULL COMMENT '预留计划产量字段1(吨)',
    `reserved_product_plan2` DECIMAL(10,2) NULL COMMENT '预留计划产量字段2(吨)',

    -- 质量指标
    `fine_coal_ash` DECIMAL(5,2) NULL COMMENT '末煤灰分(%)',
    `granular_coal_ash` DECIMAL(5,2) NULL COMMENT '粒煤灰分(%)',
    `large_block_coal_ash` DECIMAL(5,2) NULL COMMENT '大块煤灰分(%)',
    `medium_block_coal_ash` DECIMAL(5,2) NULL COMMENT '中块煤灰分(%)',
    `small_block_coal_ash` DECIMAL(5,2) NULL COMMENT '小块煤灰分(%)',
    `middling_coal_ash` DECIMAL(5,2) NULL COMMENT '中煤灰分(%)',

    -- 审批信息
    `creator_id` BIGINT NULL COMMENT '制定人ID',
    `approver_id` BIGINT NULL COMMENT '审批人ID',
    `approve_time` DATETIME NULL COMMENT '审批时间',

    -- 基础字段（芋道框架标准）
    `creator` VARCHAR(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT '' COMMENT '创建者',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` VARCHAR(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT '' COMMENT '更新者',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` BIT(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    `tenant_id` BIGINT NOT NULL DEFAULT 0 COMMENT '租户编号',
    PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '生产计划表（树表结构）';
```



其中用到的字典：计划层级和计划状态。

![image-20250820160535987](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250820160535987.png)

![](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250820160550262.png)

```sql

INSERT INTO `ruoyi-vue-pro`.system_dict_type
(id, name, `type`, status, remark, creator, create_time, updater, update_time, deleted, deleted_time)
VALUES(2000, '计划层级', 'plan_level', 0, '生产计划层级', '1', '2025-08-20 16:01:18', '1', '2025-08-20 16:01:18', 0, '1970-01-01 00:00:00');
INSERT INTO `ruoyi-vue-pro`.system_dict_type
(id, name, `type`, status, remark, creator, create_time, updater, update_time, deleted, deleted_time)
VALUES(2001, '计划状态', 'plan_status', 0, '', '1', '2025-08-20 16:04:06', '1', '2025-08-20 16:04:06', 0, '1970-01-01 00:00:00');



INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3003, 0, '年度', '1', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:01:49', '1', '2025-08-20 16:01:49', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3004, 2, '月度', '2', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:03', '1', '2025-08-20 16:02:03', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3005, 3, '日计划', '3', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:18', '1', '2025-08-20 16:02:18', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3006, 4, '班计划', '4', 'plan_level', 0, '', '', '', '1', '2025-08-20 16:02:26', '1', '2025-08-20 16:06:31', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3007, 1, '待完成', '1', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:28', '1', '2025-08-20 16:04:28', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3008, 2, '执行中', '2', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:39', '1', '2025-08-20 16:04:39', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3009, 3, '已完成', '3', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:47', '1', '2025-08-20 16:04:47', 0);
INSERT INTO `ruoyi-vue-pro`.system_dict_data
(id, sort, label, value, dict_type, status, color_type, css_class, remark, creator, create_time, updater, update_time, deleted)
VALUES(3010, 4, '已取消', '4', 'plan_status', 0, '', '', '', '1', '2025-08-20 16:04:53', '1', '2025-08-20 16:04:53', 0);
```

##### 新增一键生成年度计划表和删除年度表

###### controller

```java
    @PostMapping("/generate-yearly-plan")
    @Operation(summary = "一键生成年度计划")
    @PreAuthorize("@ss.hasPermission('coal:production-plan:create')")
    public CommonResult<Boolean> generateYearlyPlan(@Valid @RequestBody ProductionPlanSaveReqVO createReqVO) {
        productionPlanService.generateYearlyPlan(createReqVO);
        return success(true);
    }

    @DeleteMapping("/delete-by-year")
    @Operation(summary = "一键删除年度计划")
    @Parameter(name = "year", description = "年份", required = true, example = "2025")
    @PreAuthorize("@ss.hasPermission('coal:production-plan:delete')")
    public CommonResult<Boolean> deleteProductionPlanByYear(@RequestParam("year") Integer year) {
        productionPlanService.deleteProductionPlanByYear(year);
        return success(true);
    }
    @DeleteMapping("/physical-delete-by-year")
        @Operation(summary = "物理删除年度计划（调试用）")
        @Parameter(name = "year", description = "年份", required = true, example = "2025")
        @PreAuthorize("@ss.hasPermission('coal:production-plan:delete')") // 注意：权限保持一致
        public CommonResult<Boolean> physicalDeleteProductionPlanByYear(@RequestParam("year") Integer year) {
            productionPlanService.physicalDeleteProductionPlanByYear(year);
            return success(true);
        }
```





###### mapper

```java
    default void deleteByYear(Integer year) {
            delete(new LambdaQueryWrapperX<ProductionPlanDO>()
                    .eq(ProductionPlanDO::getPlanYear, year));
        }

    @Delete("DELETE FROM coal_production_plan WHERE plan_year = #{year}")
    void physicalDeleteByYear(@Param("year") Integer year);
```





###### service

```java
	 /**
     * 一键生成年度计划
     *
     * @param createReqVO 年度计划信息
     */
    void generateYearlyPlan(@Valid ProductionPlanSaveReqVO createReqVO);

    /**
     * 根据年份删除生产计划
     *
     * @param year 年份
     */
    void deleteProductionPlanByYear(Integer year);

    /**
     * 根据年份物理删除生产计划（调试用）
     *
     * @param year 年份
     */
    void physicalDeleteProductionPlanByYear(Integer year);
```







###### serviceImp

```java
@Override
    @Transactional
    public void generateYearlyPlan(ProductionPlanSaveReqVO createReqVO) {
        // 1. 插入年度计划
        ProductionPlanDO yearPlan = BeanUtils.toBean(createReqVO, ProductionPlanDO.class);
        yearPlan.setPlanYear(createReqVO.getPlanYear()); // 显式设置年份，确保保存
        productionPlanMapper.insert(yearPlan); // 插入数据库，为了获得 id

        // 2. 批量插入后续计划
        List<ProductionPlanDO> batchList = new ArrayList<>();

        // 2.1 生成月度计划
        for (int i = 1; i <= 12; i++) {
            ProductionPlanDO monthPlan = generateSubPlan(yearPlan, yearPlan.getId(), i + "月", 12, 2); // planType = 2
            monthPlan.setPlanMonth(i);
            productionPlanMapper.insert(monthPlan); // 插入数据库，为了获得 id

            // 2.2 生成日计划
            int daysInMonth = java.time.YearMonth.of(yearPlan.getPlanYear(), i).lengthOfMonth();
            for (int j = 1; j <= daysInMonth; j++) {
                // 注意：除数使用该月的实际天数，保证日计划合计约等于月计划
                ProductionPlanDO dayPlan = generateSubPlan(monthPlan, monthPlan.getId(), j + "日", daysInMonth, 3); // planType = 3
                dayPlan.setPlanDate(LocalDate.of(yearPlan.getPlanYear(), monthPlan.getPlanMonth(), j));
                productionPlanMapper.insert(dayPlan); // 插入数据库，为了获得 id

                // 2.3 生成班次计划
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "早班", 3, 4)); // planType = 4
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "中班", 3, 4)); // planType = 4
                batchList.add(generateSubPlan(dayPlan, dayPlan.getId(), "晚班", 3, 4)); // planType = 4
            }
        }

        // 批量插入所有班次计划
        for (ProductionPlanDO plan : batchList) {
            productionPlanMapper.insert(plan);
        }
    }
	/**
     * 生成子计划
     *
     * @param parentPlan 父计划
     * @param parentId 父计划编号
     * @param name 计划名称
     * @param subMultiple 子计划的拆分倍数
     * @param planType 计划类型
     * @return 子计划
     */
    private ProductionPlanDO generateSubPlan(ProductionPlanDO parentPlan, Long parentId, String name, int subMultiple, Integer planType) {
        ProductionPlanDO subPlan = new ProductionPlanDO();
        subPlan.setName(parentPlan.getName() + "-" + name);
        subPlan.setParentId(parentId);
        subPlan.setPlanType(planType);
        subPlan.setStatus(parentPlan.getStatus());
        subPlan.setPlanYear(parentPlan.getPlanYear()); // 继承父计划的年份

        // 将“量”相关的字段，进行除法
        subPlan.setRawCoalPlan(parentPlan.getRawCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setFineCoalPlan(parentPlan.getFineCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setGranularCoalPlan(parentPlan.getGranularCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setLargeBlockCoalPlan(parentPlan.getLargeBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setMediumBlockCoalPlan(parentPlan.getMediumBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setSmallBlockCoalPlan(parentPlan.getSmallBlockCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setMiddlingCoalPlan(parentPlan.getMiddlingCoalPlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setSlimePlan(parentPlan.getSlimePlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));
        subPlan.setGanguePlan(parentPlan.getGanguePlan().divide(BigDecimal.valueOf(subMultiple), 2, RoundingMode.HALF_UP));

        // 将“灰分”相关的字段，直接复制
        subPlan.setFineCoalAsh(parentPlan.getFineCoalAsh());
        subPlan.setGranularCoalAsh(parentPlan.getGranularCoalAsh());
        subPlan.setLargeBlockCoalAsh(parentPlan.getLargeBlockCoalAsh());
        subPlan.setMediumBlockCoalAsh(parentPlan.getMediumBlockCoalAsh());
        subPlan.setSmallBlockCoalAsh(parentPlan.getSmallBlockCoalAsh());
        subPlan.setMiddlingCoalAsh(parentPlan.getMiddlingCoalAsh());
        return subPlan;
    }

    @Override
    public void deleteProductionPlanByYear(Integer year) {
        productionPlanMapper.deleteByYear(year);
    }
    @Override
    public void physicalDeleteProductionPlanByYear(Integer year) {
        productionPlanMapper.physicalDeleteByYear(year);
    } 
```







###### 前端

添加提示框

```vue
	<el-alert
      title="搜索提示：对于“一键生成”的计划，建议使用“计划名称”进行精确搜索。搜索格式示例：'2025年-12月-31日-晚班' 或 '2025年-12月-31日'。"
      type="success"
      show-icon
      :closable="true"
      style="margin-bottom: 20px; border:1px green solid;"
    />
```



添加两个按钮

```vue
		<el-button
          type="primary"
          @click="openForm('generate')"
          v-hasPermi="['coal:production-plan:create']"
        >
          <Icon icon="ep:plus" class="mr-5px" /> 一键生成年度计划
        </el-button>
        <el-button
          type="danger"
          plain
          @click="handleDeleteByYear"
          v-hasPermi="['coal:production-plan:delete']"
        >
          <Icon icon="ep:delete" class="mr-5px" /> 按年删除
        </el-button>
```





因为一键生成年度计划里面，需要填写年度计划，所以可以直接引用新增或修改的表格，也就是ProductionPlanForm.vue。所以直接添加一个generate标识为生成的，对应的是这里：

![image-20250825113053844](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825113053844.png)



打开弹窗的ProductionPlanForm.vue后，判断是生成的时候自动填写年度计划和顶级ID

```vue
// 一键生成年度计划时，设置默认值
  if (type === 'generate') {
    formData.value.planType = 1 // 1 代表年度计划
    formData.value.parentId = 0 // 0 代表顶级
  }
```





提交是执行generationYearPlan方法

```ts
if (formType.value === 'generate') {
      await ProductionPlanApi.generateYearlyPlan(data)
      message.success('一键生成年度计划成功')
```





```TS
// TS代码

// 一键生成年度计划
  generateYearlyPlan: async (data: ProductionPlan) => {
    return await request.post({ url: `/coal/production-plan/generate-yearly-plan`, data })
  },

  // 按年份删除生产计划
  deleteProductionPlanByYear: async (year: number) => {
    return await request.delete({ url: `/coal/production-plan/delete-by-year?year=` + year })
  },
```



对于删除逻辑就是传递年份然后执行delete-by-year方法

```ts
/** 按年份删除按钮操作 */
const handleDeleteByYear = async () => {
  try {
    const { value } = await ElMessageBox.prompt('请输入要删除的年份', '提示', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      inputPattern: /^\d{4}$/,
      inputErrorMessage: '请输入有效的四位年份'
    })
    if (value) {
      await message.delConfirm('确认要删除 ' + value + ' 年的所有计划数据吗？')
      await ProductionPlanApi.deleteProductionPlanByYear(Number(value))
      message.success(t('common.delSuccess'))
      await getList()
    }
  } catch {}
}
```





###### 调试

![image-20250825112725106](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825112725106.png)

**生成年度计划：**



![image-20250825143905527](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143905527.png)

![image-20250825143920623](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143920623.png)



![image-20250825143927935](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143927935.png)**删除：**

![image-20250825143414516](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143414516.png)

![image-20250825143420016](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143420016.png)

数据库中不是真的删除，而是逻辑删除。

![image-20250825143450111](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143450111.png)

如果要物理删除，使用http://127.0.0.1:48080/doc.html#/all/%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%20-%20%E7%94%9F%E4%BA%A7%E8%AE%A1%E5%88%92/physicalDeleteProductionPlanByYear

进行物理删除。



![image-20250825143524687](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143524687.png)

![image-20250825143531790](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143531790.png)

![image-20250825143537521](D:\code\ruoyi-vue-pro\learn\选煤厂生产管理系统开发大纲.assets\image-20250825143537521.png)















#### 1.2 现场生产日报表 (coal_production_daily_report)

```sql
CREATE TABLE coal_production_daily_report (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    report_date DATE NOT NULL COMMENT '日期',
    shift_id BIGINT NOT NULL COMMENT '班次ID',

    -- 人员信息
    operator_id BIGINT COMMENT '集控员（操作人）ID',
    shift_leader_id BIGINT COMMENT '带班主任/班长ID',

    -- 时间记录
    start_time TIME COMMENT '启车时间',
    coal_feeding_time INT COMMENT '带煤时间(分钟)',
    stop_time TIME COMMENT '停车时间',
    effective_feeding_time INT COMMENT '有效带煤时间(分钟)',
    fault_impact_time INT COMMENT '故障影响时间(分钟)',

    -- 产量数据
    raw_coal_input DECIMAL(10,2) COMMENT '入洗煤量(吨)',
    hourly_capacity DECIMAL(8,2) COMMENT '小时处理量(吨/小时)',
    block_clean_coal_output DECIMAL(10,2) COMMENT '块精煤产量(吨)',
    fine_clean_coal_output DECIMAL(10,2) COMMENT '末精煤产量(吨)',
    gangue_output DECIMAL(10,2) COMMENT '矸石产量(吨)',
    middling_coal_output DECIMAL(10,2) COMMENT '中煤产量(吨)',

    -- 压滤相关
    filter_press_cycles INT COMMENT '压滤板次',
    filter_press_coal_amount DECIMAL(8,2) COMMENT '压滤煤量(吨)',
    filter_cloth_usage INT COMMENT '滤布使用量(张)',

    -- 放舱记录
    discharge_record VARCHAR(500) COMMENT '放舱记录',

    -- 介质添加
    baffle_medium_addition DECIMAL(8,2) COMMENT '挡板添加介质量(kg)',
    cao_amount DECIMAL(8,2) COMMENT 'CaO量(kg)',
    flocculant_amount DECIMAL(8,2) COMMENT '絮凝剂(kg)',
    density_317 DECIMAL(5,2) COMMENT '317密度(kg/L)',

    -- 第一次灰分检测内容
    first_ash_block_clean DECIMAL(5,2) COMMENT '第一次块精煤灰分(%)',
    first_ash_fine_clean DECIMAL(5,2) COMMENT '第一次末精煤灰分(%)',
    first_ash_middling DECIMAL(5,2) COMMENT '第一次中煤灰分(%)',
    first_ash_slime DECIMAL(5,2) COMMENT '第一次煤泥灰分(%)',
    first_ash_gangue DECIMAL(5,2) COMMENT '第一次矸石灰分(%)',

    -- 第二次灰分检测内容
    second_ash_block_clean DECIMAL(5,2) COMMENT '第二次块精煤灰分(%)',
    second_ash_fine_clean DECIMAL(5,2) COMMENT '第二次末精煤灰分(%)',
    second_ash_middling DECIMAL(5,2) COMMENT '第二次中煤灰分(%)',
    second_ash_slime DECIMAL(5,2) COMMENT '第二次煤泥灰分(%)',
    second_ash_gangue DECIMAL(5,2) COMMENT '第二次矸石灰分(%)',

    -- 影响时间记录
    impact_time_record TEXT COMMENT '影响时间记录详情',

    -- 交办事项
    assigned_tasks TEXT COMMENT '交办事项',

    -- 启车时的仓位和液位
    start_circulating_water_pool DECIMAL(6,2) COMMENT '启车循环水池液位',
    start_clean_water_tank DECIMAL(6,2) COMMENT '启车清水桶液位',
    start_fine_coal_level DECIMAL(6,2) COMMENT '启车末煤仓位',
    start_granular_coal_level DECIMAL(6,2) COMMENT '启车粒煤仓位',
    start_large_block_level DECIMAL(6,2) COMMENT '启车大块仓位',
    start_medium_block_level DECIMAL(6,2) COMMENT '启车中块仓位',
    start_small_block_level DECIMAL(6,2) COMMENT '启车小块仓位',
    start_middling_coal_level DECIMAL(6,2) COMMENT '启车中煤仓位',
    start_gangue_level DECIMAL(6,2) COMMENT '启车矸石仓位',

    -- 停车时的仓位和液位
    stop_circulating_water_pool DECIMAL(6,2) COMMENT '停车循环水池液位',
    stop_clean_water_tank DECIMAL(6,2) COMMENT '停车清水桶液位',
    stop_fine_coal_level DECIMAL(6,2) COMMENT '停车末煤仓位',
    stop_granular_coal_level DECIMAL(6,2) COMMENT '停车粒煤仓位',
    stop_large_block_level DECIMAL(6,2) COMMENT '停车大块仓位',
    stop_medium_block_level DECIMAL(6,2) COMMENT '停车中块仓位',
    stop_small_block_level DECIMAL(6,2) COMMENT '停车小块仓位',
    stop_middling_coal_level DECIMAL(6,2) COMMENT '停车中煤仓位',
    stop_gangue_level DECIMAL(6,2) COMMENT '停车矸石仓位',

    -- 备注
    remarks TEXT COMMENT '备注信息',

    -- 预留字段（用于后续扩展新字段）
    reserved_field1 VARCHAR(200) COMMENT '预留字段1',
    reserved_field2 VARCHAR(200) COMMENT '预留字段2',
    reserved_field3 DECIMAL(10,2) COMMENT '预留字段3',
    reserved_field4 DECIMAL(10,2) COMMENT '预留字段4',
    reserved_field5 TEXT COMMENT '预留字段5',

    -- 基础字段
    creator VARCHAR(64) DEFAULT '' COMMENT '创建者',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) DEFAULT '' COMMENT '更新者',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted TINYINT DEFAULT 0 COMMENT '是否删除',
    tenant_id BIGINT DEFAULT 0 COMMENT '租户ID'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='现场生产日报表';
```

#### 1.3 计划完成率统计表 (coal_plan_completion_statistics)
```sql
CREATE TABLE coal_plan_completion_statistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    plan_id BIGINT NOT NULL COMMENT '计划ID',
    statistics_date DATE NOT NULL COMMENT '统计日期',
    statistics_type TINYINT NOT NULL COMMENT '统计类型：1日统计 2月统计 3年统计 4班统计',

    -- 计划数据
    plan_raw_coal DECIMAL(10,2),                  -- 计划入洗原煤量(吨)
    plan_fine_coal DECIMAL(10,2),                 -- 计划末煤产量(吨)
    plan_granular_coal DECIMAL(10,2),             -- 计划粒煤产量(吨)
    plan_large_block_coal DECIMAL(10,2),          -- 计划大块煤产量(吨)
    plan_medium_block_coal DECIMAL(10,2),         -- 计划中块煤产量(吨)
    plan_small_block_coal DECIMAL(10,2),          -- 计划小块煤产量(吨)
    plan_middling_coal DECIMAL(10,2),             -- 计划中煤产量(吨)
    plan_gangue DECIMAL(10,2),                    -- 计划矸石产量(吨)

    -- 实际完成数据
    actual_raw_coal DECIMAL(10,2),                -- 实际入洗原煤量(吨)
    actual_fine_coal DECIMAL(10,2),               -- 实际末煤产量(吨)
    actual_granular_coal DECIMAL(10,2),           -- 实际粒煤产量(吨)
    actual_large_block_coal DECIMAL(10,2),        -- 实际大块煤产量(吨)
    actual_medium_block_coal DECIMAL(10,2),       -- 实际中块煤产量(吨)
    actual_small_block_coal DECIMAL(10,2),        -- 实际小块煤产量(吨)
    actual_middling_coal DECIMAL(10,2),           -- 实际中煤产量(吨)
    actual_gangue DECIMAL(10,2),                  -- 实际矸石产量(吨)

    -- 完成率数据（百分比）
    completion_rate_raw_coal DECIMAL(5,2),        -- 入洗原煤完成率(%)
    completion_rate_fine_coal DECIMAL(5,2),       -- 末煤完成率(%)
    completion_rate_granular_coal DECIMAL(5,2),   -- 粒煤完成率(%)
    completion_rate_large_block DECIMAL(5,2),     -- 大块煤完成率(%)
    completion_rate_medium_block DECIMAL(5,2),    -- 中块煤完成率(%)
    completion_rate_small_block DECIMAL(5,2),     -- 小块煤完成率(%)
    completion_rate_middling_coal DECIMAL(5,2),   -- 中煤完成率(%)
    completion_rate_gangue DECIMAL(5,2),          -- 矸石完成率(%)

    -- 总体完成率
    overall_completion_rate DECIMAL(5,2),         -- 总体完成率(%)

    -- 统计状态
    statistics_status TINYINT DEFAULT 1,          -- 统计状态：1正常 2异常 3需关注

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.4 调度管理表 (coal_dispatch_record)
> **说明：** 此表与现场生产日报表共用，调度管理功能已集成在生产日报记录中，通过 `assigned_tasks`（交办事项）和 `impact_time_record`（影响时间记录）等字段实现调度管理功能。

```sql
CREATE TABLE coal_dispatch_record (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    record_date DATE NOT NULL,                    -- 记录日期
    shift_id BIGINT NOT NULL,                     -- 班次ID
    dispatcher_id BIGINT NOT NULL,                -- 调度员ID

    -- 运转情况
    system_status NVARCHAR(500),                  -- 系统运转情况
    coal_type NVARCHAR(100),                      -- 入洗原煤类型

    -- 问题事故
    accident_description NTEXT,                   -- 事故描述
    accident_level TINYINT,                       -- 事故级别：1轻微 2一般 3严重 4重大
    accident_type TINYINT,                        -- 事故类型：1生产 2机电 3安全

    -- 指示内容
    instruction_content NTEXT,                    -- 上传下达指示内容
    instruction_from NVARCHAR(100),               -- 指示来源
    instruction_to NVARCHAR(100),                 -- 指示对象

    -- 交接班
    handover_issues NTEXT,                        -- 交接班遗留问题
    next_shift_notice NTEXT,                      -- 下班注意事项

    -- 停煤记录
    stop_reason NVARCHAR(200),                    -- 停煤原因
    stop_start_time DATETIME,                     -- 停煤开始时间
    stop_end_time DATETIME,                       -- 停煤结束时间

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.4 班次管理表 (coal_shift_config)
```sql
CREATE TABLE coal_shift_config (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    shift_name NVARCHAR(50) NOT NULL,             -- 班次名称
    shift_code NVARCHAR(20) NOT NULL,             -- 班次编码
    start_time TIME NOT NULL,                     -- 开始时间
    end_time TIME NOT NULL,                       -- 结束时间
    shift_type TINYINT NOT NULL,                  -- 班次类型：1生产班 2检修班 3值班
    is_production BIT DEFAULT 1,                  -- 是否生产班
    sort_order INT DEFAULT 0,                     -- 排序
    status TINYINT DEFAULT 1,                     -- 状态：0禁用 1启用
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 1.5 排班表 (coal_shift_schedule)
```sql
CREATE TABLE coal_shift_schedule (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    schedule_date DATE NOT NULL,                  -- 排班日期
    shift_id BIGINT NOT NULL,                     -- 班次ID
    user_id BIGINT NOT NULL,                      -- 员工ID
    position_type TINYINT NOT NULL,               -- 岗位类型：1调度员 2操作工 3检修工
    is_leader BIT DEFAULT 0,                      -- 是否班长
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 2. 设备档案管理模块

#### 2.1 设备基础信息表 (coal_equipment_info)
```sql
CREATE TABLE coal_equipment_info (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    equipment_code NVARCHAR(50) NOT NULL,         -- 设备编号
    equipment_name NVARCHAR(100) NOT NULL,        -- 设备名称
    equipment_type_id BIGINT NOT NULL,            -- 设备类型ID
    system_id BIGINT NOT NULL,                    -- 所属系统ID
    workshop_id BIGINT,                           -- 所属车间ID
    
    -- 设备基本信息
    model NVARCHAR(100),                          -- 设备型号
    manufacturer NVARCHAR(100),                   -- 制造厂商
    manufacture_date DATE,                        -- 制造日期
    install_date DATE,                            -- 安装日期
    commission_date DATE,                         -- 投产日期
    
    -- 技术参数
    rated_power DECIMAL(10,2),                    -- 额定功率(kW)
    rated_capacity DECIMAL(10,2),                 -- 额定处理能力(t/h)
    weight DECIMAL(10,2),                         -- 设备重量(t)
    dimensions NVARCHAR(100),                     -- 外形尺寸
    
    -- 设备状态
    equipment_status TINYINT DEFAULT 1,           -- 设备状态：1正常 2故障 3检修 4停用
    health_level TINYINT DEFAULT 1,               -- 健康等级：1优良 2良好 3注意 4异常
    
    -- 位置信息
    location NVARCHAR(200),                       -- 安装位置
    qr_code NVARCHAR(200),                        -- 二维码
    
    -- 责任人
    responsible_person_id BIGINT,                 -- 责任人ID
    maintenance_person_id BIGINT,                 -- 维护人ID
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 2.2 设备类型表 (coal_equipment_type)
```sql
CREATE TABLE coal_equipment_type (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    type_name NVARCHAR(100) NOT NULL,             -- 类型名称
    type_code NVARCHAR(50) NOT NULL,              -- 类型编码
    parent_id BIGINT DEFAULT 0,                   -- 父级ID
    level_path NVARCHAR(500),                     -- 层级路径
    sort_order INT DEFAULT 0,                     -- 排序
    description NVARCHAR(500),                    -- 描述
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 2.3 设备履历表 (coal_equipment_history)
```sql
CREATE TABLE coal_equipment_history (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    equipment_id BIGINT NOT NULL,                 -- 设备ID
    history_type TINYINT NOT NULL,                -- 履历类型：1购买 2安装 3维修 4保养 5改造 6报废
    history_date DATE NOT NULL,                   -- 履历日期
    
    -- 履历内容
    title NVARCHAR(200) NOT NULL,                 -- 履历标题
    description NTEXT,                            -- 详细描述
    cost DECIMAL(12,2),                           -- 费用
    supplier NVARCHAR(100),                       -- 供应商/承包商
    
    -- 维修相关
    fault_description NTEXT,                      -- 故障描述
    repair_method NTEXT,                          -- 维修方法
    replaced_parts NTEXT,                         -- 更换部件
    repair_person_id BIGINT,                      -- 维修人员ID
    
    -- 附件
    attachment_urls NTEXT,                        -- 附件URL列表(JSON)
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 3. 能源管理模块

#### 3.1 能源消耗记录表 (coal_energy_consumption)
```sql
CREATE TABLE coal_energy_consumption (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    record_date DATE NOT NULL,                    -- 记录日期
    shift_id BIGINT NOT NULL,                     -- 班次ID
    energy_type TINYINT NOT NULL,                 -- 能源类型：1电 2水 3介质 4药剂 5油料
    
    -- 消耗数据
    consumption_amount DECIMAL(12,2),             -- 消耗量
    unit NVARCHAR(20),                            -- 单位
    unit_price DECIMAL(8,4),                      -- 单价
    total_cost DECIMAL(12,2),                     -- 总费用
    
    -- 计量信息
    meter_reading_start DECIMAL(12,2),            -- 起始读数
    meter_reading_end DECIMAL(12,2),              -- 结束读数
    meter_id NVARCHAR(50),                        -- 计量表编号
    
    -- 录入信息
    recorder_id BIGINT,                           -- 记录人ID
    record_time DATETIME,                         -- 记录时间
    data_source TINYINT DEFAULT 1,                -- 数据来源：1人工录入 2自动采集
    
    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

---

## 📊 计划层级关联设计

### 计划层级关系说明
```
年度计划 (plan_level=1)
├── 月度计划 (plan_level=2, parent_plan_id=年度计划ID)
│   ├── 日计划 (plan_level=3, parent_plan_id=月度计划ID)
│   │   ├── 早班计划 (plan_level=4, parent_plan_id=日计划ID)
│   │   ├── 中班计划 (plan_level=4, parent_plan_id=日计划ID)
│   │   └── 夜班计划 (plan_level=4, parent_plan_id=日计划ID)
```

### 计划拆分逻辑
```java
/**
 * 计划拆分服务
 */
@Service
public class PlanSplitServiceImpl implements PlanSplitService {

    /**
     * 年度计划拆分为月度计划
     */
    @Override
    @Transactional
    public List<Long> splitYearlyToMonthly(Long yearlyPlanId) {
        // 1. 获取年度计划
        ProductionPlanDO yearlyPlan = productionPlanMapper.selectById(yearlyPlanId);
        validatePlanExists(yearlyPlan);

        List<Long> monthlyPlanIds = new ArrayList<>();

        // 2. 按月拆分
        for (int month = 1; month <= 12; month++) {
            ProductionPlanDO monthlyPlan = new ProductionPlanDO();

            // 基础信息
            monthlyPlan.setPlanCode(generatePlanCode(PlanTypeEnum.MONTHLY, yearlyPlan.getPlanYear(), month));
            monthlyPlan.setPlanType(PlanTypeEnum.MONTHLY.getType());
            monthlyPlan.setPlanLevel(2);
            monthlyPlan.setParentPlanId(yearlyPlanId);
            monthlyPlan.setPlanPath(yearlyPlanId + "/" + monthlyPlan.getId());
            monthlyPlan.setPlanYear(yearlyPlan.getPlanYear());
            monthlyPlan.setPlanMonth(month);

            // 产量分配（按月平均分配，可根据实际情况调整）
            BigDecimal monthlyRatio = BigDecimal.valueOf(1.0 / 12);
            monthlyPlan.setRawCoalPlan(yearlyPlan.getRawCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setFineCoalPlan(yearlyPlan.getFineCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setGranularCoalPlan(yearlyPlan.getGranularCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setLargeBlockCoalPlan(yearlyPlan.getLargeBlockCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setMediumBlockCoalPlan(yearlyPlan.getMediumBlockCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setSmallBlockCoalPlan(yearlyPlan.getSmallBlockCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setMiddlingCoalPlan(yearlyPlan.getMiddlingCoalPlan().multiply(monthlyRatio));
            monthlyPlan.setGanguePlan(yearlyPlan.getGanguePlan().multiply(monthlyRatio));

            // 质量指标继承
            monthlyPlan.setFineCoalAsh(yearlyPlan.getFineCoalAsh());
            monthlyPlan.setGranularCoalAsh(yearlyPlan.getGranularCoalAsh());
            monthlyPlan.setLargeBlockCoalAsh(yearlyPlan.getLargeBlockCoalAsh());
            monthlyPlan.setMediumBlockCoalAsh(yearlyPlan.getMediumBlockCoalAsh());
            monthlyPlan.setSmallBlockCoalAsh(yearlyPlan.getSmallBlockCoalAsh());
            monthlyPlan.setMiddlingCoalAsh(yearlyPlan.getMiddlingCoalAsh());

            monthlyPlan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());

            productionPlanMapper.insert(monthlyPlan);
            monthlyPlanIds.add(monthlyPlan.getId());
        }

        return monthlyPlanIds;
    }

    /**
     * 月度计划拆分为日计划
     */
    @Override
    @Transactional
    public List<Long> splitMonthlyToDaily(Long monthlyPlanId) {
        ProductionPlanDO monthlyPlan = productionPlanMapper.selectById(monthlyPlanId);
        validatePlanExists(monthlyPlan);

        List<Long> dailyPlanIds = new ArrayList<>();

        // 获取该月的天数
        LocalDate startDate = LocalDate.of(monthlyPlan.getPlanYear(), monthlyPlan.getPlanMonth(), 1);
        LocalDate endDate = startDate.with(TemporalAdjusters.lastDayOfMonth());
        int daysInMonth = endDate.getDayOfMonth();

        // 按日拆分
        for (int day = 1; day <= daysInMonth; day++) {
            LocalDate planDate = LocalDate.of(monthlyPlan.getPlanYear(), monthlyPlan.getPlanMonth(), day);

            ProductionPlanDO dailyPlan = new ProductionPlanDO();

            // 基础信息
            dailyPlan.setPlanCode(generatePlanCode(PlanTypeEnum.DAILY, planDate));
            dailyPlan.setPlanType(PlanTypeEnum.DAILY.getType());
            dailyPlan.setPlanLevel(3);
            dailyPlan.setParentPlanId(monthlyPlanId);
            dailyPlan.setPlanPath(monthlyPlan.getPlanPath() + "/" + dailyPlan.getId());
            dailyPlan.setPlanYear(monthlyPlan.getPlanYear());
            dailyPlan.setPlanMonth(monthlyPlan.getPlanMonth());
            dailyPlan.setPlanDate(planDate);

            // 产量分配（按日平均分配）
            BigDecimal dailyRatio = BigDecimal.valueOf(1.0 / daysInMonth);
            dailyPlan.setRawCoalPlan(monthlyPlan.getRawCoalPlan().multiply(dailyRatio));
            dailyPlan.setFineCoalPlan(monthlyPlan.getFineCoalPlan().multiply(dailyRatio));
            dailyPlan.setGranularCoalPlan(monthlyPlan.getGranularCoalPlan().multiply(dailyRatio));
            dailyPlan.setLargeBlockCoalPlan(monthlyPlan.getLargeBlockCoalPlan().multiply(dailyRatio));
            dailyPlan.setMediumBlockCoalPlan(monthlyPlan.getMediumBlockCoalPlan().multiply(dailyRatio));
            dailyPlan.setSmallBlockCoalPlan(monthlyPlan.getSmallBlockCoalPlan().multiply(dailyRatio));
            dailyPlan.setMiddlingCoalPlan(monthlyPlan.getMiddlingCoalPlan().multiply(dailyRatio));
            dailyPlan.setGanguePlan(monthlyPlan.getGanguePlan().multiply(dailyRatio));

            // 质量指标继承
            copyQualityIndicators(dailyPlan, monthlyPlan);

            dailyPlan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());

            productionPlanMapper.insert(dailyPlan);
            dailyPlanIds.add(dailyPlan.getId());
        }

        return dailyPlanIds;
    }

    /**
     * 日计划拆分为班计划
     */
    @Override
    @Transactional
    public List<Long> splitDailyToShift(Long dailyPlanId) {
        ProductionPlanDO dailyPlan = productionPlanMapper.selectById(dailyPlanId);
        validatePlanExists(dailyPlan);

        // 获取生产班次配置
        List<ShiftConfigDO> shiftConfigs = shiftConfigMapper.selectProductionShifts();

        List<Long> shiftPlanIds = new ArrayList<>();

        for (ShiftConfigDO shiftConfig : shiftConfigs) {
            ProductionPlanDO shiftPlan = new ProductionPlanDO();

            // 基础信息
            shiftPlan.setPlanCode(generatePlanCode(PlanTypeEnum.SHIFT, dailyPlan.getPlanDate(), shiftConfig.getId()));
            shiftPlan.setPlanType(PlanTypeEnum.SHIFT.getType());
            shiftPlan.setPlanLevel(4);
            shiftPlan.setParentPlanId(dailyPlanId);
            shiftPlan.setPlanPath(dailyPlan.getPlanPath() + "/" + shiftPlan.getId());
            shiftPlan.setPlanYear(dailyPlan.getPlanYear());
            shiftPlan.setPlanMonth(dailyPlan.getPlanMonth());
            shiftPlan.setPlanDate(dailyPlan.getPlanDate());
            shiftPlan.setShiftId(shiftConfig.getId());

            // 产量分配（按班次平均分配，通常是3班制）
            BigDecimal shiftRatio = BigDecimal.valueOf(1.0 / shiftConfigs.size());
            shiftPlan.setRawCoalPlan(dailyPlan.getRawCoalPlan().multiply(shiftRatio));
            shiftPlan.setFineCoalPlan(dailyPlan.getFineCoalPlan().multiply(shiftRatio));
            shiftPlan.setGranularCoalPlan(dailyPlan.getGranularCoalPlan().multiply(shiftRatio));
            shiftPlan.setLargeBlockCoalPlan(dailyPlan.getLargeBlockCoalPlan().multiply(shiftRatio));
            shiftPlan.setMediumBlockCoalPlan(dailyPlan.getMediumBlockCoalPlan().multiply(shiftRatio));
            shiftPlan.setSmallBlockCoalPlan(dailyPlan.getSmallBlockCoalPlan().multiply(shiftRatio));
            shiftPlan.setMiddlingCoalPlan(dailyPlan.getMiddlingCoalPlan().multiply(shiftRatio));
            shiftPlan.setGanguePlan(dailyPlan.getGanguePlan().multiply(shiftRatio));

            // 质量指标继承
            copyQualityIndicators(shiftPlan, dailyPlan);

            shiftPlan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());

            productionPlanMapper.insert(shiftPlan);
            shiftPlanIds.add(shiftPlan.getId());
        }

        return shiftPlanIds;
    }
}
```

---

## 🔧 后端开发功能详解

### 1. 生产调度管理模块 (yudao-module-coal-production)

#### 1.1 生产计划管理
**Controller 接口：**
- `POST /coal/production/plan/create` - 创建生产计划
- `PUT /coal/production/plan/update` - 更新生产计划
- `DELETE /coal/production/plan/delete` - 删除生产计划
- `GET /coal/production/plan/page` - 分页查询生产计划
- `GET /coal/production/plan/get/{id}` - 获取计划详情
- `POST /coal/production/plan/approve` - 审批生产计划
- `POST /coal/production/plan/split` - 拆分计划(年度→月度→日计划)

**Service 业务逻辑：**
```java
@Service
public class ProductionPlanServiceImpl extends ServiceExceptionUtil implements ProductionPlanService {
    
    /**
     * 创建生产计划
     */
    @Override
    @Transactional
    public Long createPlan(PlanCreateReqVO reqVO) {
        // 1. 校验计划时间不冲突
        validatePlanTimeConflict(reqVO);
        
        // 2. 校验计划数据合理性
        validatePlanData(reqVO);
        
        // 3. 创建计划
        ProductionPlanDO plan = BeanUtils.toBean(reqVO, ProductionPlanDO.class);
        plan.setPlanCode(generatePlanCode(reqVO.getPlanType()));
        plan.setPlanStatus(PlanStatusEnum.PENDING.getStatus());
        
        productionPlanMapper.insert(plan);
        return plan.getId();
    }
    
    /**
     * 拆分计划
     */
    @Override
    @Transactional
    public void splitPlan(Long planId, PlanSplitReqVO reqVO) {
        // 1. 获取父计划
        ProductionPlanDO parentPlan = validatePlanExists(planId);
        
        // 2. 根据拆分类型生成子计划
        List<ProductionPlanDO> childPlans = generateChildPlans(parentPlan, reqVO);
        
        // 3. 批量插入子计划
        productionPlanMapper.insertBatch(childPlans);
    }
}
```

#### 1.2 计划完成率统计分析
**Controller 接口：**
- `GET /coal/production/plan/completion-rate` - 获取计划完成率统计
- `GET /coal/production/plan/dashboard-data` - 获取大屏展示数据
- `POST /coal/production/plan/calculate-completion` - 手动触发完成率计算
- `GET /coal/production/plan/completion-trend` - 获取完成率趋势数据

**Service 业务逻辑：**
```java
@Service
public class PlanCompletionStatisticsServiceImpl implements PlanCompletionStatisticsService {

    /**
     * 计算计划完成率
     */
    @Override
    @Transactional
    public void calculatePlanCompletion(Long planId, LocalDate statisticsDate) {
        // 1. 获取计划数据
        ProductionPlanDO plan = productionPlanMapper.selectById(planId);
        if (plan == null) {
            throw exception(PLAN_NOT_EXISTS);
        }

        // 2. 获取实际产量数据
        ProductionActualVO actualData = getActualProductionData(plan, statisticsDate);

        // 3. 计算完成率
        PlanCompletionStatisticsDO statistics = new PlanCompletionStatisticsDO();
        statistics.setPlanId(planId);
        statistics.setStatisticsDate(statisticsDate);
        statistics.setStatisticsType(plan.getPlanType());

        // 设置计划数据
        setPlanData(statistics, plan);

        // 设置实际数据
        setActualData(statistics, actualData);

        // 计算完成率
        calculateCompletionRates(statistics);

        // 4. 保存统计数据
        planCompletionStatisticsMapper.insertOrUpdate(statistics);
    }

    /**
     * 计算各项完成率
     */
    private void calculateCompletionRates(PlanCompletionStatisticsDO statistics) {
        // 入洗原煤完成率
        if (statistics.getPlanRawCoal() != null && statistics.getPlanRawCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualRawCoal()
                .divide(statistics.getPlanRawCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateRawCoal(rate);
        }

        // 末煤完成率
        if (statistics.getPlanFineCoal() != null && statistics.getPlanFineCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualFineCoal()
                .divide(statistics.getPlanFineCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateFineCoal(rate);
        }

        // 粒煤完成率
        if (statistics.getPlanGranularCoal() != null && statistics.getPlanGranularCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualGranularCoal()
                .divide(statistics.getPlanGranularCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateGranularCoal(rate);
        }

        // 大块煤完成率
        if (statistics.getPlanLargeBlockCoal() != null && statistics.getPlanLargeBlockCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualLargeBlockCoal()
                .divide(statistics.getPlanLargeBlockCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateLargeBlock(rate);
        }

        // 中块煤完成率
        if (statistics.getPlanMediumBlockCoal() != null && statistics.getPlanMediumBlockCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualMediumBlockCoal()
                .divide(statistics.getPlanMediumBlockCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateMediumBlock(rate);
        }

        // 小块煤完成率
        if (statistics.getPlanSmallBlockCoal() != null && statistics.getPlanSmallBlockCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualSmallBlockCoal()
                .divide(statistics.getPlanSmallBlockCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateSmallBlock(rate);
        }

        // 中煤完成率
        if (statistics.getPlanMiddlingCoal() != null && statistics.getPlanMiddlingCoal().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualMiddlingCoal()
                .divide(statistics.getPlanMiddlingCoal(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateMiddlingCoal(rate);
        }

        // 矸石完成率
        if (statistics.getPlanGangue() != null && statistics.getPlanGangue().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal rate = statistics.getActualGangue()
                .divide(statistics.getPlanGangue(), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
            statistics.setCompletionRateGangue(rate);
        }

        // 计算总体完成率（以入洗原煤为主要指标）
        statistics.setOverallCompletionRate(statistics.getCompletionRateRawCoal());
    }

    /**
     * 获取大屏展示数据
     */
    @Override
    public DashboardDataVO getDashboardData(DashboardDataReqVO reqVO) {
        DashboardDataVO dashboardData = new DashboardDataVO();

        // 1. 当月计划完成率
        PlanCompletionStatisticsDO monthlyStats = planCompletionStatisticsMapper
            .selectByTypeAndDate(PlanTypeEnum.MONTHLY.getType(), reqVO.getStatisticsDate());
        if (monthlyStats != null) {
            dashboardData.setMonthlyCompletionRate(monthlyStats.getOverallCompletionRate());
            dashboardData.setMonthlyPlanAmount(monthlyStats.getPlanRawCoal());
            dashboardData.setMonthlyActualAmount(monthlyStats.getActualRawCoal());
        }

        // 2. 当日计划完成率
        PlanCompletionStatisticsDO dailyStats = planCompletionStatisticsMapper
            .selectByTypeAndDate(PlanTypeEnum.DAILY.getType(), reqVO.getStatisticsDate());
        if (dailyStats != null) {
            dashboardData.setDailyCompletionRate(dailyStats.getOverallCompletionRate());
            dashboardData.setDailyPlanAmount(dailyStats.getPlanRawCoal());
            dashboardData.setDailyActualAmount(dailyStats.getActualRawCoal());
        }

        // 3. 各产品完成率
        List<ProductCompletionRateVO> productRates = new ArrayList<>();
        if (monthlyStats != null) {
            productRates.add(new ProductCompletionRateVO("末煤", monthlyStats.getCompletionRateFineCoal()));
            productRates.add(new ProductCompletionRateVO("粒煤", monthlyStats.getCompletionRateGranularCoal()));
            productRates.add(new ProductCompletionRateVO("大块", monthlyStats.getCompletionRateLargeBlock()));
            productRates.add(new ProductCompletionRateVO("中块", monthlyStats.getCompletionRateMediumBlock()));
            productRates.add(new ProductCompletionRateVO("小块", monthlyStats.getCompletionRateSmallBlock()));
            productRates.add(new ProductCompletionRateVO("中煤", monthlyStats.getCompletionRateMiddlingCoal()));
            productRates.add(new ProductCompletionRateVO("矸石", monthlyStats.getCompletionRateGangue()));
        }
        dashboardData.setProductCompletionRates(productRates);

        // 4. 完成率趋势数据（最近7天）
        List<CompletionTrendVO> trendData = planCompletionStatisticsMapper
            .selectTrendData(reqVO.getStatisticsDate().minusDays(6), reqVO.getStatisticsDate());
        dashboardData.setCompletionTrend(trendData);

        return dashboardData;
    }

    /**
     * 获取实际产量数据
     */
    private ProductionActualVO getActualProductionData(ProductionPlanDO plan, LocalDate statisticsDate) {
        ProductionActualVO actualData = new ProductionActualVO();

        switch (plan.getPlanType()) {
            case 1: // 年度计划
                actualData = getYearlyActualData(plan.getPlanYear());
                break;
            case 2: // 月度计划
                actualData = getMonthlyActualData(plan.getPlanYear(), plan.getPlanMonth());
                break;
            case 3: // 日计划
                actualData = getDailyActualData(plan.getPlanDate());
                break;
            case 4: // 班计划
                actualData = getShiftActualData(plan.getPlanDate(), plan.getShiftId());
                break;
        }

        return actualData;
    }

    /**
     * 获取月度实际产量数据
     */
    private ProductionActualVO getMonthlyActualData(Integer year, Integer month) {
        // 从生产日报表中统计月度实际产量
        LocalDate startDate = LocalDate.of(year, month, 1);
        LocalDate endDate = startDate.with(TemporalAdjusters.lastDayOfMonth());

        return productionDailyReportMapper.sumActualDataByDateRange(startDate, endDate);
    }
}
```

#### 1.3 产量统计分析
**Service 业务逻辑：**
```java
@Service
public class ProductionStatisticsServiceImpl implements ProductionStatisticsService {
    
    /**
     * 生成产品平衡表
     */
    @Override
    public ProductBalanceVO generateProductBalance(ProductBalanceReqVO reqVO) {
        // 1. 查询时间段内的产量数据
        List<ProductionOutputDO> outputs = productionOutputMapper.selectByDateRange(
            reqVO.getStartDate(), reqVO.getEndDate());
        
        // 2. 计算平衡数据
        ProductBalanceVO balance = calculateProductBalance(outputs);
        
        // 3. 计算完成率
        calculateCompletionRate(balance, reqVO);
        
        return balance;
    }
    
    /**
     * 生成产率分析报告
     */
    @Override
    public YieldAnalysisVO analyzeYield(YieldAnalysisReqVO reqVO) {
        // 1. 查询产量数据
        List<ProductionOutputDO> outputs = getOutputsByCondition(reqVO);
        
        // 2. 计算各种产率
        YieldAnalysisVO analysis = new YieldAnalysisVO();
        analysis.setCleanCoalYield(calculateCleanCoalYield(outputs));
        analysis.setRecoveryRate(calculateRecoveryRate(outputs));
        analysis.setRejectRate(calculateRejectRate(outputs));
        
        // 3. 对比目标产率
        compareWithTarget(analysis, reqVO);
        
        return analysis;
    }
}
```

### 2. 设备管理模块 (yudao-module-coal-equipment)

#### 2.1 设备档案管理
**Controller 接口：**
- `POST /coal/equipment/create` - 创建设备档案
- `PUT /coal/equipment/update` - 更新设备信息
- `GET /coal/equipment/page` - 分页查询设备
- `GET /coal/equipment/get/{id}` - 获取设备详情
- `GET /coal/equipment/qrcode/{code}` - 通过二维码获取设备信息
- `POST /coal/equipment/upload-document` - 上传设备文档

#### 2.2 设备KPI统计
**Service 业务逻辑：**
```java
@Service
public class EquipmentKpiServiceImpl implements EquipmentKpiService {
    
    /**
     * 计算设备完好率
     */
    @Override
    public BigDecimal calculateIntactRate(KpiCalculateReqVO reqVO) {
        // 完好率 = 完好设备数 / 总设备数 * 100%
        long totalCount = equipmentMapper.countByCondition(reqVO);
        long intactCount = equipmentMapper.countByStatus(reqVO, EquipmentStatusEnum.NORMAL);
        
        return BigDecimal.valueOf(intactCount)
                .divide(BigDecimal.valueOf(totalCount), 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
    }
    
    /**
     * 计算设备利用率
     */
    @Override
    public BigDecimal calculateUtilizationRate(KpiCalculateReqVO reqVO) {
        // 利用率 = 实际运行时间 / 计划运行时间 * 100%
        BigDecimal actualRunTime = getActualRunTime(reqVO);
        BigDecimal plannedRunTime = getPlannedRunTime(reqVO);
        
        return actualRunTime.divide(plannedRunTime, 4, RoundingMode.HALF_UP)
                .multiply(BigDecimal.valueOf(100));
    }
}
```

### 3. 煤质管理模块 (yudao-module-coal-quality)

#### 3.1 煤质检测数据管理
**Controller 接口：**
- `POST /coal/quality/test-data/create` - 录入检测数据
- `GET /coal/quality/test-data/page` - 分页查询检测数据
- `GET /coal/quality/test-data/realtime` - 获取实时检测数据
- `POST /coal/quality/test-data/batch-import` - 批量导入检测数据

---

## 🎨 前端开发功能详解

### 1. 生产调度管理前端

#### 1.1 生产计划管理页面
**页面路径：** `src/views/coal/production/plan/index.vue`

**功能特性：**
- 计划列表展示（支持年度/月度/日计划切换）
- 计划创建表单（支持模板选择）
- 计划拆分功能（年度→月度→日计划）
- 计划审批流程
- 计划执行进度跟踪
- 计划对比分析图表

**关键组件：**
```vue
<template>
  <div class="production-plan">
    <!-- 计划类型切换 -->
    <el-tabs v-model="activeTab" @tab-click="handleTabClick">
      <el-tab-pane label="年度计划" name="yearly" />
      <el-tab-pane label="月度计划" name="monthly" />
      <el-tab-pane label="日计划" name="daily" />
    </el-tabs>
    
    <!-- 搜索条件 -->
    <el-form :model="queryParams" inline>
      <el-form-item label="计划年度">
        <el-date-picker v-model="queryParams.planYear" type="year" />
      </el-form-item>
      <el-form-item label="审批状态">
        <el-select v-model="queryParams.planStatus">
          <el-option label="待审批" value="1" />
          <el-option label="已审批" value="2" />
        </el-select>
      </el-form-item>
    </el-form>
    
    <!-- 计划列表 -->
    <el-table :data="planList" v-loading="loading">
      <el-table-column prop="planCode" label="计划编号" />
      <el-table-column prop="planYear" label="计划年度" />
      <el-table-column prop="rawCoalPlan" label="计划入洗量(吨)" />
      <el-table-column prop="cleanCoalPlan" label="计划精煤产量(吨)" />
      <el-table-column label="完成率">
        <template #default="{ row }">
          <el-progress :percentage="row.completionRate" />
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button @click="handleEdit(row)">编辑</el-button>
          <el-button @click="handleSplit(row)">拆分</el-button>
          <el-button @click="handleApprove(row)">审批</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

#### 1.2 生产看板页面（大屏展示）
**页面路径：** `src/views/coal/production/dashboard/index.vue`

**功能特性：**
- 实时生产数据展示
- 计划完成率百分比展示
- 产量完成情况图表
- 设备运行状态监控
- 质量指标趋势图
- 异常报警提醒

**关键组件（大屏展示）：**
```vue
<template>
  <div class="production-dashboard">
    <!-- 顶部标题 -->
    <div class="dashboard-header">
      <h1>选煤厂生产管控大屏</h1>
      <div class="current-time">{{ currentTime }}</div>
    </div>

    <!-- 主要指标卡片 -->
    <div class="main-indicators">
      <!-- 月度计划完成率 -->
      <div class="indicator-card monthly-completion">
        <div class="card-header">
          <h3>月度计划完成率</h3>
          <div class="date-info">{{ currentMonth }}</div>
        </div>
        <div class="completion-rate">
          <div class="rate-circle">
            <el-progress
              type="circle"
              :percentage="dashboardData.monthlyCompletionRate"
              :width="120"
              :stroke-width="8"
              :color="getCompletionRateColor(dashboardData.monthlyCompletionRate)"
            >
              <template #default="{ percentage }">
                <span class="percentage-text">{{ percentage }}%</span>
              </template>
            </el-progress>
          </div>
          <div class="rate-details">
            <div class="detail-item">
              <span class="label">计划产量：</span>
              <span class="value">{{ formatNumber(dashboardData.monthlyPlanAmount) }}万吨</span>
            </div>
            <div class="detail-item">
              <span class="label">实际产量：</span>
              <span class="value">{{ formatNumber(dashboardData.monthlyActualAmount) }}万吨</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 日计划完成率 -->
      <div class="indicator-card daily-completion">
        <div class="card-header">
          <h3>日计划完成率</h3>
          <div class="date-info">{{ currentDate }}</div>
        </div>
        <div class="completion-rate">
          <div class="rate-circle">
            <el-progress
              type="circle"
              :percentage="dashboardData.dailyCompletionRate"
              :width="120"
              :stroke-width="8"
              :color="getCompletionRateColor(dashboardData.dailyCompletionRate)"
            >
              <template #default="{ percentage }">
                <span class="percentage-text">{{ percentage }}%</span>
              </template>
            </el-progress>
          </div>
          <div class="rate-details">
            <div class="detail-item">
              <span class="label">计划产量：</span>
              <span class="value">{{ formatNumber(dashboardData.dailyPlanAmount) }}吨</span>
            </div>
            <div class="detail-item">
              <span class="label">实际产量：</span>
              <span class="value">{{ formatNumber(dashboardData.dailyActualAmount) }}吨</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 产品完成率对比 -->
    <div class="product-completion-section">
      <div class="section-header">
        <h3>各产品完成率对比</h3>
      </div>
      <div class="product-completion-chart">
        <div
          v-for="product in dashboardData.productCompletionRates"
          :key="product.productName"
          class="product-item"
        >
          <div class="product-name">{{ product.productName }}</div>
          <div class="product-progress">
            <el-progress
              :percentage="product.completionRate"
              :stroke-width="20"
              :color="getCompletionRateColor(product.completionRate)"
            />
          </div>
          <div class="product-rate">{{ product.completionRate }}%</div>
        </div>
      </div>
    </div>

    <!-- 完成率趋势图 -->
    <div class="trend-section">
      <div class="section-header">
        <h3>完成率趋势（最近7天）</h3>
      </div>
      <div class="trend-chart" ref="trendChartRef"></div>
    </div>

    <!-- 实时数据滚动 -->
    <div class="realtime-data-section">
      <div class="section-header">
        <h3>实时生产数据</h3>
      </div>
      <div class="data-scroll">
        <div class="scroll-content">
          <div class="data-item">
            <span class="data-label">当前班次：</span>
            <span class="data-value">{{ currentShift }}</span>
          </div>
          <div class="data-item">
            <span class="data-label">系统运行状态：</span>
            <span class="data-value status-normal">正常运行</span>
          </div>
          <div class="data-item">
            <span class="data-label">小时处理量：</span>
            <span class="data-value">{{ realtimeData.hourlyCapacity }}吨/小时</span>
          </div>
          <div class="data-item">
            <span class="data-label">设备完好率：</span>
            <span class="data-value">{{ realtimeData.equipmentIntactRate }}%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { ref, reactive, onMounted, onUnmounted } from 'vue'
import * as echarts from 'echarts'
import * as ProductionApi from '@/api/coal/production'

// 响应式数据
const currentTime = ref('')
const currentDate = ref('')
const currentMonth = ref('')
const currentShift = ref('')
const trendChartRef = ref()
let trendChart: echarts.ECharts | null = null
let timer: NodeJS.Timeout | null = null

const dashboardData = reactive({
  monthlyCompletionRate: 0,
  monthlyPlanAmount: 0,
  monthlyActualAmount: 0,
  dailyCompletionRate: 0,
  dailyPlanAmount: 0,
  dailyActualAmount: 0,
  productCompletionRates: [],
  completionTrend: []
})

const realtimeData = reactive({
  hourlyCapacity: 0,
  equipmentIntactRate: 0
})

// 获取大屏数据
const getDashboardData = async () => {
  try {
    const data = await ProductionApi.getDashboardData({
      statisticsDate: new Date().toISOString().split('T')[0]
    })

    Object.assign(dashboardData, data)

    // 更新趋势图
    updateTrendChart()
  } catch (error) {
    console.error('获取大屏数据失败:', error)
  }
}

// 完成率颜色判断
const getCompletionRateColor = (rate: number) => {
  if (rate >= 100) return '#67C23A' // 绿色
  if (rate >= 90) return '#E6A23C'  // 橙色
  if (rate >= 80) return '#F56C6C'  // 红色
  return '#909399' // 灰色
}

// 数字格式化
const formatNumber = (num: number) => {
  if (num >= 10000) {
    return (num / 10000).toFixed(1)
  }
  return num.toFixed(1)
}

// 更新趋势图
const updateTrendChart = () => {
  if (!trendChart) return

  const option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'cross'
      }
    },
    legend: {
      data: ['计划完成率'],
      textStyle: {
        color: '#fff'
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: dashboardData.completionTrend.map(item => item.date),
      axisLine: {
        lineStyle: {
          color: '#fff'
        }
      }
    },
    yAxis: {
      type: 'value',
      name: '完成率(%)',
      axisLine: {
        lineStyle: {
          color: '#fff'
        }
      }
    },
    series: [
      {
        name: '计划完成率',
        type: 'line',
        data: dashboardData.completionTrend.map(item => item.completionRate),
        smooth: true,
        lineStyle: {
          color: '#00D4FF'
        },
        itemStyle: {
          color: '#00D4FF'
        },
        areaStyle: {
          color: {
            type: 'linear',
            x: 0,
            y: 0,
            x2: 0,
            y2: 1,
            colorStops: [
              { offset: 0, color: 'rgba(0, 212, 255, 0.3)' },
              { offset: 1, color: 'rgba(0, 212, 255, 0)' }
            ]
          }
        }
      }
    ]
  }

  trendChart.setOption(option)
}

// 更新时间
const updateTime = () => {
  const now = new Date()
  currentTime.value = now.toLocaleString()
  currentDate.value = now.toLocaleDateString()
  currentMonth.value = `${now.getFullYear()}年${now.getMonth() + 1}月`
}

// 初始化趋势图
const initTrendChart = () => {
  trendChart = echarts.init(trendChartRef.value)
  updateTrendChart()
}

onMounted(() => {
  // 初始化时间
  updateTime()

  // 获取初始数据
  getDashboardData()

  // 初始化图表
  nextTick(() => {
    initTrendChart()
  })

  // 设置定时器，每30秒更新一次数据
  timer = setInterval(() => {
    updateTime()
    getDashboardData()
  }, 30000)
})

onUnmounted(() => {
  if (timer) {
    clearInterval(timer)
  }
  if (trendChart) {
    trendChart.dispose()
  }
})
</script>

<style lang="scss" scoped>
.production-dashboard {
  width: 100%;
  height: 100vh;
  background: linear-gradient(135deg, #0c1e35 0%, #1a365d 100%);
  color: #fff;
  padding: 20px;
  overflow: hidden;

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;

    h1 {
      font-size: 36px;
      font-weight: bold;
      color: #00D4FF;
      text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }

    .current-time {
      font-size: 18px;
      color: #E6A23C;
    }
  }

  .main-indicators {
    display: flex;
    gap: 30px;
    margin-bottom: 30px;

    .indicator-card {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;

        h3 {
          font-size: 20px;
          color: #00D4FF;
        }

        .date-info {
          font-size: 14px;
          color: #E6A23C;
        }
      }

      .completion-rate {
        display: flex;
        align-items: center;
        gap: 30px;

        .percentage-text {
          font-size: 24px;
          font-weight: bold;
        }

        .rate-details {
          .detail-item {
            margin-bottom: 10px;

            .label {
              color: #B0BEC5;
            }

            .value {
              color: #00D4FF;
              font-weight: bold;
              margin-left: 10px;
            }
          }
        }
      }
    }
  }

  .product-completion-section {
    margin-bottom: 30px;

    .section-header {
      margin-bottom: 20px;

      h3 {
        font-size: 24px;
        color: #00D4FF;
      }
    }

    .product-completion-chart {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;

      .product-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        text-align: center;

        .product-name {
          font-size: 16px;
          margin-bottom: 15px;
          color: #fff;
        }

        .product-progress {
          margin-bottom: 10px;
        }

        .product-rate {
          font-size: 18px;
          font-weight: bold;
          color: #00D4FF;
        }
      }
    }
  }

  .trend-section {
    margin-bottom: 30px;

    .trend-chart {
      height: 300px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
  }

  .realtime-data-section {
    .data-scroll {
      height: 60px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;

      .scroll-content {
        display: flex;
        animation: scroll 20s linear infinite;

        .data-item {
          flex-shrink: 0;
          padding: 0 30px;
          line-height: 60px;

          .data-label {
            color: #B0BEC5;
          }

          .data-value {
            color: #00D4FF;
            font-weight: bold;
            margin-left: 10px;

            &.status-normal {
              color: #67C23A;
            }
          }
        }
      }
    }
  }
}

@keyframes scroll {
  0% {
    transform: translateX(100%);
  }
  100% {
    transform: translateX(-100%);
  }
}
</style>
```

### 2. 设备管理前端

#### 2.1 设备档案页面
**页面路径：** `src/views/coal/equipment/archive/index.vue`

**功能特性：**
- 设备树形结构展示
- 设备详细信息查看
- 设备二维码生成
- 设备文档管理
- 设备履历记录

#### 2.2 设备KPI看板
**页面路径：** `src/views/coal/equipment/kpi/index.vue`

**功能特性：**
- KPI指标卡片展示
- 设备完好率趋势图
- 故障率统计图表
- 设备利用率分析
- 对比分析功能

---

## 📱 移动端开发

### 1. 设备巡检APP
**技术栈：** uni-app + Vue 3

**核心功能：**
- 扫码查看设备档案
- 设备巡检记录
- 故障报修提交
- 检修任务接收
- 离线数据同步

### 2. 生产数据录入APP
**核心功能：**
- 产量数据录入
- 煤质检测数据录入
- 能源消耗记录
- 调度记录填写

---

## 🔄 系统集成方案

### 1. PLC数据采集
**技术方案：** OPC UA + MQTT

**采集内容：**
- 设备运行状态
- 生产过程数据
- 报警信息
- 能源消耗数据

### 2. 第三方系统集成
- **ERP系统**：生产计划、物料管理
- **化验系统**：煤质检测数据
- **视频监控**：安全监控集成
- **门禁系统**：人员进出记录

---

## 📊 报表系统设计

### 1. 生产报表
- 日产量报表
- 月度生产总结
- 产品平衡表
- 产率分析报表

### 2. 设备报表
- 设备运行报表
- 故障统计报表
- 维修记录报表
- KPI分析报表

### 3. 质量报表
- 煤质检测报表
- 质量趋势分析
- 合格率统计
- 质量异常报告

---

## 🚀 开发计划

### 第一阶段（1-2个月）
1. 基础框架搭建
2. 数据库设计实现
3. 用户权限管理
4. 生产计划管理模块

### 第二阶段（2-3个月）
1. 产量统计模块
2. 设备档案管理
3. 基础报表功能
4. 移动端框架

### 第三阶段（3-4个月）
1. 煤质管理模块
2. 安全管理模块
3. 能源管理模块
4. 高级报表和分析

### 第四阶段（4-5个月）
1. PLC数据集成
2. 移动端完善
3. 系统优化
4. 部署上线

---

## 📋 开发规范

### 1. 代码规范
- 遵循阿里巴巴Java开发手册
- 使用ESLint进行前端代码检查
- 统一的注释规范
- Git提交规范

### 2. 数据库规范
- 统一的命名规范
- 完整的索引设计
- 数据字典维护
- 备份恢复策略

### 3. 接口规范
- RESTful API设计
- 统一的返回格式
- 完整的接口文档
- 版本管理策略

### 4. 安全管理模块数据表

#### 4.1 安全检查表 (coal_safety_inspection)
```sql
CREATE TABLE coal_safety_inspection (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    inspection_code NVARCHAR(50) NOT NULL,        -- 检查编号
    inspection_date DATE NOT NULL,                -- 检查日期
    inspection_type TINYINT NOT NULL,             -- 检查类型：1日检 2周检 3月检 4专项检查
    inspector_id BIGINT NOT NULL,                 -- 检查人ID

    -- 检查区域
    area_id BIGINT,                               -- 检查区域ID
    equipment_id BIGINT,                          -- 检查设备ID

    -- 检查内容
    inspection_items NTEXT,                       -- 检查项目(JSON格式)
    risk_level TINYINT,                           -- 风险等级：1低 2中 3高 4极高

    -- 发现问题
    problem_description NTEXT,                    -- 问题描述
    problem_photos NTEXT,                         -- 问题照片(JSON数组)
    problem_videos NTEXT,                         -- 问题视频(JSON数组)
    voice_record NVARCHAR(500),                   -- 语音记录URL

    -- 整改要求
    rectification_requirement NTEXT,             -- 整改要求
    rectification_deadline DATE,                 -- 整改期限
    rectification_person_id BIGINT,              -- 整改责任人ID

    -- 检查状态
    inspection_status TINYINT DEFAULT 1,          -- 检查状态：1待整改 2整改中 3已整改 4已验收

    -- 整改结果
    rectification_result NTEXT,                  -- 整改结果
    rectification_photos NTEXT,                  -- 整改照片
    rectification_date DATE,                     -- 整改完成日期
    verifier_id BIGINT,                          -- 验收人ID
    verify_date DATE,                            -- 验收日期

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 4.2 安全事故表 (coal_safety_accident)
```sql
CREATE TABLE coal_safety_accident (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    accident_code NVARCHAR(50) NOT NULL,          -- 事故编号
    accident_date DATETIME NOT NULL,              -- 事故发生时间
    accident_type TINYINT NOT NULL,               -- 事故类型：1人身伤害 2设备事故 3火灾 4其他
    accident_level TINYINT NOT NULL,              -- 事故等级：1轻微 2一般 3较大 4重大

    -- 事故地点
    accident_location NVARCHAR(200),              -- 事故地点
    equipment_id BIGINT,                          -- 相关设备ID

    -- 事故描述
    accident_description NTEXT NOT NULL,          -- 事故经过
    accident_cause NTEXT,                         -- 事故原因
    accident_photos NTEXT,                        -- 事故现场照片
    accident_videos NTEXT,                        -- 事故现场视频

    -- 人员伤亡
    injured_count INT DEFAULT 0,                  -- 受伤人数
    death_count INT DEFAULT 0,                    -- 死亡人数
    injured_persons NTEXT,                        -- 受伤人员信息(JSON)

    -- 经济损失
    direct_loss DECIMAL(12,2) DEFAULT 0,          -- 直接经济损失
    indirect_loss DECIMAL(12,2) DEFAULT 0,        -- 间接经济损失

    -- 应急处理
    emergency_measures NTEXT,                     -- 应急处理措施
    rescue_persons NTEXT,                         -- 救援人员

    -- 事故调查
    investigation_team NTEXT,                     -- 调查组成员
    investigation_report NTEXT,                   -- 调查报告
    responsibility_analysis NTEXT,                -- 责任分析

    -- 整改措施
    corrective_measures NTEXT,                    -- 纠正措施
    preventive_measures NTEXT,                    -- 预防措施

    -- 处理状态
    handle_status TINYINT DEFAULT 1,              -- 处理状态：1待处理 2处理中 3已处理 4已结案

    -- 报告人
    reporter_id BIGINT,                           -- 报告人ID
    report_time DATETIME,                         -- 报告时间

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 5. 煤质管理模块数据表

#### 5.1 煤质检测数据表 (coal_quality_test_data)
```sql
CREATE TABLE coal_quality_test_data (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    test_code NVARCHAR(50) NOT NULL,              -- 检测编号
    test_date DATE NOT NULL,                      -- 检测日期
    shift_id BIGINT,                              -- 班次ID
    test_type TINYINT NOT NULL,                   -- 检测类型：1快灰 2快水 3快浮 4班灰 5全分析

    -- 样品信息
    sample_source TINYINT NOT NULL,               -- 样品来源：1原煤 2精煤 3中煤 4煤泥 5矸石
    sample_location NVARCHAR(100),                -- 取样地点
    sample_person_id BIGINT,                      -- 取样人ID
    sample_time DATETIME,                         -- 取样时间

    -- 检测项目
    ash_content DECIMAL(5,2),                     -- 灰分(%)
    moisture_content DECIMAL(5,2),                -- 水分(%)
    volatile_matter DECIMAL(5,2),                 -- 挥发分(%)
    fixed_carbon DECIMAL(5,2),                    -- 固定碳(%)
    sulfur_content DECIMAL(5,2),                  -- 硫分(%)
    calorific_value DECIMAL(8,2),                 -- 发热量(cal/g)

    -- 浮选试验数据
    float_test_density DECIMAL(4,2),              -- 浮选密度
    float_test_yield DECIMAL(5,2),                -- 浮选产率(%)
    float_test_ash DECIMAL(5,2),                  -- 浮选灰分(%)

    -- 检测人员
    tester_id BIGINT,                             -- 检测人员ID
    test_time DATETIME,                           -- 检测时间
    test_equipment NVARCHAR(100),                 -- 检测设备

    -- 检测结果
    test_result TINYINT DEFAULT 1,                -- 检测结果：1合格 2不合格
    result_description NVARCHAR(500),             -- 结果说明

    -- 数据来源
    data_source TINYINT DEFAULT 1,                -- 数据来源：1人工录入 2设备采集 3化验室

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 5.2 产品销售质量表 (coal_product_sales_quality)
```sql
CREATE TABLE coal_product_sales_quality (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    sales_date DATE NOT NULL,                     -- 销售日期
    product_type TINYINT NOT NULL,                -- 产品类型：1精煤 2中煤 3煤泥
    customer_id BIGINT,                           -- 客户ID
    transport_type TINYINT,                       -- 运输方式：1汽运 2铁运 3水运

    -- 销售数量
    sales_quantity DECIMAL(10,2),                 -- 销售数量(吨)
    unit_price DECIMAL(8,2),                      -- 单价(元/吨)
    total_amount DECIMAL(12,2),                   -- 总金额

    -- 质量指标
    ash_content DECIMAL(5,2),                     -- 灰分(%)
    moisture_content DECIMAL(5,2),                -- 水分(%)
    sulfur_content DECIMAL(5,2),                  -- 硫分(%)
    calorific_value DECIMAL(8,2),                 -- 发热量(cal/g)

    -- 质量评价
    quality_grade NVARCHAR(20),                   -- 质量等级
    is_qualified BIT DEFAULT 1,                   -- 是否合格
    quality_feedback NTEXT,                       -- 客户质量反馈

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

### 6. 系统基础数据表

#### 6.1 生产系统表 (coal_production_system)
```sql
CREATE TABLE coal_production_system (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    system_name NVARCHAR(100) NOT NULL,           -- 系统名称
    system_code NVARCHAR(50) NOT NULL,            -- 系统编码
    system_type TINYINT NOT NULL,                 -- 系统类型：1主洗系统 2浮选系统 3压滤系统
    design_capacity DECIMAL(10,2),                -- 设计处理能力(t/h)

    -- 工艺参数
    process_flow NTEXT,                           -- 工艺流程描述
    key_equipment NTEXT,                          -- 关键设备列表(JSON)

    -- 系统状态
    system_status TINYINT DEFAULT 1,              -- 系统状态：1正常 2故障 3检修 4停用

    -- 负责人
    manager_id BIGINT,                            -- 系统负责人ID
    operator_ids NTEXT,                           -- 操作人员ID列表(JSON)

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

#### 6.2 车间部门表 (coal_workshop)
```sql
CREATE TABLE coal_workshop (
    id BIGINT PRIMARY KEY IDENTITY(1,1),
    workshop_name NVARCHAR(100) NOT NULL,         -- 车间名称
    workshop_code NVARCHAR(50) NOT NULL,          -- 车间编码
    workshop_type TINYINT NOT NULL,               -- 车间类型：1生产车间 2辅助车间 3管理部门
    parent_id BIGINT DEFAULT 0,                   -- 父级部门ID

    -- 车间信息
    description NVARCHAR(500),                    -- 车间描述
    location NVARCHAR(200),                       -- 车间位置
    area_size DECIMAL(10,2),                      -- 车间面积(m²)

    -- 负责人
    manager_id BIGINT,                            -- 车间主任ID
    deputy_manager_id BIGINT,                     -- 副主任ID

    -- 联系方式
    phone NVARCHAR(20),                           -- 联系电话
    email NVARCHAR(100),                          -- 邮箱

    -- 基础字段
    creator NVARCHAR(64) DEFAULT '',
    create_time DATETIME DEFAULT GETDATE(),
    updater NVARCHAR(64) DEFAULT '',
    update_time DATETIME DEFAULT GETDATE(),
    deleted BIT DEFAULT 0,
    tenant_id BIGINT DEFAULT 0
);
```

---

## 🔧 后端开发功能详解（续）

### 4. 安全管理模块 (yudao-module-coal-safety)

#### 4.1 安全检查管理
**Controller 接口：**
- `POST /coal/safety/inspection/create` - 创建安全检查记录
- `PUT /coal/safety/inspection/update` - 更新检查记录
- `GET /coal/safety/inspection/page` - 分页查询检查记录
- `POST /coal/safety/inspection/upload-media` - 上传检查照片/视频
- `POST /coal/safety/inspection/rectify` - 提交整改结果
- `POST /coal/safety/inspection/verify` - 验收整改结果

**Service 业务逻辑：**
```java
@Service
public class SafetyInspectionServiceImpl extends ServiceExceptionUtil implements SafetyInspectionService {

    /**
     * 创建安全检查记录
     */
    @Override
    @Transactional
    public Long createInspection(SafetyInspectionCreateReqVO reqVO) {
        // 1. 生成检查编号
        String inspectionCode = generateInspectionCode();

        // 2. 创建检查记录
        SafetyInspectionDO inspection = BeanUtils.toBean(reqVO, SafetyInspectionDO.class);
        inspection.setInspectionCode(inspectionCode);
        inspection.setInspectionStatus(InspectionStatusEnum.PENDING_RECTIFICATION.getStatus());

        safetyInspectionMapper.insert(inspection);

        // 3. 如果有问题，推送整改通知
        if (CollUtil.isNotEmpty(reqVO.getProblems())) {
            pushRectificationNotice(inspection);
        }

        return inspection.getId();
    }

    /**
     * 推送整改通知
     */
    private void pushRectificationNotice(SafetyInspectionDO inspection) {
        // 构建通知内容
        NotificationReqVO notification = new NotificationReqVO();
        notification.setTitle("安全检查整改通知");
        notification.setContent(String.format("检查编号：%s，请及时整改", inspection.getInspectionCode()));
        notification.setRecipientId(inspection.getRectificationPersonId());
        notification.setType(NotificationTypeEnum.SAFETY_RECTIFICATION.getType());

        // 发送通知
        notificationService.sendNotification(notification);
    }
}
```

#### 4.2 事故管理
**Service 业务逻辑：**
```java
@Service
public class SafetyAccidentServiceImpl extends ServiceExceptionUtil implements SafetyAccidentService {

    /**
     * 创建事故记录
     */
    @Override
    @Transactional
    public Long createAccident(SafetyAccidentCreateReqVO reqVO) {
        // 1. 生成事故编号
        String accidentCode = generateAccidentCode(reqVO.getAccidentLevel());

        // 2. 创建事故记录
        SafetyAccidentDO accident = BeanUtils.toBean(reqVO, SafetyAccidentDO.class);
        accident.setAccidentCode(accidentCode);
        accident.setHandleStatus(AccidentHandleStatusEnum.PENDING.getStatus());

        safetyAccidentMapper.insert(accident);

        // 3. 根据事故等级推送紧急通知
        pushEmergencyNotification(accident);

        // 4. 自动启动应急预案
        if (accident.getAccidentLevel() >= AccidentLevelEnum.MAJOR.getLevel()) {
            emergencyPlanService.activateEmergencyPlan(accident.getId());
        }

        return accident.getId();
    }

    /**
     * 事故统计分析
     */
    @Override
    public AccidentStatisticsVO getAccidentStatistics(AccidentStatisticsReqVO reqVO) {
        AccidentStatisticsVO statistics = new AccidentStatisticsVO();

        // 1. 按事故类型统计
        List<AccidentTypeStatisticsVO> typeStats = safetyAccidentMapper.statisticsByType(reqVO);
        statistics.setTypeStatistics(typeStats);

        // 2. 按事故等级统计
        List<AccidentLevelStatisticsVO> levelStats = safetyAccidentMapper.statisticsByLevel(reqVO);
        statistics.setLevelStatistics(levelStats);

        // 3. 事故趋势分析
        List<AccidentTrendVO> trendData = safetyAccidentMapper.getAccidentTrend(reqVO);
        statistics.setTrendData(trendData);

        // 4. 计算事故率
        BigDecimal accidentRate = calculateAccidentRate(reqVO);
        statistics.setAccidentRate(accidentRate);

        return statistics;
    }
}
```

### 5. 煤质管理模块 (yudao-module-coal-quality)

#### 5.1 煤质检测数据管理
**Controller 接口：**
- `POST /coal/quality/test-data/create` - 录入检测数据
- `PUT /coal/quality/test-data/update` - 更新检测数据
- `GET /coal/quality/test-data/page` - 分页查询检测数据
- `GET /coal/quality/test-data/realtime` - 获取实时检测数据
- `POST /coal/quality/test-data/batch-import` - 批量导入检测数据
- `GET /coal/quality/test-data/export` - 导出检测数据

**Service 业务逻辑：**
```java
@Service
public class QualityTestDataServiceImpl extends ServiceExceptionUtil implements QualityTestDataService {

    /**
     * 录入检测数据
     */
    @Override
    @Transactional
    public Long createTestData(QualityTestDataCreateReqVO reqVO) {
        // 1. 生成检测编号
        String testCode = generateTestCode(reqVO.getTestType());

        // 2. 数据校验
        validateTestData(reqVO);

        // 3. 创建检测记录
        QualityTestDataDO testData = BeanUtils.toBean(reqVO, QualityTestDataDO.class);
        testData.setTestCode(testCode);

        // 4. 自动判断检测结果
        determineTestResult(testData);

        qualityTestDataMapper.insert(testData);

        // 5. 如果检测不合格，发送预警
        if (testData.getTestResult().equals(TestResultEnum.UNQUALIFIED.getResult())) {
            sendQualityAlert(testData);
        }

        return testData.getId();
    }

    /**
     * 质量统计分析
     */
    @Override
    public QualityStatisticsVO getQualityStatistics(QualityStatisticsReqVO reqVO) {
        QualityStatisticsVO statistics = new QualityStatisticsVO();

        // 1. 灰分统计
        QualityTrendVO ashTrend = getQualityTrend(reqVO, "ash_content");
        statistics.setAshTrend(ashTrend);

        // 2. 水分统计
        QualityTrendVO moistureTrend = getQualityTrend(reqVO, "moisture_content");
        statistics.setMoistureTrend(moistureTrend);

        // 3. 合格率统计
        BigDecimal qualificationRate = calculateQualificationRate(reqVO);
        statistics.setQualificationRate(qualificationRate);

        // 4. 稳定性分析
        QualityStabilityVO stability = analyzeQualityStability(reqVO);
        statistics.setStability(stability);

        return statistics;
    }

    /**
     * 自动判断检测结果
     */
    private void determineTestResult(QualityTestDataDO testData) {
        // 根据产品标准判断是否合格
        ProductStandardDO standard = productStandardMapper.selectByProductType(testData.getSampleSource());

        boolean isQualified = true;

        // 检查灰分
        if (testData.getAshContent() != null && standard.getMaxAshContent() != null) {
            if (testData.getAshContent().compareTo(standard.getMaxAshContent()) > 0) {
                isQualified = false;
            }
        }

        // 检查水分
        if (testData.getMoistureContent() != null && standard.getMaxMoistureContent() != null) {
            if (testData.getMoistureContent().compareTo(standard.getMaxMoistureContent()) > 0) {
                isQualified = false;
            }
        }

        // 检查硫分
        if (testData.getSulfurContent() != null && standard.getMaxSulfurContent() != null) {
            if (testData.getSulfurContent().compareTo(standard.getMaxSulfurContent()) > 0) {
                isQualified = false;
            }
        }

        testData.setTestResult(isQualified ? TestResultEnum.QUALIFIED.getResult() : TestResultEnum.UNQUALIFIED.getResult());
    }
}
```

---

## 🎨 前端开发功能详解（续）

### 3. 安全管理前端

#### 3.1 安全检查页面
**页面路径：** `src/views/coal/safety/inspection/index.vue`

**功能特性：**
- 检查记录列表展示
- 检查表单录入（支持拍照、录音、录像）
- 整改任务分配
- 整改进度跟踪
- 验收结果确认

**关键组件：**
```vue
<template>
  <div class="safety-inspection">
    <!-- 检查记录表单 -->
    <el-form :model="inspectionForm" :rules="inspectionRules">
      <el-form-item label="检查类型" prop="inspectionType">
        <el-select v-model="inspectionForm.inspectionType">
          <el-option label="日常检查" :value="1" />
          <el-option label="专项检查" :value="2" />
          <el-option label="隐患排查" :value="3" />
        </el-select>
      </el-form-item>

      <el-form-item label="检查区域" prop="areaId">
        <el-cascader
          v-model="inspectionForm.areaId"
          :options="areaOptions"
          :props="{ checkStrictly: true }"
        />
      </el-form-item>

      <el-form-item label="问题描述" prop="problemDescription">
        <el-input
          v-model="inspectionForm.problemDescription"
          type="textarea"
          :rows="4"
        />
      </el-form-item>

      <!-- 多媒体上传 -->
      <el-form-item label="问题照片">
        <el-upload
          :action="uploadUrl"
          list-type="picture-card"
          :on-success="handlePhotoSuccess"
          :before-upload="beforePhotoUpload"
        >
          <el-icon><Plus /></el-icon>
        </el-upload>
      </el-form-item>

      <el-form-item label="语音记录">
        <voice-recorder @on-record="handleVoiceRecord" />
      </el-form-item>

      <el-form-item label="整改要求" prop="rectificationRequirement">
        <el-input
          v-model="inspectionForm.rectificationRequirement"
          type="textarea"
          :rows="3"
        />
      </el-form-item>

      <el-form-item label="整改期限" prop="rectificationDeadline">
        <el-date-picker
          v-model="inspectionForm.rectificationDeadline"
          type="date"
        />
      </el-form-item>

      <el-form-item label="整改责任人" prop="rectificationPersonId">
        <user-selector v-model="inspectionForm.rectificationPersonId" />
      </el-form-item>
    </el-form>

    <!-- 检查记录列表 -->
    <el-table :data="inspectionList" v-loading="loading">
      <el-table-column prop="inspectionCode" label="检查编号" />
      <el-table-column prop="inspectionDate" label="检查日期" />
      <el-table-column prop="inspectionTypeName" label="检查类型" />
      <el-table-column prop="riskLevelName" label="风险等级">
        <template #default="{ row }">
          <el-tag :type="getRiskLevelType(row.riskLevel)">
            {{ row.riskLevelName }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="inspectionStatusName" label="状态" />
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button @click="handleView(row)">查看</el-button>
          <el-button
            v-if="row.inspectionStatus === 1"
            @click="handleRectify(row)"
          >
            整改
          </el-button>
          <el-button
            v-if="row.inspectionStatus === 3"
            @click="handleVerify(row)"
          >
            验收
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script lang="ts" setup>
import { ref, reactive, onMounted } from 'vue'
import * as SafetyApi from '@/api/coal/safety'
import VoiceRecorder from '@/components/VoiceRecorder/index.vue'
import UserSelector from '@/components/UserSelector/index.vue'

// 响应式数据
const loading = ref(false)
const inspectionList = ref([])
const inspectionForm = reactive({
  inspectionType: null,
  areaId: null,
  problemDescription: '',
  rectificationRequirement: '',
  rectificationDeadline: null,
  rectificationPersonId: null
})

// 表单校验规则
const inspectionRules = {
  inspectionType: [{ required: true, message: '请选择检查类型', trigger: 'change' }],
  areaId: [{ required: true, message: '请选择检查区域', trigger: 'change' }],
  problemDescription: [{ required: true, message: '请输入问题描述', trigger: 'blur' }]
}

// 获取检查记录列表
const getInspectionList = async () => {
  loading.value = true
  try {
    const data = await SafetyApi.getInspectionPage(queryParams)
    inspectionList.value = data.list
  } finally {
    loading.value = false
  }
}

// 处理语音记录
const handleVoiceRecord = (voiceUrl: string) => {
  inspectionForm.voiceRecord = voiceUrl
}

// 风险等级样式
const getRiskLevelType = (level: number) => {
  const types = { 1: 'info', 2: 'warning', 3: 'danger', 4: 'danger' }
  return types[level] || 'info'
}

onMounted(() => {
  getInspectionList()
})
</script>
```

#### 3.2 安全看板页面
**页面路径：** `src/views/coal/safety/dashboard/index.vue`

**功能特性：**
- 安全指标卡片展示
- 事故统计图表
- 隐患整改进度
- 安全检查完成率
- 实时安全状态监控

### 4. 煤质管理前端

#### 4.1 煤质检测数据录入页面
**页面路径：** `src/views/coal/quality/test-data/index.vue`

**功能特性：**
- 检测数据录入表单
- 检测结果自动判断
- 历史检测数据查询
- 质量趋势图表展示
- 不合格数据预警

#### 4.2 质量统计分析页面
**页面路径：** `src/views/coal/quality/statistics/index.vue`

**功能特性：**
- 质量指标趋势图
- 合格率统计图表
- 质量稳定性分析
- 产品质量对比
- 质量异常预警

---

## 📱 移动端开发详解

### 1. 技术架构
**框架选择：** uni-app + Vue 3 + TypeScript
**UI组件：** uni-ui + 自定义组件
**状态管理：** Pinia
**网络请求：** uni.request 封装

### 2. 核心功能模块

#### 2.1 设备巡检模块
```vue
<!-- pages/equipment/inspection/index.vue -->
<template>
  <view class="inspection-page">
    <!-- 扫码入口 -->
    <view class="scan-section">
      <button @click="scanQRCode" class="scan-btn">
        <uni-icons type="scan" size="30"></uni-icons>
        <text>扫码巡检</text>
      </button>
    </view>

    <!-- 巡检表单 -->
    <uni-forms :model="inspectionForm" :rules="rules" ref="form">
      <uni-forms-item label="设备名称" name="equipmentName">
        <uni-easyinput v-model="inspectionForm.equipmentName" disabled />
      </uni-forms-item>

      <uni-forms-item label="巡检项目" name="inspectionItems">
        <view class="inspection-items">
          <view
            v-for="item in inspectionItems"
            :key="item.id"
            class="inspection-item"
          >
            <text>{{ item.name }}</text>
            <uni-data-checkbox
              v-model="item.result"
              :localdata="[{value: 1, text: '正常'}, {value: 0, text: '异常'}]"
            />
          </view>
        </view>
      </uni-forms-item>

      <uni-forms-item label="异常描述" name="abnormalDescription">
        <uni-easyinput
          v-model="inspectionForm.abnormalDescription"
          type="textarea"
          placeholder="请描述发现的异常情况"
        />
      </uni-forms-item>

      <uni-forms-item label="现场照片">
        <view class="photo-upload">
          <view
            v-for="(photo, index) in photos"
            :key="index"
            class="photo-item"
          >
            <image :src="photo" mode="aspectFill" />
            <view class="photo-delete" @click="deletePhoto(index)">
              <uni-icons type="clear" size="16" color="#fff" />
            </view>
          </view>
          <view class="photo-add" @click="chooseImage">
            <uni-icons type="camera" size="30" />
            <text>添加照片</text>
          </view>
        </view>
      </uni-forms-item>
    </uni-forms>

    <view class="submit-section">
      <button @click="submitInspection" class="submit-btn">提交巡检</button>
    </view>
  </view>
</template>

<script lang="ts" setup>
import { ref, reactive } from 'vue'
import * as EquipmentApi from '@/api/equipment'

// 响应式数据
const inspectionForm = reactive({
  equipmentId: '',
  equipmentName: '',
  abnormalDescription: ''
})

const inspectionItems = ref([])
const photos = ref([])

// 扫码功能
const scanQRCode = () => {
  uni.scanCode({
    success: async (res) => {
      try {
        // 解析二维码获取设备信息
        const equipmentInfo = await EquipmentApi.getEquipmentByQRCode(res.result)
        inspectionForm.equipmentId = equipmentInfo.id
        inspectionForm.equipmentName = equipmentInfo.name

        // 获取巡检项目
        const items = await EquipmentApi.getInspectionItems(equipmentInfo.id)
        inspectionItems.value = items
      } catch (error) {
        uni.showToast({
          title: '设备信息获取失败',
          icon: 'error'
        })
      }
    }
  })
}

// 选择图片
const chooseImage = () => {
  uni.chooseImage({
    count: 9 - photos.value.length,
    success: (res) => {
      photos.value.push(...res.tempFilePaths)
    }
  })
}

// 提交巡检
const submitInspection = async () => {
  try {
    // 上传照片
    const photoUrls = await uploadPhotos()

    // 提交巡检数据
    const inspectionData = {
      ...inspectionForm,
      inspectionItems: inspectionItems.value,
      photos: photoUrls
    }

    await EquipmentApi.submitInspection(inspectionData)

    uni.showToast({
      title: '提交成功',
      icon: 'success'
    })

    // 返回上一页
    uni.navigateBack()
  } catch (error) {
    uni.showToast({
      title: '提交失败',
      icon: 'error'
    })
  }
}
</script>
```

#### 2.2 故障报修模块
```vue
<!-- pages/equipment/repair/index.vue -->
<template>
  <view class="repair-page">
    <uni-forms :model="repairForm" :rules="rules" ref="form">
      <uni-forms-item label="故障设备" name="equipmentId">
        <uni-data-select
          v-model="repairForm.equipmentId"
          :localdata="equipmentOptions"
          placeholder="请选择故障设备"
        />
      </uni-forms-item>

      <uni-forms-item label="故障类型" name="faultType">
        <uni-data-checkbox
          v-model="repairForm.faultType"
          :localdata="faultTypeOptions"
        />
      </uni-forms-item>

      <uni-forms-item label="故障描述" name="faultDescription">
        <uni-easyinput
          v-model="repairForm.faultDescription"
          type="textarea"
          placeholder="请详细描述故障现象"
        />
      </uni-forms-item>

      <uni-forms-item label="紧急程度" name="urgencyLevel">
        <uni-data-checkbox
          v-model="repairForm.urgencyLevel"
          :localdata="urgencyOptions"
        />
      </uni-forms-item>

      <uni-forms-item label="现场照片">
        <view class="media-upload">
          <view class="photo-section">
            <view
              v-for="(photo, index) in photos"
              :key="index"
              class="media-item"
            >
              <image :src="photo" mode="aspectFill" />
              <view class="media-delete" @click="deletePhoto(index)">×</view>
            </view>
            <view class="media-add" @click="chooseImage">
              <uni-icons type="camera" size="30" />
              <text>拍照</text>
            </view>
          </view>
        </view>
      </uni-forms-item>

      <uni-forms-item label="现场录音">
        <view class="voice-section">
          <button
            @click="startRecord"
            :disabled="isRecording"
            class="record-btn"
          >
            {{ isRecording ? '录音中...' : '开始录音' }}
          </button>
          <button
            @click="stopRecord"
            :disabled="!isRecording"
            class="stop-btn"
          >
            停止录音
          </button>
          <view v-if="voiceUrl" class="voice-player">
            <button @click="playVoice">播放录音</button>
          </view>
        </view>
      </uni-forms-item>
    </uni-forms>

    <view class="submit-section">
      <button @click="submitRepair" class="submit-btn">提交报修</button>
    </view>
  </view>
</template>

<script lang="ts" setup>
import { ref, reactive, onMounted } from 'vue'
import * as RepairApi from '@/api/repair'

// 响应式数据
const repairForm = reactive({
  equipmentId: '',
  faultType: '',
  faultDescription: '',
  urgencyLevel: 1
})

const photos = ref([])
const voiceUrl = ref('')
const isRecording = ref(false)
const recorderManager = uni.getRecorderManager()

// 开始录音
const startRecord = () => {
  isRecording.value = true
  recorderManager.start({
    duration: 60000, // 最长60秒
    sampleRate: 16000,
    numberOfChannels: 1,
    encodeBitRate: 96000,
    format: 'mp3'
  })
}

// 停止录音
const stopRecord = () => {
  isRecording.value = false
  recorderManager.stop()
}

// 录音事件监听
recorderManager.onStop((res) => {
  voiceUrl.value = res.tempFilePath
})

// 提交报修
const submitRepair = async () => {
  try {
    // 上传照片和录音
    const photoUrls = await uploadPhotos()
    const voiceFileUrl = voiceUrl.value ? await uploadVoice() : ''

    // 提交报修数据
    const repairData = {
      ...repairForm,
      photos: photoUrls,
      voiceUrl: voiceFileUrl
    }

    await RepairApi.submitRepair(repairData)

    uni.showToast({
      title: '报修成功',
      icon: 'success'
    })

    uni.navigateBack()
  } catch (error) {
    uni.showToast({
      title: '报修失败',
      icon: 'error'
    })
  }
}
</script>
```

这个大纲涵盖了选煤厂生产管理系统的完整开发方案，包括详细的数据库设计、后端功能开发、前端页面实现和移动端开发。我们可以按照这个大纲逐步实施开发。
